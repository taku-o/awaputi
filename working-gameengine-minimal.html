<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>å‹•ä½œã™ã‚‹GameEngineæœ€å°ç‰ˆ - Issue #113</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        #gameContainer {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #gameCanvas {
            border: 2px solid #333;
            background: #e8f4f8;
        }
        
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
        }
        
        button:hover { background: #0056b3; }
        
        #log {
            margin-top: 20px;
            text-align: left;
            background: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-info { color: #0066cc; }
        .log-error { color: #cc0000; }
        .log-success { color: #006600; }
        .log-warning { color: #cc6600; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <h1>ğŸ® å‹•ä½œã™ã‚‹GameEngineæœ€å°ç‰ˆ</h1>
        <p>æ—¢å­˜ã®GameEngineã‚·ã‚¹ãƒ†ãƒ ã‚’å®‰å…¨ã«å‹•ã‹ã—ã¾ã™</p>
        
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div>
            <button onclick="createWorkingGameEngine()">ğŸš€ å‹•ä½œã™ã‚‹GameEngineä½œæˆ</button>
            <button onclick="testBubbleSpawn()">ğŸˆ ãƒãƒ–ãƒ«ç”Ÿæˆãƒ†ã‚¹ãƒˆ</button>
            <button onclick="startGame()">â–¶ï¸ ã‚²ãƒ¼ãƒ é–‹å§‹</button>
            <button onclick="stopGame()">â¹ï¸ ã‚²ãƒ¼ãƒ åœæ­¢</button>
        </div>
        
        <div id="log"></div>
    </div>

    <script type="module">
        let workingGameEngine = null;
        
        // ===== ãƒ­ã‚°æ©Ÿèƒ½ =====
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const div = document.createElement('div');
            div.className = `log-${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logElement.appendChild(div);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // æœ€å°é™ã®GameEngineãƒ©ãƒƒãƒ‘ãƒ¼
        class WorkingGameEngine {
            constructor(canvas) {
                this.canvas = canvas;
                this.context = canvas.getContext('2d');
                this.isRunning = false;
                this.bubbles = [];
                this.score = 0;
                this.frameCount = 0;
                
                // å®Ÿéš›ã®GameEngineã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
                this.realGameEngine = null;
                this.useRealEngine = false;
                
                log('WorkingGameEngine ä½œæˆå®Œäº†', 'success');
            }
            
            // å®Ÿéš›ã®GameEngineã‚’å®‰å…¨ã«çµ±åˆ
            async integrateRealGameEngine() {
                try {
                    log('å®Ÿéš›ã®GameEngineçµ±åˆã‚’è©¦è¡Œä¸­...', 'info');
                    
                    // ConfigurationManagerã‚’äº‹å‰åˆæœŸåŒ–
                    const { getConfigurationManager } = await import('./src/core/ConfigurationManager.js');
                    const configManager = getConfigurationManager();
                    
                    // ErrorHandlerã‚’äº‹å‰åˆæœŸåŒ–
                    const { getErrorHandler } = await import('./src/utils/ErrorHandler.js');
                    const errorHandler = getErrorHandler();
                    
                    // GameEngineã‚’ä½œæˆï¼ˆãŸã ã—ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒï¼‰
                    const { GameEngine } = await import('./src/core/GameEngine.js');
                    
                    // ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§è©³ç´°ã‚’ã‚­ãƒ£ãƒƒãƒ
                    const originalConsoleError = console.error;
                    const errors = [];
                    console.error = function(...args) {
                        errors.push(args.join(' '));
                        originalConsoleError.apply(console, args);
                    };
                    
                    try {
                        this.realGameEngine = new GameEngine(this.canvas);
                        log('âœ… å®Ÿéš›ã®GameEngineçµ±åˆæˆåŠŸ', 'success');
                        this.useRealEngine = true;
                        
                        // å®Ÿéš›ã®GameEngineã®ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç¢ºèª
                        this.checkRealEngineComponents();
                        
                        return true;
                    } catch (engineError) {
                        log(`âš ï¸ GameEngineçµ±åˆå¤±æ•—: ${engineError.message}`, 'warning');
                        log('æœ€å°ç‰ˆã§å‹•ä½œã‚’ç¶™ç¶šã—ã¾ã™', 'info');
                        
                        // ã‚­ãƒ£ãƒƒãƒã—ãŸã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
                        if (errors.length > 0) {
                            log('è©³ç´°ã‚¨ãƒ©ãƒ¼:', 'warning');
                            errors.forEach(error => log(`  - ${error}`, 'warning'));
                        }
                        
                        return false;
                    } finally {
                        console.error = originalConsoleError;
                    }
                    
                } catch (importError) {
                    log(`âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ${importError.message}`, 'error');
                    return false;
                }
            }
            
            checkRealEngineComponents() {
                const components = [
                    'bubbleManager', 'stageManager', 'sceneManager', 
                    'scoreManager', 'playerData', 'configManager'
                ];
                
                log('å®Ÿéš›ã®GameEngineã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç¢ºèª:', 'info');
                components.forEach(comp => {
                    const exists = this.realGameEngine[comp] ? 'âœ…' : 'âŒ';
                    log(`  ${comp}: ${exists}`, exists === 'âœ…' ? 'success' : 'warning');
                });
            }
            
            // ãƒãƒ–ãƒ«ç”Ÿæˆï¼ˆå®Ÿéš›ã®ã‚¨ãƒ³ã‚¸ãƒ³ã¾ãŸã¯æœ€å°ç‰ˆï¼‰
            spawnBubble() {
                if (this.useRealEngine && this.realGameEngine && this.realGameEngine.bubbleManager) {
                    try {
                        const bubble = this.realGameEngine.bubbleManager.spawnBubble('normal');
                        if (bubble) {
                            log('âœ… å®Ÿéš›ã®GameEngineã§ãƒãƒ–ãƒ«ç”ŸæˆæˆåŠŸ', 'success');
                            return bubble;
                        }
                    } catch (error) {
                        log(`âš ï¸ å®Ÿéš›ã®ã‚¨ãƒ³ã‚¸ãƒ³ã§ãƒãƒ–ãƒ«ç”Ÿæˆå¤±æ•—: ${error.message}`, 'warning');
                        log('æœ€å°ç‰ˆã§ãƒãƒ–ãƒ«ç”Ÿæˆã—ã¾ã™', 'info');
                        this.useRealEngine = false;
                    }
                }
                
                // æœ€å°ç‰ˆãƒãƒ–ãƒ«ç”Ÿæˆ
                const bubble = this.createMinimalBubble();
                this.bubbles.push(bubble);
                log(`æœ€å°ç‰ˆã§ãƒãƒ–ãƒ«ç”Ÿæˆ: ID${bubble.id}`, 'success');
                return bubble;
            }
            
            createMinimalBubble() {
                return {
                    id: Date.now(),
                    x: 100 + Math.random() * (this.canvas.width - 200),
                    y: 100 + Math.random() * (this.canvas.height - 200),
                    radius: 20 + Math.random() * 20,
                    color: `hsl(${Math.random() * 360}, 70%, 60%)`,
                    vx: (Math.random() - 0.5) * 3,
                    vy: (Math.random() - 0.5) * 3,
                    life: 1.0
                };
            }
            
            // ã‚²ãƒ¼ãƒ é–‹å§‹
            start() {
                if (this.useRealEngine && this.realGameEngine && typeof this.realGameEngine.start === 'function') {
                    try {
                        this.realGameEngine.start();
                        log('âœ… å®Ÿéš›ã®GameEngineã§ã‚²ãƒ¼ãƒ é–‹å§‹', 'success');
                        return;
                    } catch (error) {
                        log(`âš ï¸ å®Ÿéš›ã®ã‚¨ãƒ³ã‚¸ãƒ³ã§ã‚²ãƒ¼ãƒ é–‹å§‹å¤±æ•—: ${error.message}`, 'warning');
                        this.useRealEngine = false;
                    }
                }
                
                // æœ€å°ç‰ˆã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
                if (this.isRunning) return;
                this.isRunning = true;
                
                // åˆæœŸãƒãƒ–ãƒ«
                for (let i = 0; i < 3; i++) {
                    this.spawnBubble();
                }
                
                this.gameLoop();
                log('âœ… æœ€å°ç‰ˆã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—é–‹å§‹', 'success');
            }
            
            // ã‚²ãƒ¼ãƒ åœæ­¢
            stop() {
                if (this.useRealEngine && this.realGameEngine && typeof this.realGameEngine.stop === 'function') {
                    try {
                        this.realGameEngine.stop();
                        log('å®Ÿéš›ã®GameEngineã§ã‚²ãƒ¼ãƒ åœæ­¢', 'info');
                        return;
                    } catch (error) {
                        log(`å®Ÿéš›ã®ã‚¨ãƒ³ã‚¸ãƒ³ã§ã‚²ãƒ¼ãƒ åœæ­¢å¤±æ•—: ${error.message}`, 'warning');
                    }
                }
                
                this.isRunning = false;
                log('æœ€å°ç‰ˆã‚²ãƒ¼ãƒ åœæ­¢', 'info');
            }
            
            // æœ€å°ç‰ˆã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
            gameLoop() {
                if (!this.isRunning) return;
                
                // æ›´æ–°å‡¦ç†
                this.update();
                
                // æç”»å‡¦ç†
                this.render();
                
                this.frameCount++;
                
                // è‡ªå‹•ãƒãƒ–ãƒ«ç”Ÿæˆï¼ˆ3ç§’ã«1å›ç¨‹åº¦ï¼‰
                if (this.frameCount % 180 === 0) {
                    this.spawnBubble();
                }
                
                requestAnimationFrame(() => this.gameLoop());
            }
            
            update() {
                // ãƒãƒ–ãƒ«æ›´æ–°
                this.bubbles = this.bubbles.filter(bubble => {
                    bubble.x += bubble.vx;
                    bubble.y += bubble.vy;
                    
                    // ç”»é¢ç«¯ã§ã®åå°„
                    if (bubble.x - bubble.radius < 0 || bubble.x + bubble.radius > this.canvas.width) {
                        bubble.vx *= -0.8;
                        bubble.x = Math.max(bubble.radius, Math.min(this.canvas.width - bubble.radius, bubble.x));
                    }
                    if (bubble.y - bubble.radius < 0 || bubble.y + bubble.radius > this.canvas.height) {
                        bubble.vy *= -0.8;
                        bubble.y = Math.max(bubble.radius, Math.min(this.canvas.height - bubble.radius, bubble.y));
                    }
                    
                    bubble.life -= 0.003;
                    return bubble.life > 0;
                });
            }
            
            render() {
                const ctx = this.context;
                
                // èƒŒæ™¯ã‚¯ãƒªã‚¢
                ctx.fillStyle = '#e8f4f8';
                ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // ãƒãƒ–ãƒ«æç”»
                this.bubbles.forEach(bubble => {
                    ctx.save();
                    ctx.globalAlpha = bubble.life;
                    
                    // ãƒãƒ–ãƒ«æœ¬ä½“
                    ctx.fillStyle = bubble.color;
                    ctx.beginPath();
                    ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                    ctx.fillStyle = 'rgba(255,255,255,0.6)';
                    ctx.beginPath();
                    ctx.arc(bubble.x - bubble.radius/3, bubble.y - bubble.radius/3, bubble.radius/4, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.restore();
                });
                
                // UIæƒ…å ±
                ctx.fillStyle = '#333';
                ctx.font = '16px Arial';
                ctx.fillText(`ã‚¹ã‚³ã‚¢: ${this.score}`, 10, 30);
                ctx.fillText(`ãƒãƒ–ãƒ«æ•°: ${this.bubbles.length}`, 10, 55);
                ctx.fillText(`FPS: ${Math.round(60)}`, 10, 80);
                ctx.fillText(`ã‚¨ãƒ³ã‚¸ãƒ³: ${this.useRealEngine ? 'å®Ÿéš›ã®GameEngine' : 'æœ€å°ç‰ˆ'}`, 10, 105);
            }
            
            // ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
            handleClick(x, y) {
                let hit = false;
                
                for (let i = this.bubbles.length - 1; i >= 0; i--) {
                    const bubble = this.bubbles[i];
                    const dx = x - bubble.x;
                    const dy = y - bubble.y;
                    
                    if (dx * dx + dy * dy <= bubble.radius * bubble.radius) {
                        this.bubbles.splice(i, 1);
                        this.score += 10;
                        hit = true;
                        log(`ãƒãƒ–ãƒ«ç ´å£Š: ã‚¹ã‚³ã‚¢+10 (åˆè¨ˆ: ${this.score})`, 'success');
                        break;
                    }
                }
                
                if (!hit) {
                    log('ç©ºæŒ¯ã‚Š', 'info');
                }
            }
        }
        
        // ===== ãƒœã‚¿ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ =====
        window.createWorkingGameEngine = async function() {
            log('=== WorkingGameEngineä½œæˆé–‹å§‹ ===', 'info');
            
            const canvas = document.getElementById('gameCanvas');
            workingGameEngine = new WorkingGameEngine(canvas);
            
            // å®Ÿéš›ã®GameEngineçµ±åˆã‚’è©¦è¡Œ
            const success = await workingGameEngine.integrateRealGameEngine();
            
            if (success) {
                log('ğŸ‰ å®Ÿéš›ã®GameEngineçµ±åˆç‰ˆã§å‹•ä½œã—ã¾ã™', 'success');
            } else {
                log('ğŸ”§ æœ€å°ç‰ˆã§å‹•ä½œã—ã¾ã™ï¼ˆå®Ÿéš›ã®GameEngineã«ã¯å•é¡ŒãŒã‚ã‚Šã¾ã™ï¼‰', 'warning');
            }
            
            // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            canvas.addEventListener('click', (event) => {
                if (!workingGameEngine) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                
                workingGameEngine.handleClick(x, y);
            });
            
            log('âœ… WorkingGameEngineæº–å‚™å®Œäº†', 'success');
        };
        
        window.testBubbleSpawn = function() {
            if (!workingGameEngine) {
                log('âŒ ã¾ãšWorkingGameEngineã‚’ä½œæˆã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            const bubble = workingGameEngine.spawnBubble();
            log(`ãƒãƒ–ãƒ«ç”Ÿæˆãƒ†ã‚¹ãƒˆå®Œäº†: ${bubble ? 'SUCCESS' : 'FAILED'}`, bubble ? 'success' : 'error');
        };
        
        window.startGame = function() {
            if (!workingGameEngine) {
                log('âŒ ã¾ãšWorkingGameEngineã‚’ä½œæˆã—ã¦ãã ã•ã„', 'error');
                return;
            }
            
            workingGameEngine.start();
        };
        
        window.stopGame = function() {
            if (!workingGameEngine) {
                log('âŒ ã‚²ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }
            
            workingGameEngine.stop();
        };
        
        // ===== åˆæœŸåŒ– =====
        log('å‹•ä½œã™ã‚‹GameEngineæœ€å°ç‰ˆ æº–å‚™å®Œäº†', 'info');
        log('1. ã€Œå‹•ä½œã™ã‚‹GameEngineä½œæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯', 'info');
        log('2. ã€Œã‚²ãƒ¼ãƒ é–‹å§‹ã€ã§ã‚²ãƒ¼ãƒ ã‚’å§‹ã‚ã‚‹', 'info');
        log('3. ãƒãƒ–ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å‰²ã£ã¦ãã ã•ã„ï¼', 'info');
    </script>
</body>
</html>