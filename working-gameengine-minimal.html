<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>動作するGameEngine最小版 - Issue #113</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        #gameContainer {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #gameCanvas {
            border: 2px solid #333;
            background: #e8f4f8;
        }
        
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
        }
        
        button:hover { background: #0056b3; }
        
        #log {
            margin-top: 20px;
            text-align: left;
            background: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-info { color: #0066cc; }
        .log-error { color: #cc0000; }
        .log-success { color: #006600; }
        .log-warning { color: #cc6600; }
    </style>
</head>
<body>
    <div id="gameContainer">
        <h1>🎮 動作するGameEngine最小版</h1>
        <p>既存のGameEngineシステムを安全に動かします</p>
        
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div>
            <button onclick="createWorkingGameEngine()">🚀 動作するGameEngine作成</button>
            <button onclick="testBubbleSpawn()">🎈 バブル生成テスト</button>
            <button onclick="startGame()">▶️ ゲーム開始</button>
            <button onclick="stopGame()">⏹️ ゲーム停止</button>
        </div>
        
        <div id="log"></div>
    </div>

    <script type="module">
        let workingGameEngine = null;
        
        // ===== ログ機能 =====
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const div = document.createElement('div');
            div.className = `log-${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logElement.appendChild(div);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // 最小限のGameEngineラッパー
        class WorkingGameEngine {
            constructor(canvas) {
                this.canvas = canvas;
                this.context = canvas.getContext('2d');
                this.isRunning = false;
                this.bubbles = [];
                this.score = 0;
                this.frameCount = 0;
                
                // 実際のGameEngineコンポーネント
                this.realGameEngine = null;
                this.useRealEngine = false;
                
                log('WorkingGameEngine 作成完了', 'success');
            }
            
            // 実際のGameEngineを安全に統合
            async integrateRealGameEngine() {
                try {
                    log('実際のGameEngine統合を試行中...', 'info');
                    
                    // ConfigurationManagerを事前初期化
                    const { getConfigurationManager } = await import('./src/core/ConfigurationManager.js');
                    const configManager = getConfigurationManager();
                    
                    // ErrorHandlerを事前初期化
                    const { getErrorHandler } = await import('./src/utils/ErrorHandler.js');
                    const errorHandler = getErrorHandler();
                    
                    // GameEngineを作成（ただしエラーをキャッチ）
                    const { GameEngine } = await import('./src/core/GameEngine.js');
                    
                    // カスタムエラーハンドラーで詳細をキャッチ
                    const originalConsoleError = console.error;
                    const errors = [];
                    console.error = function(...args) {
                        errors.push(args.join(' '));
                        originalConsoleError.apply(console, args);
                    };
                    
                    try {
                        this.realGameEngine = new GameEngine(this.canvas);
                        log('✅ 実際のGameEngine統合成功', 'success');
                        this.useRealEngine = true;
                        
                        // 実際のGameEngineの主要コンポーネントを確認
                        this.checkRealEngineComponents();
                        
                        return true;
                    } catch (engineError) {
                        log(`⚠️ GameEngine統合失敗: ${engineError.message}`, 'warning');
                        log('最小版で動作を継続します', 'info');
                        
                        // キャッチしたエラーを表示
                        if (errors.length > 0) {
                            log('詳細エラー:', 'warning');
                            errors.forEach(error => log(`  - ${error}`, 'warning'));
                        }
                        
                        return false;
                    } finally {
                        console.error = originalConsoleError;
                    }
                    
                } catch (importError) {
                    log(`❌ インポートエラー: ${importError.message}`, 'error');
                    return false;
                }
            }
            
            checkRealEngineComponents() {
                const components = [
                    'bubbleManager', 'stageManager', 'sceneManager', 
                    'scoreManager', 'playerData', 'configManager'
                ];
                
                log('実際のGameEngineコンポーネント確認:', 'info');
                components.forEach(comp => {
                    const exists = this.realGameEngine[comp] ? '✅' : '❌';
                    log(`  ${comp}: ${exists}`, exists === '✅' ? 'success' : 'warning');
                });
            }
            
            // バブル生成（実際のエンジンまたは最小版）
            spawnBubble() {
                if (this.useRealEngine && this.realGameEngine && this.realGameEngine.bubbleManager) {
                    try {
                        const bubble = this.realGameEngine.bubbleManager.spawnBubble('normal');
                        if (bubble) {
                            log('✅ 実際のGameEngineでバブル生成成功', 'success');
                            return bubble;
                        }
                    } catch (error) {
                        log(`⚠️ 実際のエンジンでバブル生成失敗: ${error.message}`, 'warning');
                        log('最小版でバブル生成します', 'info');
                        this.useRealEngine = false;
                    }
                }
                
                // 最小版バブル生成
                const bubble = this.createMinimalBubble();
                this.bubbles.push(bubble);
                log(`最小版でバブル生成: ID${bubble.id}`, 'success');
                return bubble;
            }
            
            createMinimalBubble() {
                return {
                    id: Date.now(),
                    x: 100 + Math.random() * (this.canvas.width - 200),
                    y: 100 + Math.random() * (this.canvas.height - 200),
                    radius: 20 + Math.random() * 20,
                    color: `hsl(${Math.random() * 360}, 70%, 60%)`,
                    vx: (Math.random() - 0.5) * 3,
                    vy: (Math.random() - 0.5) * 3,
                    life: 1.0
                };
            }
            
            // ゲーム開始
            start() {
                if (this.useRealEngine && this.realGameEngine && typeof this.realGameEngine.start === 'function') {
                    try {
                        this.realGameEngine.start();
                        log('✅ 実際のGameEngineでゲーム開始', 'success');
                        return;
                    } catch (error) {
                        log(`⚠️ 実際のエンジンでゲーム開始失敗: ${error.message}`, 'warning');
                        this.useRealEngine = false;
                    }
                }
                
                // 最小版ゲームループ
                if (this.isRunning) return;
                this.isRunning = true;
                
                // 初期バブル
                for (let i = 0; i < 3; i++) {
                    this.spawnBubble();
                }
                
                this.gameLoop();
                log('✅ 最小版ゲームループ開始', 'success');
            }
            
            // ゲーム停止
            stop() {
                if (this.useRealEngine && this.realGameEngine && typeof this.realGameEngine.stop === 'function') {
                    try {
                        this.realGameEngine.stop();
                        log('実際のGameEngineでゲーム停止', 'info');
                        return;
                    } catch (error) {
                        log(`実際のエンジンでゲーム停止失敗: ${error.message}`, 'warning');
                    }
                }
                
                this.isRunning = false;
                log('最小版ゲーム停止', 'info');
            }
            
            // 最小版ゲームループ
            gameLoop() {
                if (!this.isRunning) return;
                
                // 更新処理
                this.update();
                
                // 描画処理
                this.render();
                
                this.frameCount++;
                
                // 自動バブル生成（3秒に1回程度）
                if (this.frameCount % 180 === 0) {
                    this.spawnBubble();
                }
                
                requestAnimationFrame(() => this.gameLoop());
            }
            
            update() {
                // バブル更新
                this.bubbles = this.bubbles.filter(bubble => {
                    bubble.x += bubble.vx;
                    bubble.y += bubble.vy;
                    
                    // 画面端での反射
                    if (bubble.x - bubble.radius < 0 || bubble.x + bubble.radius > this.canvas.width) {
                        bubble.vx *= -0.8;
                        bubble.x = Math.max(bubble.radius, Math.min(this.canvas.width - bubble.radius, bubble.x));
                    }
                    if (bubble.y - bubble.radius < 0 || bubble.y + bubble.radius > this.canvas.height) {
                        bubble.vy *= -0.8;
                        bubble.y = Math.max(bubble.radius, Math.min(this.canvas.height - bubble.radius, bubble.y));
                    }
                    
                    bubble.life -= 0.003;
                    return bubble.life > 0;
                });
            }
            
            render() {
                const ctx = this.context;
                
                // 背景クリア
                ctx.fillStyle = '#e8f4f8';
                ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // バブル描画
                this.bubbles.forEach(bubble => {
                    ctx.save();
                    ctx.globalAlpha = bubble.life;
                    
                    // バブル本体
                    ctx.fillStyle = bubble.color;
                    ctx.beginPath();
                    ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // ハイライト
                    ctx.fillStyle = 'rgba(255,255,255,0.6)';
                    ctx.beginPath();
                    ctx.arc(bubble.x - bubble.radius/3, bubble.y - bubble.radius/3, bubble.radius/4, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.restore();
                });
                
                // UI情報
                ctx.fillStyle = '#333';
                ctx.font = '16px Arial';
                ctx.fillText(`スコア: ${this.score}`, 10, 30);
                ctx.fillText(`バブル数: ${this.bubbles.length}`, 10, 55);
                ctx.fillText(`FPS: ${Math.round(60)}`, 10, 80);
                ctx.fillText(`エンジン: ${this.useRealEngine ? '実際のGameEngine' : '最小版'}`, 10, 105);
            }
            
            // クリック処理
            handleClick(x, y) {
                let hit = false;
                
                for (let i = this.bubbles.length - 1; i >= 0; i--) {
                    const bubble = this.bubbles[i];
                    const dx = x - bubble.x;
                    const dy = y - bubble.y;
                    
                    if (dx * dx + dy * dy <= bubble.radius * bubble.radius) {
                        this.bubbles.splice(i, 1);
                        this.score += 10;
                        hit = true;
                        log(`バブル破壊: スコア+10 (合計: ${this.score})`, 'success');
                        break;
                    }
                }
                
                if (!hit) {
                    log('空振り', 'info');
                }
            }
        }
        
        // ===== ボタンハンドラー =====
        window.createWorkingGameEngine = async function() {
            log('=== WorkingGameEngine作成開始 ===', 'info');
            
            const canvas = document.getElementById('gameCanvas');
            workingGameEngine = new WorkingGameEngine(canvas);
            
            // 実際のGameEngine統合を試行
            const success = await workingGameEngine.integrateRealGameEngine();
            
            if (success) {
                log('🎉 実際のGameEngine統合版で動作します', 'success');
            } else {
                log('🔧 最小版で動作します（実際のGameEngineには問題があります）', 'warning');
            }
            
            // クリックイベント設定
            canvas.addEventListener('click', (event) => {
                if (!workingGameEngine) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                
                workingGameEngine.handleClick(x, y);
            });
            
            log('✅ WorkingGameEngine準備完了', 'success');
        };
        
        window.testBubbleSpawn = function() {
            if (!workingGameEngine) {
                log('❌ まずWorkingGameEngineを作成してください', 'error');
                return;
            }
            
            const bubble = workingGameEngine.spawnBubble();
            log(`バブル生成テスト完了: ${bubble ? 'SUCCESS' : 'FAILED'}`, bubble ? 'success' : 'error');
        };
        
        window.startGame = function() {
            if (!workingGameEngine) {
                log('❌ まずWorkingGameEngineを作成してください', 'error');
                return;
            }
            
            workingGameEngine.start();
        };
        
        window.stopGame = function() {
            if (!workingGameEngine) {
                log('❌ ゲームが作成されていません', 'error');
                return;
            }
            
            workingGameEngine.stop();
        };
        
        // ===== 初期化 =====
        log('動作するGameEngine最小版 準備完了', 'info');
        log('1. 「動作するGameEngine作成」をクリック', 'info');
        log('2. 「ゲーム開始」でゲームを始める', 'info');
        log('3. バブルをクリックして割ってください！', 'info');
    </script>
</body>
</html>