<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚²ãƒ¼ãƒ å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆ - Issue #113</title>
    <style>
        body { 
            font-family: monospace; 
            margin: 20px; 
            background: #f0f0f0; 
        }
        .log { 
            background: white; 
            padding: 10px; 
            margin: 5px 0; 
            border-left: 4px solid #007acc; 
            border-radius: 4px;
            font-size: 14px;
        }
        .success { border-color: #28a745; color: #28a745; }
        .warning { border-color: #ffc107; color: #856404; }
        .error { border-color: #dc3545; color: #dc3545; }
        .info { border-color: #17a2b8; color: #0c5460; }
        .test-section {
            background: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-pass { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-fail { background-color: #dc3545; }
        .status-running { background-color: #17a2b8; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        iframe {
            width: 100%;
            height: 400px;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ® Issue #113 ã‚²ãƒ¼ãƒ å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆ</h1>
    <p><strong>ç›®æ¨™</strong>: ã‚²ãƒ¼ãƒ ãŒå®Ÿéš›ã«ãƒ—ãƒ¬ã‚¤å¯èƒ½ãªçŠ¶æ…‹ã¾ã§å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª</p>

    <div class="test-section">
        <h3>ğŸ“‹ ã‚²ãƒ¼ãƒ å‹•ä½œãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h3>
        <div id="checklist">
            <div id="game-load"><span class="status-indicator status-running"></span>ã‚²ãƒ¼ãƒ ç”»é¢èª­ã¿è¾¼ã¿</div>
            <div id="canvas-render"><span class="status-indicator status-running"></span>Canvasæç”»ç¢ºèª</div>
            <div id="bubble-spawn"><span class="status-indicator status-running"></span>ãƒãƒ–ãƒ«ç”Ÿæˆç¢ºèª</div>
            <div id="user-interaction"><span class="status-indicator status-running"></span>ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¿œç­”</div>
            <div id="game-mechanics"><span class="status-indicator status-running"></span>ã‚²ãƒ¼ãƒ ãƒ¡ã‚«ãƒ‹ã‚¯ã‚¹å‹•ä½œ</div>
            <div id="performance-stable"><span class="status-indicator status-running"></span>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å®‰å®šæ€§</div>
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ¯ ã‚²ãƒ¼ãƒ ç”»é¢ï¼ˆå‹•ä½œç¢ºèªç”¨ï¼‰</h3>
        <iframe id="gameFrame" src="./index.html" onload="startGameFunctionalityTest()"></iframe>
    </div>

    <div id="log-container"></div>

    <script>
        let testStartTime = Date.now();
        let gameFrame = null;
        let testInterval = null;
        let testResults = {
            gameLoad: false,
            canvasRender: false,
            bubbleSpawn: false,
            userInteraction: false,
            gameMechanics: false,
            performanceStable: false
        };

        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            document.getElementById('log-container').appendChild(div);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStatus(id, status, message = '') {
            const element = document.getElementById(id);
            if (element) {
                const indicator = element.querySelector('.status-indicator');
                const text = element.childNodes[1] ? element.childNodes[1].textContent : id;
                
                indicator.className = `status-indicator status-${status}`;
                element.innerHTML = `<span class="status-indicator status-${status}"></span>${text}${message ? ': ' + message : ''}`;
                
                testResults[id.replace('-', '')] = (status === 'pass');
            }
        }

        function startGameFunctionalityTest() {
            log('ğŸš€ ã‚²ãƒ¼ãƒ å‹•ä½œç¢ºèªãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
            gameFrame = document.getElementById('gameFrame');
            
            // å®šæœŸçš„ã«ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
            testInterval = setInterval(checkGameFunctionality, 2000);
            
            // 30ç§’å¾Œã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            setTimeout(() => {
                if (testInterval) {
                    clearInterval(testInterval);
                    generateFinalReport();
                }
            }, 30000);
        }

        function checkGameFunctionality() {
            try {
                const frameWindow = gameFrame.contentWindow;
                const frameDocument = gameFrame.contentDocument;
                
                if (!frameDocument || !frameWindow) {
                    log('âš ï¸ iframe ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ï¼ˆSame-Origin Policyï¼‰', 'warning');
                    return;
                }

                // 1. ã‚²ãƒ¼ãƒ ç”»é¢èª­ã¿è¾¼ã¿ç¢ºèª
                if (!testResults.gameload) {
                    const canvas = frameDocument.getElementById('gameCanvas');
                    if (canvas) {
                        log('âœ… ã‚²ãƒ¼ãƒ Canvasè¦ç´ æ¤œå‡º', 'success');
                        updateStatus('game-load', 'pass', 'Canvasè¦ç´ æ­£å¸¸');
                    }
                }

                // 2. Canvasæç”»ç¢ºèª
                if (!testResults.canvasrender && frameDocument.getElementById('gameCanvas')) {
                    const canvas = frameDocument.getElementById('gameCanvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Canvas ã«ãƒ‡ãƒ¼ã‚¿ãŒæç”»ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const hasDrawing = Array.from(imageData.data).some((pixel, index) => 
                        index % 4 !== 3 && pixel !== 0  // ã‚¢ãƒ«ãƒ•ã‚¡å€¤ä»¥å¤–ã§0ä»¥å¤–ã®å€¤ãŒã‚ã‚‹ã‹
                    );
                    
                    if (hasDrawing) {
                        log('âœ… Canvasæç”»ãƒ‡ãƒ¼ã‚¿æ¤œå‡º', 'success');
                        updateStatus('canvas-render', 'pass', 'æç”»ç¢ºèª');
                    } else if (Date.now() - testStartTime > 10000) {
                        log('âš ï¸ Canvasæç”»ãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆ10ç§’çµŒéï¼‰', 'warning');
                        updateStatus('canvas-render', 'warning', 'æç”»ãƒ‡ãƒ¼ã‚¿ãªã—');
                    }
                }

                // 3. ãƒãƒ–ãƒ«ç”Ÿæˆç¢ºèªï¼ˆGameEngineã‚¢ã‚¯ã‚»ã‚¹è©¦è¡Œï¼‰
                if (!testResults.bubblespawn && frameWindow.gameEngine) {
                    const gameEngine = frameWindow.gameEngine;
                    if (gameEngine.bubbleManager && gameEngine.bubbleManager.bubbles) {
                        const bubbleCount = gameEngine.bubbleManager.bubbles.length;
                        if (bubbleCount > 0) {
                            log(`âœ… ãƒãƒ–ãƒ«ç”Ÿæˆç¢ºèª: ${bubbleCount}å€‹`, 'success');
                            updateStatus('bubble-spawn', 'pass', `${bubbleCount}å€‹ç”Ÿæˆ`);
                        } else if (Date.now() - testStartTime > 8000) {
                            log('âš ï¸ ãƒãƒ–ãƒ«æœªç”Ÿæˆï¼ˆ8ç§’çµŒéï¼‰', 'warning');
                            updateStatus('bubble-spawn', 'warning', 'ãƒãƒ–ãƒ«æœªç”Ÿæˆ');
                        }
                    }
                }

                // 4. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œå¿œç­”ç¢ºèª
                if (!testResults.userinteraction && frameWindow.gameEngine) {
                    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                    const canvas = frameDocument.getElementById('gameCanvas');
                    if (canvas) {
                        const rect = canvas.getBoundingClientRect();
                        const centerX = rect.width / 2;
                        const centerY = rect.height / 2;
                        
                        const clickEvent = new MouseEvent('click', {
                            clientX: centerX,
                            clientY: centerY,
                            bubbles: true
                        });
                        
                        canvas.dispatchEvent(clickEvent);
                        
                        // ã‚¯ãƒªãƒƒã‚¯å¾Œã®çŠ¶æ…‹å¤‰åŒ–ã‚’ç¢ºèª
                        setTimeout(() => {
                            if (frameWindow.gameEngine && frameWindow.gameEngine.inputManager) {
                                log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚·ã‚¹ãƒ†ãƒ å¿œç­”', 'success');
                                updateStatus('user-interaction', 'pass', 'ã‚¯ãƒªãƒƒã‚¯å¿œç­”');
                            }
                        }, 1000);
                    }
                }

                // 5. ã‚²ãƒ¼ãƒ ãƒ¡ã‚«ãƒ‹ã‚¯ã‚¹å‹•ä½œç¢ºèª
                if (!testResults.gamemechanics && frameWindow.gameEngine) {
                    const gameEngine = frameWindow.gameEngine;
                    if (gameEngine.scoreManager && gameEngine.sceneManager) {
                        const currentScene = gameEngine.sceneManager.currentScene;
                        if (currentScene && currentScene.constructor.name === 'GameScene') {
                            log('âœ… ã‚²ãƒ¼ãƒ ã‚·ãƒ¼ãƒ³å‹•ä½œç¢ºèª', 'success');
                            updateStatus('game-mechanics', 'pass', 'GameSceneå‹•ä½œä¸­');
                        }
                    }
                }

                // 6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å®‰å®šæ€§ç¢ºèª
                if (!testResults.performancestable && frameWindow.gameEngine) {
                    const gameEngine = frameWindow.gameEngine;
                    if (gameEngine.performanceMonitor || gameEngine.performanceOptimizer) {
                        const perfMonitor = gameEngine.performanceMonitor || gameEngine.performanceOptimizer;
                        if (perfMonitor.stats && perfMonitor.stats.fps > 30) {
                            log(`âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å®‰å®š: ${Math.round(perfMonitor.stats.fps)}FPS`, 'success');
                            updateStatus('performance-stable', 'pass', `${Math.round(perfMonitor.stats.fps)}FPS`);
                        }
                    }
                }

                // å…¨ãƒ†ã‚¹ãƒˆå®Œäº†ãƒã‚§ãƒƒã‚¯
                const completedTests = Object.values(testResults).filter(Boolean).length;
                if (completedTests === Object.keys(testResults).length) {
                    clearInterval(testInterval);
                    generateFinalReport();
                }

            } catch (error) {
                log(`ğŸ” ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${error.message}`, 'warning');
            }
        }

        function generateFinalReport() {
            const completedTests = Object.values(testResults).filter(Boolean).length;
            const totalTests = Object.keys(testResults).length;
            const successRate = Math.round((completedTests / totalTests) * 100);
            
            log('', 'info');
            log('ğŸ“Š === æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆ ===', 'info');
            log(`âœ… å®Œäº†ãƒ†ã‚¹ãƒˆ: ${completedTests}/${totalTests} (${successRate}%)`, successRate >= 80 ? 'success' : 'warning');
            
            if (successRate >= 80) {
                log('ğŸ‰ Issue #113 ç›®æ¨™é”æˆ: ã‚²ãƒ¼ãƒ ã¯å‹•ä½œå¯èƒ½çŠ¶æ…‹ã§ã™ï¼', 'success');
                log('ğŸ® ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤å¯èƒ½ - ãƒãƒ–ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ—ãƒ¬ã‚¤ã—ã¦ãã ã•ã„', 'success');
            } else if (successRate >= 50) {
                log('âš ï¸ Issue #113 éƒ¨åˆ†é”æˆ: ã‚²ãƒ¼ãƒ ã¯åŸºæœ¬çš„ã«å‹•ä½œã—ã¾ã™ãŒæ”¹å–„ã®ä½™åœ°ãŒã‚ã‚Šã¾ã™', 'warning');
                log('ğŸ”§ è¿½åŠ ä¿®æ­£ãŒå¿…è¦ãªé …ç›®ãŒã‚ã‚Šã¾ã™', 'warning');
            } else {
                log('âŒ Issue #113 æœªé”æˆ: ã‚²ãƒ¼ãƒ å‹•ä½œã«é‡è¦ãªå•é¡ŒãŒã‚ã‚Šã¾ã™', 'error');
                log('ğŸ› ï¸ ã•ã‚‰ãªã‚‹ä¿®æ­£ãŒå¿…è¦ã§ã™', 'error');
            }
            
            log(`â±ï¸ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“: ${Math.round((Date.now() - testStartTime) / 1000)}ç§’`, 'info');
        }

        log('ğŸ¯ ã‚²ãƒ¼ãƒ æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†', 'info');
        log('ğŸ“± iframeã§ã‚²ãƒ¼ãƒ èª­ã¿è¾¼ã¿ä¸­...', 'info');
    </script>
</body>
</html>