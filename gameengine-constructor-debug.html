<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>GameEngine Constructor Debug - Issue #113</title>
    <style>
        body {
            margin: 20px;
            font-family: monospace;
            background: #f0f0f0;
        }
        
        #container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
        }
        
        #log {
            margin-top: 20px;
            background: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            max-height: 600px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-info { color: #0066cc; }
        .log-error { color: #cc0000; font-weight: bold; }
        .log-success { color: #006600; }
        .log-warning { color: #cc6600; }
    </style>
</head>
<body>
    <div id="container">
        <h1>ğŸ”§ GameEngine Constructor Debug</h1>
        <p>GameEngineã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼å†…ã®DEBUGãƒ­ã‚°ã«ç„¦ç‚¹ã‚’å½“ã¦ãŸèª¿æŸ»</p>
        
        <canvas id="gameCanvas" width="400" height="300" style="border: 2px solid #333; background: #e8f4f8;"></canvas>
        
        <div>
            <button onclick="debugGameEngineConstructor()">ğŸ” GameEngineã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼å®Ÿè¡Œ</button>
            <button onclick="clearLog()">ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        </div>
        
        <div id="log"></div>
    </div>

    <script type="module">
        // ===== ãƒ­ã‚°æ©Ÿèƒ½ =====
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const div = document.createElement('div');
            div.className = `log-${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logElement.appendChild(div);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        };
        
        window.debugGameEngineConstructor = async function() {
            log('=== GameEngineã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒãƒƒã‚°é–‹å§‹ ===', 'info');
            
            // ã‚ˆã‚Šè©³ç´°ãªãƒ­ã‚°ã‚­ãƒ£ãƒ—ãƒãƒ£
            const originalConsoleLog = console.log;
            const originalConsoleError = console.error;
            const originalConsoleWarn = console.warn;
            
            const capturedLogs = {
                log: [],
                error: [],
                warn: []
            };
            
            console.log = function(...args) {
                const message = args.join(' ');
                capturedLogs.log.push(message);
                originalConsoleLog.apply(console, args);
                
                // [DEBUG]ãƒ­ã‚°ã¯ç‰¹åˆ¥ã«è¡¨ç¤º
                if (message.includes('[DEBUG]')) {
                    log(`âœ… ã‚­ãƒ£ãƒ—ãƒãƒ£: ${message}`, 'success');
                }
            };
            
            console.error = function(...args) {
                const message = args.join(' ');
                capturedLogs.error.push(message);
                originalConsoleError.apply(console, args);
                log(`âŒ ã‚¨ãƒ©ãƒ¼: ${message}`, 'error');
            };
            
            console.warn = function(...args) {
                const message = args.join(' ');
                capturedLogs.warn.push(message);
                originalConsoleWarn.apply(console, args);
                log(`âš ï¸ è­¦å‘Š: ${message}`, 'warning');
            };
            
            try {
                log('GameEngineã‚¯ãƒ©ã‚¹ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...', 'info');
                const { GameEngine } = await import('./src/core/GameEngine.js');
                log('âœ… GameEngineã‚¯ãƒ©ã‚¹ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ', 'success');
                
                log('GameEngineã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼å‘¼ã³å‡ºã—é–‹å§‹...', 'info');
                const canvas = document.getElementById('gameCanvas');
                
                // ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼å®Ÿè¡Œ
                const gameEngine = new GameEngine(canvas);
                
                log('âœ… GameEngineã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼å®Œäº†', 'success');
                
                // ä¸»è¦ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®çŠ¶æ³ç¢ºèª
                const components = [
                    { name: 'canvas', obj: gameEngine.canvas },
                    { name: 'context', obj: gameEngine.context },
                    { name: 'initializer', obj: gameEngine.initializer },
                    { name: 'eventManager', obj: gameEngine.eventManager },
                    { name: 'renderer', obj: gameEngine.renderer },
                    { name: 'utilities', obj: gameEngine.utilities },
                    { name: 'playerData', obj: gameEngine.playerData },
                    { name: 'bubbleManager', obj: gameEngine.bubbleManager },
                    { name: 'stageManager', obj: gameEngine.stageManager },
                    { name: 'sceneManager', obj: gameEngine.sceneManager },
                    { name: 'scoreManager', obj: gameEngine.scoreManager }
                ];
                
                log('=== ä¸»è¦ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆçŠ¶æ³ ===', 'info');
                components.forEach(comp => {
                    if (comp.obj) {
                        log(`âœ… ${comp.name}: æ­£å¸¸`, 'success');
                    } else {
                        log(`âŒ ${comp.name}: NULL/UNDEFINED`, 'error');
                    }
                });
                
                // initializeScenes() ã®çŠ¶æ³ç¢ºèª
                log('=== initializeScenes()ã®å®Ÿè¡ŒçŠ¶æ³ç¢ºèª ===', 'info');
                if (gameEngine.initializer && typeof gameEngine.initializer.initializeScenes === 'function') {
                    log('initializeScenes()ã¯éåŒæœŸã§å®Ÿè¡Œä¸­ã§ã™ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§[DEBUG]ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'info');
                } else {
                    log('âŒ initializeScenes()ãƒ¡ã‚½ãƒƒãƒ‰ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
                }
                
            } catch (error) {
                log(`âŒ GameEngineã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`ã‚¨ãƒ©ãƒ¼ã‚¿ã‚¤ãƒ—: ${error.name}`, 'error');
                log(`ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯: ${error.stack}`, 'error');
            } finally {
                // ãƒ­ã‚°æ©Ÿèƒ½ã‚’å¾©å…ƒ
                console.log = originalConsoleLog;
                console.error = originalConsoleError;
                console.warn = originalConsoleWarn;
                
                // ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸãƒ­ã‚°ã®è¦ç´„
                setTimeout(() => {
                    log('=== ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸãƒ­ã‚°çµ±è¨ˆ ===', 'info');
                    log(`é€šå¸¸ãƒ­ã‚°: ${capturedLogs.log.length}ä»¶`, 'info');
                    log(`ã‚¨ãƒ©ãƒ¼: ${capturedLogs.error.length}ä»¶`, capturedLogs.error.length > 0 ? 'error' : 'success');
                    log(`è­¦å‘Š: ${capturedLogs.warn.length}ä»¶`, capturedLogs.warn.length > 0 ? 'warning' : 'success');
                    
                    // DEBUGãƒ­ã‚°ã®è©³ç´°è¡¨ç¤º
                    const debugLogs = capturedLogs.log.filter(msg => msg.includes('[DEBUG]'));
                    log(`[DEBUG]ãƒ­ã‚°: ${debugLogs.length}ä»¶`, debugLogs.length > 0 ? 'success' : 'warning');
                    
                    // æœ€åˆã®æ•°ä»¶ã®DEBUGãƒ­ã‚°ã‚’è¡¨ç¤º
                    if (debugLogs.length > 0) {
                        log('æœ€åˆã®5ä»¶ã®[DEBUG]ãƒ­ã‚°:', 'info');
                        debugLogs.slice(0, 5).forEach((debugLog, i) => {
                            log(`  ${i+1}. ${debugLog}`, 'info');
                        });
                        
                        if (debugLogs.length > 5) {
                            log(`  ... ä»–${debugLogs.length - 5}ä»¶`, 'info');
                        }
                    }
                    
                    // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°è¡¨ç¤º
                    if (capturedLogs.error.length > 0) {
                        log('ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸã‚¨ãƒ©ãƒ¼:', 'error');
                        capturedLogs.error.forEach((errorLog, i) => {
                            log(`  ${i+1}. ${errorLog}`, 'error');
                        });
                    }
                }, 2000);
            }
        };
        
        // ===== åˆæœŸåŒ– =====
        log('GameEngineã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ãƒ‡ãƒãƒƒã‚°æº–å‚™å®Œäº†', 'info');
        log('ã€ŒGameEngineã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼å®Ÿè¡Œã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ‡ãƒãƒƒã‚°é–‹å§‹', 'info');
        log('ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚‚[DEBUG]ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'warning');
    </script>
</body>
</html>