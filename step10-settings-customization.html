<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Step 10: è¨­å®šãƒ»ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        #gameContainer {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: 0 auto;
        }
        
        #gameCanvas {
            border: 2px solid #333;
            background: #e8f4f8;
            cursor: crosshair;
        }
        
        #gameInfo {
            margin-top: 10px;
            font-size: 16px;
            font-weight: bold;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .settings-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .settings-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            min-width: 200px;
        }
        
        .settings-group h3 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
        }
        
        .setting-item {
            margin: 8px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .setting-label {
            font-size: 12px;
            color: #6c757d;
            flex: 1;
            text-align: left;
        }
        
        .setting-control {
            flex: 0 0 auto;
        }
        
        input[type="range"] {
            width: 80px;
        }
        
        input[type="checkbox"] {
            transform: scale(1.2);
        }
        
        select {
            padding: 4px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 12px;
        }
        
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .theme-preview {
            width: 30px;
            height: 20px;
            border-radius: 4px;
            display: inline-block;
            margin-left: 5px;
            border: 1px solid #ccc;
        }
        
        #log {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            max-height: 150px;
            overflow-y: auto;
            text-align: left;
            font-family: monospace;
            font-size: 11px;
        }
        
        .hit { color: #28a745; font-weight: bold; }
        .miss { color: #dc3545; }
        .info { color: #007bff; }
        .success { color: #28a745; font-weight: bold; }
        .special { color: #ff6600; font-weight: bold; }
        .warning { color: #ff6600; font-weight: bold; }
        .settings { color: #6f42c1; font-weight: bold; }
        
        #playerProfile {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: left;
        }
        
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat-item {
            background: white;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 12px;
        }
        
        .controls-help {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 12px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <h1>âš™ï¸ Step 10: è¨­å®šãƒ»ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚·ã‚¹ãƒ†ãƒ </h1>
        <p>ã‚²ãƒ¼ãƒ è¨­å®šã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ã€ã‚ãªãŸå¥½ã¿ã®ã‚²ãƒ¼ãƒ ä½“é¨“ã‚’ä½œã‚ã†ï¼</p>
        
        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ« -->
        <div id="playerProfile">
            <h3>ğŸ® ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«</h3>
            <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å: <input type="text" id="playerName" value="åŒ¿åãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼" maxlength="20"></label>
            <div class="profile-stats" id="profileStats">
                <div class="stat-item">ç·ãƒ—ãƒ¬ã‚¤æ™‚é–“<br><strong>0åˆ†</strong></div>
                <div class="stat-item">ç·ã‚¹ã‚³ã‚¢<br><strong>0</strong></div>
                <div class="stat-item">æœ€é«˜ã‚¹ã‚³ã‚¢<br><strong>0</strong></div>
                <div class="stat-item">ã‚²ãƒ¼ãƒ æ•°<br><strong>0</strong></div>
            </div>
        </div>
        
        <!-- è¨­å®šãƒ‘ãƒãƒ« -->
        <div class="settings-panel">
            <!-- ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤è¨­å®š -->
            <div class="settings-group">
                <h3>ğŸ¯ ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤</h3>
                <div class="setting-item">
                    <span class="setting-label">é›£æ˜“åº¦</span>
                    <select id="difficulty" class="setting-control">
                        <option value="easy">ç°¡å˜</option>
                        <option value="normal" selected>æ™®é€š</option>
                        <option value="hard">é›£ã—ã„</option>
                        <option value="expert">å°‚é–€å®¶</option>
                    </select>
                </div>
                <div class="setting-item">
                    <span class="setting-label">ãƒãƒ–ãƒ«ç”Ÿæˆé€Ÿåº¦</span>
                    <input type="range" id="spawnRate" min="5" max="50" value="20" class="setting-control">
                    <span id="spawnRateValue">20</span>
                </div>
                <div class="setting-item">
                    <span class="setting-label">ãƒãƒ–ãƒ«æœ€å¤§æ•°</span>
                    <input type="range" id="maxBubbles" min="3" max="15" value="8" class="setting-control">
                    <span id="maxBubblesValue">8</span>
                </div>
                <div class="setting-item">
                    <span class="setting-label">ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—é »åº¦</span>
                    <input type="range" id="powerupFreq" min="1" max="10" value="5" class="setting-control">
                    <span id="powerupFreqValue">5</span>
                </div>
            </div>
            
            <!-- è¦–è¦šè¨­å®š -->
            <div class="settings-group">
                <h3>ğŸ¨ è¦–è¦šåŠ¹æœ</h3>
                <div class="setting-item">
                    <span class="setting-label">ãƒ†ãƒ¼ãƒ</span>
                    <select id="theme" class="setting-control">
                        <option value="default">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>
                        <option value="dark">ãƒ€ãƒ¼ã‚¯</option>
                        <option value="neon">ãƒã‚ªãƒ³</option>
                        <option value="ocean">ã‚ªãƒ¼ã‚·ãƒ£ãƒ³</option>
                        <option value="sunset">ã‚µãƒ³ã‚»ãƒƒãƒˆ</option>
                    </select>
                    <div class="theme-preview" id="themePreview"></div>
                </div>
                <div class="setting-item">
                    <span class="setting-label">ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå¼·åº¦</span>
                    <input type="range" id="effectIntensity" min="0" max="100" value="75" class="setting-control">
                    <span id="effectIntensityValue">75</span>
                </div>
                <div class="setting-item">
                    <span class="setting-label">ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«æ•°</span>
                    <input type="range" id="particleCount" min="5" max="30" value="15" class="setting-control">
                    <span id="particleCountValue">15</span>
                </div>
                <div class="setting-item">
                    <span class="setting-label">ç”»é¢éœ‡å‹•</span>
                    <input type="checkbox" id="screenShake" checked class="setting-control">
                </div>
            </div>
            
            <!-- ã‚µã‚¦ãƒ³ãƒ‰è¨­å®š -->
            <div class="settings-group">
                <h3>ğŸ”Š ã‚µã‚¦ãƒ³ãƒ‰</h3>
                <div class="setting-item">
                    <span class="setting-label">BGMæœ‰åŠ¹</span>
                    <input type="checkbox" id="bgmEnabled" checked class="setting-control">
                </div>
                <div class="setting-item">
                    <span class="setting-label">BGMéŸ³é‡</span>
                    <input type="range" id="bgmVolume" min="0" max="100" value="30" class="setting-control">
                    <span id="bgmVolumeValue">30</span>
                </div>
                <div class="setting-item">
                    <span class="setting-label">åŠ¹æœéŸ³æœ‰åŠ¹</span>
                    <input type="checkbox" id="sfxEnabled" checked class="setting-control">
                </div>
                <div class="setting-item">
                    <span class="setting-label">åŠ¹æœéŸ³éŸ³é‡</span>
                    <input type="range" id="sfxVolume" min="0" max="100" value="70" class="setting-control">
                    <span id="sfxVolumeValue">70</span>
                </div>
            </div>
            
            <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¨­å®š -->
            <div class="settings-group">
                <h3>ğŸ® ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h3>
                <div class="setting-item">
                    <span class="setting-label">ãƒã‚¦ã‚¹æ„Ÿåº¦</span>
                    <input type="range" id="mouseSensitivity" min="50" max="200" value="100" class="setting-control">
                    <span id="mouseSensitivityValue">100</span>
                </div>
                <div class="setting-item">
                    <span class="setting-label">é€£ç¶šã‚¯ãƒªãƒƒã‚¯è¨±å¯</span>
                    <input type="checkbox" id="rapidClick" class="setting-control">
                </div>
                <div class="setting-item">
                    <span class="setting-label">å³ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹</span>
                    <input type="checkbox" id="disableRightClick" checked class="setting-control">
                </div>
                <div class="setting-item">
                    <span class="setting-label">ã‚¿ãƒƒãƒã‚µãƒãƒ¼ãƒˆ</span>
                    <input type="checkbox" id="touchSupport" checked class="setting-control">
                </div>
            </div>
            
            <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­å®š -->
            <div class="settings-group">
                <h3>âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h3>
                <div class="setting-item">
                    <span class="setting-label">ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆ</span>
                    <select id="frameRate" class="setting-control">
                        <option value="30">30 FPS</option>
                        <option value="60" selected>60 FPS</option>
                        <option value="120">120 FPS</option>
                    </select>
                </div>
                <div class="setting-item">
                    <span class="setting-label">å“è³ªè‡ªå‹•èª¿æ•´</span>
                    <input type="checkbox" id="autoQuality" checked class="setting-control">
                </div>
                <div class="setting-item">
                    <span class="setting-label">çœé›»åŠ›ãƒ¢ãƒ¼ãƒ‰</span>
                    <input type="checkbox" id="powerSave" class="setting-control">
                </div>
                <div class="setting-item">
                    <span class="setting-label">çµ±è¨ˆè¡¨ç¤º</span>
                    <input type="checkbox" id="showStats" class="setting-control">
                </div>
            </div>
        </div>
        
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div id="gameInfo">
            <div>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: <span id="currentPlayer">åŒ¿åãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</span></div>
            <div>ã‚¹ã‚³ã‚¢: <span id="score">0</span></div>
            <div>HP: <span id="hp">100</span></div>
            <div>ãƒãƒ–ãƒ«æ•°: <span id="bubbleCount">0</span></div>
            <div>ãƒ¬ãƒ™ãƒ«: <span id="level">1</span></div>
            <div>å‘½ä¸­ç‡: <span id="hitRate">0%</span></div>
        </div>
        
        <div class="controls-help">
            <strong>ğŸ’¡ æ“ä½œãƒ’ãƒ³ãƒˆ:</strong>
            <span id="controlsText">ã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒ–ãƒ«ã‚’ç ´å£Š | ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ãƒãƒ¼ã‚º | Escã§è¨­å®šãƒªã‚»ãƒƒãƒˆ</span>
        </div>
        
        <div>
            <button onclick="startGame()" id="startBtn">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
            <button onclick="pauseGame()" id="pauseBtn" disabled>ä¸€æ™‚åœæ­¢</button>
            <button onclick="stopGame()" id="stopBtn" disabled>ã‚²ãƒ¼ãƒ åœæ­¢</button>
            <button onclick="saveSettings()">è¨­å®šä¿å­˜</button>
            <button onclick="loadSettings()">è¨­å®šèª­è¾¼</button>
            <button onclick="resetSettings()">è¨­å®šãƒªã‚»ãƒƒãƒˆ</button>
            <button onclick="exportProfile()">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å‡ºåŠ›</button>
        </div>
        
        <div id="log"></div>
    </div>

    <script>
        // ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const logElement = document.getElementById('log');
        
        let bubbles = [];
        let score = 0;
        let hp = 100;
        let level = 1;
        let totalClicks = 0;
        let totalHits = 0;
        let gameRunning = false;
        let gamePaused = false;
        let gameLoop = null;
        let gameStartTime = 0;
        let totalPlayTime = 0;
        
        // è¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        let gameSettings = {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
            playerName: 'åŒ¿åãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼',
            
            // ã‚²ãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤
            difficulty: 'normal',
            spawnRate: 20,
            maxBubbles: 8,
            powerupFreq: 5,
            
            // è¦–è¦š
            theme: 'default',
            effectIntensity: 75,
            particleCount: 15,
            screenShake: true,
            
            // ã‚µã‚¦ãƒ³ãƒ‰
            bgmEnabled: true,
            bgmVolume: 30,
            sfxEnabled: true,
            sfxVolume: 70,
            
            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
            mouseSensitivity: 100,
            rapidClick: false,
            disableRightClick: true,
            touchSupport: true,
            
            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
            frameRate: 60,
            autoQuality: true,
            powerSave: false,
            showStats: false
        };
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼çµ±è¨ˆ
        let playerStats = {
            totalPlayTime: 0,
            totalScore: 0,
            highScore: 0,
            gamesPlayed: 0,
            bubblesDestroyed: 0,
            averageAccuracy: 0
        };
        
        // ãƒ†ãƒ¼ãƒè¨­å®š
        const THEMES = {
            default: {
                bg: '#e8f4f8',
                bubbleColors: ['#4A90E2', '#7ED321', '#D0021B', '#F5A623', '#9013FE'],
                canvasBorder: '#333'
            },
            dark: {
                bg: '#2c3e50',
                bubbleColors: ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#8e44ad'],
                canvasBorder: '#ecf0f1'
            },
            neon: {
                bg: '#0a0a0a',
                bubbleColors: ['#00ffff', '#ff00ff', '#ffff00', '#00ff00', '#ff0080'],
                canvasBorder: '#ffffff'
            },
            ocean: {
                bg: '#006994',
                bubbleColors: ['#4dd0e1', '#81c784', '#64b5f6', '#a1c4fd', '#b39ddb'],
                canvasBorder: '#ffffff'
            },
            sunset: {
                bg: '#ff7043',
                bubbleColors: ['#ffab40', '#ff8a65', '#f48fb1', '#ce93d8', '#90caf9'],
                canvasBorder: '#ffffff'
            }
        };
        
        // ã‚µã‚¦ãƒ³ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ï¼ˆç°¡å˜ãªWeb Audio APIï¼‰
        let audioContext = null;
        let bgmInterval = null;
        
        // ===== ãƒ­ã‚°æ©Ÿèƒ½ =====
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${time}] ${message}`;
            logElement.appendChild(div);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type}] ${message}`);
        }
        
        // ===== è¨­å®šç®¡ç† =====
        function updateSettingsUI() {
            // å…¨ã¦ã®è¨­å®šé …ç›®ã‚’UIã«åæ˜ 
            document.getElementById('playerName').value = gameSettings.playerName;
            document.getElementById('difficulty').value = gameSettings.difficulty;
            document.getElementById('spawnRate').value = gameSettings.spawnRate;
            document.getElementById('maxBubbles').value = gameSettings.maxBubbles;
            document.getElementById('powerupFreq').value = gameSettings.powerupFreq;
            
            document.getElementById('theme').value = gameSettings.theme;
            document.getElementById('effectIntensity').value = gameSettings.effectIntensity;
            document.getElementById('particleCount').value = gameSettings.particleCount;
            document.getElementById('screenShake').checked = gameSettings.screenShake;
            
            document.getElementById('bgmEnabled').checked = gameSettings.bgmEnabled;
            document.getElementById('bgmVolume').value = gameSettings.bgmVolume;
            document.getElementById('sfxEnabled').checked = gameSettings.sfxEnabled;
            document.getElementById('sfxVolume').value = gameSettings.sfxVolume;
            
            document.getElementById('mouseSensitivity').value = gameSettings.mouseSensitivity;
            document.getElementById('rapidClick').checked = gameSettings.rapidClick;
            document.getElementById('disableRightClick').checked = gameSettings.disableRightClick;
            document.getElementById('touchSupport').checked = gameSettings.touchSupport;
            
            document.getElementById('frameRate').value = gameSettings.frameRate;
            document.getElementById('autoQuality').checked = gameSettings.autoQuality;
            document.getElementById('powerSave').checked = gameSettings.powerSave;
            document.getElementById('showStats').checked = gameSettings.showStats;
            
            updateValueDisplays();
            updateThemePreview();
            applySettings();
        }
        
        function updateValueDisplays() {
            document.getElementById('spawnRateValue').textContent = gameSettings.spawnRate;
            document.getElementById('maxBubblesValue').textContent = gameSettings.maxBubbles;
            document.getElementById('powerupFreqValue').textContent = gameSettings.powerupFreq;
            document.getElementById('effectIntensityValue').textContent = gameSettings.effectIntensity;
            document.getElementById('particleCountValue').textContent = gameSettings.particleCount;
            document.getElementById('bgmVolumeValue').textContent = gameSettings.bgmVolume;
            document.getElementById('sfxVolumeValue').textContent = gameSettings.sfxVolume;
            document.getElementById('mouseSensitivityValue').textContent = gameSettings.mouseSensitivity + '%';
        }
        
        function updateThemePreview() {
            const preview = document.getElementById('themePreview');
            const theme = THEMES[gameSettings.theme];
            preview.style.background = `linear-gradient(45deg, ${theme.bg}, ${theme.bubbleColors[0]})`;
        }
        
        function applySettings() {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åæ›´æ–°
            document.getElementById('currentPlayer').textContent = gameSettings.playerName;
            
            // ãƒ†ãƒ¼ãƒé©ç”¨
            applyTheme();
            
            // Canvaså³ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹åŒ–
            if (gameSettings.disableRightClick) {
                canvas.addEventListener('contextmenu', e => e.preventDefault());
            }
            
            // ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¬ãƒ¼ãƒˆè¨­å®š
            if (gameLoop) {
                clearInterval(gameLoop);
                startGameLoop();
            }
            
            // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ˜ãƒ«ãƒ—æ›´æ–°
            updateControlsHelp();
            
            log(`è¨­å®šé©ç”¨å®Œäº†: ${gameSettings.difficulty}é›£æ˜“åº¦, ${gameSettings.theme}ãƒ†ãƒ¼ãƒ`, 'settings');
        }
        
        function applyTheme() {
            const theme = THEMES[gameSettings.theme];
            canvas.style.borderColor = theme.canvasBorder;
            document.querySelector('#gameCanvas').style.background = theme.bg;
        }
        
        function updateControlsHelp() {
            let helpText = 'ã‚¯ãƒªãƒƒã‚¯ã§ãƒãƒ–ãƒ«ã‚’ç ´å£Š';
            
            if (gameSettings.rapidClick) {
                helpText += ' | é€£ç¶šã‚¯ãƒªãƒƒã‚¯å¯èƒ½';
            }
            if (gameSettings.touchSupport) {
                helpText += ' | ã‚¿ãƒƒãƒæ“ä½œå¯¾å¿œ';
            }
            helpText += ' | ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼ã§ãƒãƒ¼ã‚º | Escã§è¨­å®šãƒªã‚»ãƒƒãƒˆ';
            
            document.getElementById('controlsText').textContent = helpText;
        }
        
        function saveSettings() {
            try {
                localStorage.setItem('bubbleGameSettings', JSON.stringify(gameSettings));
                localStorage.setItem('bubbleGameStats', JSON.stringify(playerStats));
                log('è¨­å®šã¨ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
            } catch (error) {
                log('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message, 'warning');
            }
        }
        
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('bubbleGameSettings');
                const savedStats = localStorage.getItem('bubbleGameStats');
                
                if (savedSettings) {
                    gameSettings = { ...gameSettings, ...JSON.parse(savedSettings) };
                    updateSettingsUI();
                    log('è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
                }
                
                if (savedStats) {
                    playerStats = { ...playerStats, ...JSON.parse(savedStats) };
                    updateProfileDisplay();
                    log('ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'success');
                }
            } catch (error) {
                log('è¨­å®šèª­è¾¼ã‚¨ãƒ©ãƒ¼: ' + error.message, 'warning');
            }
        }
        
        function resetSettings() {
            if (confirm('å…¨ã¦ã®è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                gameSettings = {
                    playerName: 'åŒ¿åãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼',
                    difficulty: 'normal',
                    spawnRate: 20,
                    maxBubbles: 8,
                    powerupFreq: 5,
                    theme: 'default',
                    effectIntensity: 75,
                    particleCount: 15,
                    screenShake: true,
                    bgmEnabled: true,
                    bgmVolume: 30,
                    sfxEnabled: true,
                    sfxVolume: 70,
                    mouseSensitivity: 100,
                    rapidClick: false,
                    disableRightClick: true,
                    touchSupport: true,
                    frameRate: 60,
                    autoQuality: true,
                    powerSave: false,
                    showStats: false
                };
                updateSettingsUI();
                log('è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'success');
            }
        }
        
        function exportProfile() {
            const exportData = {
                settings: gameSettings,
                stats: playerStats,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `bubble-game-profile-${gameSettings.playerName}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            log(`ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${gameSettings.playerName}ã€ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`, 'success');
        }
        
        function updateProfileDisplay() {
            const stats = document.querySelectorAll('#profileStats .stat-item');
            stats[0].innerHTML = `ç·ãƒ—ãƒ¬ã‚¤æ™‚é–“<br><strong>${Math.floor(playerStats.totalPlayTime / 60)}åˆ†</strong>`;
            stats[1].innerHTML = `ç·ã‚¹ã‚³ã‚¢<br><strong>${playerStats.totalScore.toLocaleString()}</strong>`;
            stats[2].innerHTML = `æœ€é«˜ã‚¹ã‚³ã‚¢<br><strong>${playerStats.highScore.toLocaleString()}</strong>`;
            stats[3].innerHTML = `ã‚²ãƒ¼ãƒ æ•°<br><strong>${playerStats.gamesPlayed}</strong>`;
        }
        
        // ===== è¨­å®šå¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ =====
        function setupSettingsListeners() {
            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å
            document.getElementById('playerName').addEventListener('input', (e) => {
                gameSettings.playerName = e.target.value || 'åŒ¿åãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼';
                document.getElementById('currentPlayer').textContent = gameSettings.playerName;
            });
            
            // å„ç¨®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹
            const settingElements = [
                'difficulty', 'spawnRate', 'maxBubbles', 'powerupFreq',
                'theme', 'effectIntensity', 'particleCount', 'screenShake',
                'bgmEnabled', 'bgmVolume', 'sfxEnabled', 'sfxVolume',
                'mouseSensitivity', 'rapidClick', 'disableRightClick', 'touchSupport',
                'frameRate', 'autoQuality', 'powerSave', 'showStats'
            ];
            
            settingElements.forEach(id => {
                const element = document.getElementById(id);
                const eventType = element.type === 'checkbox' ? 'change' : 'input';
                
                element.addEventListener(eventType, (e) => {
                    const value = e.target.type === 'checkbox' ? e.target.checked : 
                                  e.target.type === 'range' ? parseInt(e.target.value) : e.target.value;
                    gameSettings[id] = value;
                    
                    updateValueDisplays();
                    if (id === 'theme') updateThemePreview();
                    applySettings();
                });
            });
        }
        
        // ===== ã‚µã‚¦ãƒ³ãƒ‰ã‚·ã‚¹ãƒ†ãƒ  =====
        function initializeAudio() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    log('ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†', 'success');
                } catch (error) {
                    log('ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªåˆæœŸåŒ–å¤±æ•—: ' + error.message, 'warning');
                }
            }
        }
        
        function playSound(frequency, duration, type = 'pop') {
            if (!gameSettings.sfxEnabled || !audioContext) return;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = type === 'pop' ? 'sine' : 'square';
                
                const volume = gameSettings.sfxVolume / 100 * 0.1;
                gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (error) {
                console.warn('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        function startBGM() {
            if (!gameSettings.bgmEnabled || bgmInterval || !audioContext) return;
            
            const notes = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88];
            let noteIndex = 0;
            
            bgmInterval = setInterval(() => {
                if (gameSettings.bgmEnabled && !gamePaused) {
                    const frequency = notes[noteIndex % notes.length];
                    const volume = gameSettings.bgmVolume / 100 * 0.05;
                    
                    try {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                        oscillator.type = 'sine';
                        
                        gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.5);
                        
                        noteIndex++;
                    } catch (error) {
                        console.warn('BGMå†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
                    }
                }
            }, 800);
        }
        
        function stopBGM() {
            if (bgmInterval) {
                clearInterval(bgmInterval);
                bgmInterval = null;
            }
        }
        
        // ===== ãƒãƒ–ãƒ«ã‚¯ãƒ©ã‚¹ï¼ˆè¨­å®šå¯¾å¿œç‰ˆï¼‰ =====
        class CustomizableBubble {
            static nextId = 0;
            
            constructor(x, y, type = 'normal') {
                this.id = CustomizableBubble.nextId++;
                this.x = x;
                this.y = y;
                this.type = type;
                
                // é›£æ˜“åº¦ã«ã‚ˆã‚‹èª¿æ•´
                const difficultyMultiplier = {
                    easy: 1.2,
                    normal: 1.0,
                    hard: 0.8,
                    expert: 0.6
                }[gameSettings.difficulty];
                
                this.radius = (20 + Math.random() * 20) * difficultyMultiplier;
                this.maxAge = (8000 + Math.random() * 4000) * difficultyMultiplier;
                this.speed = (Math.random() * 2 + 1) / difficultyMultiplier;
                
                // ãƒ†ãƒ¼ãƒã«å¿œã˜ãŸè‰²é¸æŠ
                const theme = THEMES[gameSettings.theme];
                this.color = theme.bubbleColors[Math.floor(Math.random() * theme.bubbleColors.length)];
                
                this.vx = (Math.random() - 0.5) * this.speed;
                this.vy = (Math.random() - 0.5) * this.speed;
                this.age = 0;
                this.isVisible = true;
            }
            
            update(deltaTime) {
                this.age += deltaTime;
                
                this.x += this.vx;
                this.y += this.vy;
                
                this.handleBoundaryCollision();
                
                return this.age < this.maxAge;
            }
            
            handleBoundaryCollision() {
                const margin = this.radius;
                if (this.x - margin <= 0 || this.x + margin >= canvas.width) {
                    this.vx *= -0.8;
                    this.x = Math.max(margin, Math.min(canvas.width - margin, this.x));
                }
                if (this.y - margin <= 0 || this.y + margin >= canvas.height) {
                    this.vy *= -0.8;
                    this.y = Math.max(margin, Math.min(canvas.height - margin, this.y));
                }
            }
            
            render() {
                if (!this.isVisible) return;
                
                ctx.save();
                
                const ageRatio = this.age / this.maxAge;
                const opacity = Math.max(0.3, 1 - ageRatio * 0.7);
                ctx.globalAlpha = opacity * (gameSettings.effectIntensity / 100);
                
                // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
                const gradient = ctx.createRadialGradient(
                    this.x - this.radius/3, this.y - this.radius/3, 0,
                    this.x, this.y, this.radius
                );
                gradient.addColorStop(0, this.lightenColor(this.color));
                gradient.addColorStop(1, this.color);
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå¼·åº¦ã«ã‚ˆã‚‹è¿½åŠ åŠ¹æœ
                if (gameSettings.effectIntensity > 50) {
                    ctx.strokeStyle = this.darkenColor(this.color);
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // å…‰æ²¢åŠ¹æœ
                    ctx.fillStyle = `rgba(255,255,255,${0.6 * gameSettings.effectIntensity / 100})`;
                    ctx.beginPath();
                    ctx.arc(this.x - this.radius/3, this.y - this.radius/3, this.radius/4, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                ctx.restore();
            }
            
            lightenColor(color) {
                const hex = color.replace('#', '');
                const r = Math.min(255, parseInt(hex.substr(0, 2), 16) + 40);
                const g = Math.min(255, parseInt(hex.substr(2, 2), 16) + 40);
                const b = Math.min(255, parseInt(hex.substr(4, 2), 16) + 40);
                return `rgb(${r},${g},${b})`;
            }
            
            darkenColor(color) {
                const hex = color.replace('#', '');
                const r = Math.max(0, parseInt(hex.substr(0, 2), 16) - 50);
                const g = Math.max(0, parseInt(hex.substr(2, 2), 16) - 50);
                const b = Math.max(0, parseInt(hex.substr(4, 2), 16) - 50);
                return `rgb(${r},${g},${b})`;
            }
            
            containsPoint(x, y) {
                const dx = x - this.x;
                const dy = y - this.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                return distance <= this.radius;
            }
            
            destroy() {
                this.isVisible = false;
                playerStats.bubblesDestroyed++;
            }
        }
        
        // ===== ã‚²ãƒ¼ãƒ æ©Ÿèƒ½ =====
        function startGameLoop() {
            const interval = 1000 / gameSettings.frameRate;
            gameLoop = setInterval(() => {
                if (!gamePaused) {
                    update();
                    render();
                    
                    // è‡ªå‹•ãƒãƒ–ãƒ«ç”Ÿæˆ
                    const spawnChance = gameSettings.spawnRate / 10000;
                    if (Math.random() < spawnChance && bubbles.length < gameSettings.maxBubbles) {
                        spawnBubble();
                    }
                }
            }, interval);
        }
        
        function spawnBubble() {
            const margin = 60;
            const x = margin + Math.random() * (canvas.width - margin * 2);
            const y = margin + Math.random() * (canvas.height - margin * 2);
            const bubble = new CustomizableBubble(x, y);
            bubbles.push(bubble);
            updateUI();
        }
        
        function startGame() {
            if (gameRunning) return;
            
            initializeAudio();
            gameRunning = true;
            gamePaused = false;
            gameStartTime = Date.now();
            
            score = 0;
            hp = 100;
            level = 1;
            totalClicks = 0;
            totalHits = 0;
            bubbles = [];
            
            // åˆæœŸãƒãƒ–ãƒ«ç”Ÿæˆ
            for (let i = 0; i < 3; i++) {
                spawnBubble();
            }
            
            startGameLoop();
            startBGM();
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('stopBtn').disabled = false;
            
            log(`ã‚²ãƒ¼ãƒ é–‹å§‹: ${gameSettings.difficulty}é›£æ˜“åº¦, ${gameSettings.playerName}`, 'success');
        }
        
        function pauseGame() {
            if (!gameRunning) return;
            
            gamePaused = !gamePaused;
            document.getElementById('pauseBtn').textContent = gamePaused ? 'å†é–‹' : 'ä¸€æ™‚åœæ­¢';
            
            if (gamePaused) {
                log('ã‚²ãƒ¼ãƒ ä¸€æ™‚åœæ­¢', 'info');
            } else {
                log('ã‚²ãƒ¼ãƒ å†é–‹', 'info');
            }
        }
        
        function stopGame() {
            if (!gameRunning) return;
            
            gameRunning = false;
            gamePaused = false;
            
            if (gameLoop) {
                clearInterval(gameLoop);
                gameLoop = null;
            }
            
            stopBGM();
            
            // çµ±è¨ˆæ›´æ–°
            const playTime = (Date.now() - gameStartTime) / 1000;
            playerStats.totalPlayTime += playTime;
            playerStats.totalScore += score;
            playerStats.gamesPlayed++;
            if (score > playerStats.highScore) {
                playerStats.highScore = score;
                log(`ğŸ‰ æ–°è¨˜éŒ²é”æˆ: ${score}ç‚¹ï¼`, 'special');
            }
            
            updateProfileDisplay();
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('pauseBtn').textContent = 'ä¸€æ™‚åœæ­¢';
            document.getElementById('stopBtn').disabled = true;
            
            log(`ã‚²ãƒ¼ãƒ çµ‚äº† - æœ€çµ‚ã‚¹ã‚³ã‚¢: ${score}, ãƒ—ãƒ¬ã‚¤æ™‚é–“: ${Math.floor(playTime)}ç§’`, 'success');
        }
        
        function update() {
            bubbles = bubbles.filter(bubble => bubble.update(16));
            updateUI();
        }
        
        function render() {
            const theme = THEMES[gameSettings.theme];
            ctx.fillStyle = theme.bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            bubbles.forEach(bubble => bubble.render());
            
            // çµ±è¨ˆè¡¨ç¤º
            if (gameSettings.showStats) {
                ctx.fillStyle = '#333';
                ctx.font = '12px monospace';
                ctx.textAlign = 'left';
                ctx.fillText(
                    `FPS: ${gameSettings.frameRate} | Bubbles: ${bubbles.length}/${gameSettings.maxBubbles} | Theme: ${gameSettings.theme}`,
                    10, 20
                );
                ctx.fillText(
                    `Effects: ${gameSettings.effectIntensity}% | Difficulty: ${gameSettings.difficulty}`,
                    10, 35
                );
            }
        }
        
        function updateUI() {
            document.getElementById('score').textContent = score;
            document.getElementById('hp').textContent = hp;
            document.getElementById('level').textContent = level;
            document.getElementById('bubbleCount').textContent = bubbles.length;
            
            const rate = totalClicks > 0 ? Math.round((totalHits / totalClicks) * 100) : 0;
            document.getElementById('hitRate').textContent = `${rate}%`;
        }
        
        // ===== ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ =====
        function getCanvasCoordinates(event) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / canvas.clientWidth;
            const scaleY = canvas.height / canvas.clientHeight;
            const sensitivity = gameSettings.mouseSensitivity / 100;
            
            const x = (event.clientX - rect.left) * scaleX * sensitivity;
            const y = (event.clientY - rect.top) * scaleY * sensitivity;
            return { x: x, y: y };
        }
        
        canvas.addEventListener('click', (event) => {
            if (!gameRunning || gamePaused) return;
            
            const coords = getCanvasCoordinates(event);
            totalClicks++;
            
            let hitBubble = null;
            for (let i = bubbles.length - 1; i >= 0; i--) {
                if (bubbles[i].containsPoint(coords.x, coords.y)) {
                    hitBubble = bubbles[i];
                    break;
                }
            }
            
            if (hitBubble) {
                totalHits++;
                const bubbleIndex = bubbles.indexOf(hitBubble);
                bubbles.splice(bubbleIndex, 1);
                
                const points = Math.floor(10 * (gameSettings.difficulty === 'expert' ? 1.5 : 
                                               gameSettings.difficulty === 'hard' ? 1.2 : 1.0));
                score += points;
                
                playSound(440 + Math.random() * 220, 0.1, 'pop');
                createPopEffect(hitBubble.x, hitBubble.y, hitBubble.color);
                hitBubble.destroy();
                
                log(`ğŸ¯ ãƒãƒ–ãƒ«ç ´å£Š +${points}ç‚¹`, 'hit');
            } else {
                playSound(150, 0.05, 'miss');
                log(`ğŸ’¨ ç©ºæŒ¯ã‚Š`, 'miss');
            }
            
            updateUI();
        });
        
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ
        document.addEventListener('keydown', (event) => {
            switch(event.code) {
                case 'Space':
                    event.preventDefault();
                    if (gameRunning) pauseGame();
                    break;
                case 'Escape':
                    event.preventDefault();
                    resetSettings();
                    break;
                case 'Enter':
                    if (!gameRunning) startGame();
                    break;
            }
        });
        
        // ===== ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ =====
        function createPopEffect(x, y, color) {
            const particleCount = Math.floor(gameSettings.particleCount * gameSettings.effectIntensity / 100);
            
            ctx.save();
            ctx.fillStyle = color;
            ctx.globalAlpha = 0.8;
            
            for (let i = 0; i < particleCount; i++) {
                const angle = (Math.PI * 2 * i) / particleCount;
                const distance = 20 + Math.random() * 30;
                const particleX = x + Math.cos(angle) * distance;
                const particleY = y + Math.sin(angle) * distance;
                
                ctx.beginPath();
                ctx.arc(particleX, particleY, 2 + Math.random() * 3, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.restore();
            
            // ç”»é¢éœ‡å‹•åŠ¹æœ
            if (gameSettings.screenShake) {
                const intensity = gameSettings.effectIntensity / 100 * 5;
                canvas.style.transform = `translate(${(Math.random() - 0.5) * intensity}px, ${(Math.random() - 0.5) * intensity}px)`;
                setTimeout(() => {
                    canvas.style.transform = 'translate(0px, 0px)';
                }, 50);
            }
        }
        
        // ===== åˆæœŸåŒ– =====
        function initialize() {
            setupSettingsListeners();
            loadSettings();
            updateSettingsUI();
            updateProfileDisplay();
            
            log('Step 10: è¨­å®šãƒ»ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã‚·ã‚¹ãƒ†ãƒ  æº–å‚™å®Œäº†', 'success');
            log('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®šã€ãƒ†ãƒ¼ãƒã€ã‚µã‚¦ãƒ³ãƒ‰ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è‡ªç”±ã«ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºï¼', 'info');
        }
        
        initialize();
    </script>
</body>
</html>