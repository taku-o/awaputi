<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Step 10: 設定・カスタマイズシステム</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        #gameContainer {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: 0 auto;
        }
        
        #gameCanvas {
            border: 2px solid #333;
            background: #e8f4f8;
            cursor: crosshair;
        }
        
        #gameInfo {
            margin-top: 10px;
            font-size: 16px;
            font-weight: bold;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .settings-panel {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .settings-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            min-width: 200px;
        }
        
        .settings-group h3 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
        }
        
        .setting-item {
            margin: 8px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .setting-label {
            font-size: 12px;
            color: #6c757d;
            flex: 1;
            text-align: left;
        }
        
        .setting-control {
            flex: 0 0 auto;
        }
        
        input[type="range"] {
            width: 80px;
        }
        
        input[type="checkbox"] {
            transform: scale(1.2);
        }
        
        select {
            padding: 4px;
            border-radius: 4px;
            border: 1px solid #ccc;
            font-size: 12px;
        }
        
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .theme-preview {
            width: 30px;
            height: 20px;
            border-radius: 4px;
            display: inline-block;
            margin-left: 5px;
            border: 1px solid #ccc;
        }
        
        #log {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
            max-height: 150px;
            overflow-y: auto;
            text-align: left;
            font-family: monospace;
            font-size: 11px;
        }
        
        .hit { color: #28a745; font-weight: bold; }
        .miss { color: #dc3545; }
        .info { color: #007bff; }
        .success { color: #28a745; font-weight: bold; }
        .special { color: #ff6600; font-weight: bold; }
        .warning { color: #ff6600; font-weight: bold; }
        .settings { color: #6f42c1; font-weight: bold; }
        
        #playerProfile {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: left;
        }
        
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat-item {
            background: white;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 12px;
        }
        
        .controls-help {
            background: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 12px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <h1>⚙️ Step 10: 設定・カスタマイズシステム</h1>
        <p>ゲーム設定をカスタマイズして、あなた好みのゲーム体験を作ろう！</p>
        
        <!-- プレイヤープロファイル -->
        <div id="playerProfile">
            <h3>🎮 プレイヤープロファイル</h3>
            <label>プレイヤー名: <input type="text" id="playerName" value="匿名プレイヤー" maxlength="20"></label>
            <div class="profile-stats" id="profileStats">
                <div class="stat-item">総プレイ時間<br><strong>0分</strong></div>
                <div class="stat-item">総スコア<br><strong>0</strong></div>
                <div class="stat-item">最高スコア<br><strong>0</strong></div>
                <div class="stat-item">ゲーム数<br><strong>0</strong></div>
            </div>
        </div>
        
        <!-- 設定パネル -->
        <div class="settings-panel">
            <!-- ゲームプレイ設定 -->
            <div class="settings-group">
                <h3>🎯 ゲームプレイ</h3>
                <div class="setting-item">
                    <span class="setting-label">難易度</span>
                    <select id="difficulty" class="setting-control">
                        <option value="easy">簡単</option>
                        <option value="normal" selected>普通</option>
                        <option value="hard">難しい</option>
                        <option value="expert">専門家</option>
                    </select>
                </div>
                <div class="setting-item">
                    <span class="setting-label">バブル生成速度</span>
                    <input type="range" id="spawnRate" min="5" max="50" value="20" class="setting-control">
                    <span id="spawnRateValue">20</span>
                </div>
                <div class="setting-item">
                    <span class="setting-label">バブル最大数</span>
                    <input type="range" id="maxBubbles" min="3" max="15" value="8" class="setting-control">
                    <span id="maxBubblesValue">8</span>
                </div>
                <div class="setting-item">
                    <span class="setting-label">パワーアップ頻度</span>
                    <input type="range" id="powerupFreq" min="1" max="10" value="5" class="setting-control">
                    <span id="powerupFreqValue">5</span>
                </div>
            </div>
            
            <!-- 視覚設定 -->
            <div class="settings-group">
                <h3>🎨 視覚効果</h3>
                <div class="setting-item">
                    <span class="setting-label">テーマ</span>
                    <select id="theme" class="setting-control">
                        <option value="default">デフォルト</option>
                        <option value="dark">ダーク</option>
                        <option value="neon">ネオン</option>
                        <option value="ocean">オーシャン</option>
                        <option value="sunset">サンセット</option>
                    </select>
                    <div class="theme-preview" id="themePreview"></div>
                </div>
                <div class="setting-item">
                    <span class="setting-label">エフェクト強度</span>
                    <input type="range" id="effectIntensity" min="0" max="100" value="75" class="setting-control">
                    <span id="effectIntensityValue">75</span>
                </div>
                <div class="setting-item">
                    <span class="setting-label">パーティクル数</span>
                    <input type="range" id="particleCount" min="5" max="30" value="15" class="setting-control">
                    <span id="particleCountValue">15</span>
                </div>
                <div class="setting-item">
                    <span class="setting-label">画面震動</span>
                    <input type="checkbox" id="screenShake" checked class="setting-control">
                </div>
            </div>
            
            <!-- サウンド設定 -->
            <div class="settings-group">
                <h3>🔊 サウンド</h3>
                <div class="setting-item">
                    <span class="setting-label">BGM有効</span>
                    <input type="checkbox" id="bgmEnabled" checked class="setting-control">
                </div>
                <div class="setting-item">
                    <span class="setting-label">BGM音量</span>
                    <input type="range" id="bgmVolume" min="0" max="100" value="30" class="setting-control">
                    <span id="bgmVolumeValue">30</span>
                </div>
                <div class="setting-item">
                    <span class="setting-label">効果音有効</span>
                    <input type="checkbox" id="sfxEnabled" checked class="setting-control">
                </div>
                <div class="setting-item">
                    <span class="setting-label">効果音音量</span>
                    <input type="range" id="sfxVolume" min="0" max="100" value="70" class="setting-control">
                    <span id="sfxVolumeValue">70</span>
                </div>
            </div>
            
            <!-- コントロール設定 -->
            <div class="settings-group">
                <h3>🎮 コントロール</h3>
                <div class="setting-item">
                    <span class="setting-label">マウス感度</span>
                    <input type="range" id="mouseSensitivity" min="50" max="200" value="100" class="setting-control">
                    <span id="mouseSensitivityValue">100</span>
                </div>
                <div class="setting-item">
                    <span class="setting-label">連続クリック許可</span>
                    <input type="checkbox" id="rapidClick" class="setting-control">
                </div>
                <div class="setting-item">
                    <span class="setting-label">右クリック無効</span>
                    <input type="checkbox" id="disableRightClick" checked class="setting-control">
                </div>
                <div class="setting-item">
                    <span class="setting-label">タッチサポート</span>
                    <input type="checkbox" id="touchSupport" checked class="setting-control">
                </div>
            </div>
            
            <!-- パフォーマンス設定 -->
            <div class="settings-group">
                <h3>⚡ パフォーマンス</h3>
                <div class="setting-item">
                    <span class="setting-label">フレームレート</span>
                    <select id="frameRate" class="setting-control">
                        <option value="30">30 FPS</option>
                        <option value="60" selected>60 FPS</option>
                        <option value="120">120 FPS</option>
                    </select>
                </div>
                <div class="setting-item">
                    <span class="setting-label">品質自動調整</span>
                    <input type="checkbox" id="autoQuality" checked class="setting-control">
                </div>
                <div class="setting-item">
                    <span class="setting-label">省電力モード</span>
                    <input type="checkbox" id="powerSave" class="setting-control">
                </div>
                <div class="setting-item">
                    <span class="setting-label">統計表示</span>
                    <input type="checkbox" id="showStats" class="setting-control">
                </div>
            </div>
        </div>
        
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div id="gameInfo">
            <div>プレイヤー: <span id="currentPlayer">匿名プレイヤー</span></div>
            <div>スコア: <span id="score">0</span></div>
            <div>HP: <span id="hp">100</span></div>
            <div>バブル数: <span id="bubbleCount">0</span></div>
            <div>レベル: <span id="level">1</span></div>
            <div>命中率: <span id="hitRate">0%</span></div>
        </div>
        
        <div class="controls-help">
            <strong>💡 操作ヒント:</strong>
            <span id="controlsText">クリックでバブルを破壊 | スペースキーでポーズ | Escで設定リセット</span>
        </div>
        
        <div>
            <button onclick="startGame()" id="startBtn">ゲーム開始</button>
            <button onclick="pauseGame()" id="pauseBtn" disabled>一時停止</button>
            <button onclick="stopGame()" id="stopBtn" disabled>ゲーム停止</button>
            <button onclick="saveSettings()">設定保存</button>
            <button onclick="loadSettings()">設定読込</button>
            <button onclick="resetSettings()">設定リセット</button>
            <button onclick="exportProfile()">プロフィール出力</button>
        </div>
        
        <div id="log"></div>
    </div>

    <script>
        // ===== グローバル変数 =====
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const logElement = document.getElementById('log');
        
        let bubbles = [];
        let score = 0;
        let hp = 100;
        let level = 1;
        let totalClicks = 0;
        let totalHits = 0;
        let gameRunning = false;
        let gamePaused = false;
        let gameLoop = null;
        let gameStartTime = 0;
        let totalPlayTime = 0;
        
        // 設定オブジェクト
        let gameSettings = {
            // プレイヤー
            playerName: '匿名プレイヤー',
            
            // ゲームプレイ
            difficulty: 'normal',
            spawnRate: 20,
            maxBubbles: 8,
            powerupFreq: 5,
            
            // 視覚
            theme: 'default',
            effectIntensity: 75,
            particleCount: 15,
            screenShake: true,
            
            // サウンド
            bgmEnabled: true,
            bgmVolume: 30,
            sfxEnabled: true,
            sfxVolume: 70,
            
            // コントロール
            mouseSensitivity: 100,
            rapidClick: false,
            disableRightClick: true,
            touchSupport: true,
            
            // パフォーマンス
            frameRate: 60,
            autoQuality: true,
            powerSave: false,
            showStats: false
        };
        
        // プレイヤー統計
        let playerStats = {
            totalPlayTime: 0,
            totalScore: 0,
            highScore: 0,
            gamesPlayed: 0,
            bubblesDestroyed: 0,
            averageAccuracy: 0
        };
        
        // テーマ設定
        const THEMES = {
            default: {
                bg: '#e8f4f8',
                bubbleColors: ['#4A90E2', '#7ED321', '#D0021B', '#F5A623', '#9013FE'],
                canvasBorder: '#333'
            },
            dark: {
                bg: '#2c3e50',
                bubbleColors: ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#8e44ad'],
                canvasBorder: '#ecf0f1'
            },
            neon: {
                bg: '#0a0a0a',
                bubbleColors: ['#00ffff', '#ff00ff', '#ffff00', '#00ff00', '#ff0080'],
                canvasBorder: '#ffffff'
            },
            ocean: {
                bg: '#006994',
                bubbleColors: ['#4dd0e1', '#81c784', '#64b5f6', '#a1c4fd', '#b39ddb'],
                canvasBorder: '#ffffff'
            },
            sunset: {
                bg: '#ff7043',
                bubbleColors: ['#ffab40', '#ff8a65', '#f48fb1', '#ce93d8', '#90caf9'],
                canvasBorder: '#ffffff'
            }
        };
        
        // サウンドシステム（簡単なWeb Audio API）
        let audioContext = null;
        let bgmInterval = null;
        
        // ===== ログ機能 =====
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = type;
            div.textContent = `[${time}] ${message}`;
            logElement.appendChild(div);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type}] ${message}`);
        }
        
        // ===== 設定管理 =====
        function updateSettingsUI() {
            // 全ての設定項目をUIに反映
            document.getElementById('playerName').value = gameSettings.playerName;
            document.getElementById('difficulty').value = gameSettings.difficulty;
            document.getElementById('spawnRate').value = gameSettings.spawnRate;
            document.getElementById('maxBubbles').value = gameSettings.maxBubbles;
            document.getElementById('powerupFreq').value = gameSettings.powerupFreq;
            
            document.getElementById('theme').value = gameSettings.theme;
            document.getElementById('effectIntensity').value = gameSettings.effectIntensity;
            document.getElementById('particleCount').value = gameSettings.particleCount;
            document.getElementById('screenShake').checked = gameSettings.screenShake;
            
            document.getElementById('bgmEnabled').checked = gameSettings.bgmEnabled;
            document.getElementById('bgmVolume').value = gameSettings.bgmVolume;
            document.getElementById('sfxEnabled').checked = gameSettings.sfxEnabled;
            document.getElementById('sfxVolume').value = gameSettings.sfxVolume;
            
            document.getElementById('mouseSensitivity').value = gameSettings.mouseSensitivity;
            document.getElementById('rapidClick').checked = gameSettings.rapidClick;
            document.getElementById('disableRightClick').checked = gameSettings.disableRightClick;
            document.getElementById('touchSupport').checked = gameSettings.touchSupport;
            
            document.getElementById('frameRate').value = gameSettings.frameRate;
            document.getElementById('autoQuality').checked = gameSettings.autoQuality;
            document.getElementById('powerSave').checked = gameSettings.powerSave;
            document.getElementById('showStats').checked = gameSettings.showStats;
            
            updateValueDisplays();
            updateThemePreview();
            applySettings();
        }
        
        function updateValueDisplays() {
            document.getElementById('spawnRateValue').textContent = gameSettings.spawnRate;
            document.getElementById('maxBubblesValue').textContent = gameSettings.maxBubbles;
            document.getElementById('powerupFreqValue').textContent = gameSettings.powerupFreq;
            document.getElementById('effectIntensityValue').textContent = gameSettings.effectIntensity;
            document.getElementById('particleCountValue').textContent = gameSettings.particleCount;
            document.getElementById('bgmVolumeValue').textContent = gameSettings.bgmVolume;
            document.getElementById('sfxVolumeValue').textContent = gameSettings.sfxVolume;
            document.getElementById('mouseSensitivityValue').textContent = gameSettings.mouseSensitivity + '%';
        }
        
        function updateThemePreview() {
            const preview = document.getElementById('themePreview');
            const theme = THEMES[gameSettings.theme];
            preview.style.background = `linear-gradient(45deg, ${theme.bg}, ${theme.bubbleColors[0]})`;
        }
        
        function applySettings() {
            // プレイヤー名更新
            document.getElementById('currentPlayer').textContent = gameSettings.playerName;
            
            // テーマ適用
            applyTheme();
            
            // Canvas右クリック無効化
            if (gameSettings.disableRightClick) {
                canvas.addEventListener('contextmenu', e => e.preventDefault());
            }
            
            // フレームレート設定
            if (gameLoop) {
                clearInterval(gameLoop);
                startGameLoop();
            }
            
            // コントロールヘルプ更新
            updateControlsHelp();
            
            log(`設定適用完了: ${gameSettings.difficulty}難易度, ${gameSettings.theme}テーマ`, 'settings');
        }
        
        function applyTheme() {
            const theme = THEMES[gameSettings.theme];
            canvas.style.borderColor = theme.canvasBorder;
            document.querySelector('#gameCanvas').style.background = theme.bg;
        }
        
        function updateControlsHelp() {
            let helpText = 'クリックでバブルを破壊';
            
            if (gameSettings.rapidClick) {
                helpText += ' | 連続クリック可能';
            }
            if (gameSettings.touchSupport) {
                helpText += ' | タッチ操作対応';
            }
            helpText += ' | スペースキーでポーズ | Escで設定リセット';
            
            document.getElementById('controlsText').textContent = helpText;
        }
        
        function saveSettings() {
            try {
                localStorage.setItem('bubbleGameSettings', JSON.stringify(gameSettings));
                localStorage.setItem('bubbleGameStats', JSON.stringify(playerStats));
                log('設定とプロファイルを保存しました', 'success');
            } catch (error) {
                log('設定保存エラー: ' + error.message, 'warning');
            }
        }
        
        function loadSettings() {
            try {
                const savedSettings = localStorage.getItem('bubbleGameSettings');
                const savedStats = localStorage.getItem('bubbleGameStats');
                
                if (savedSettings) {
                    gameSettings = { ...gameSettings, ...JSON.parse(savedSettings) };
                    updateSettingsUI();
                    log('設定を読み込みました', 'success');
                }
                
                if (savedStats) {
                    playerStats = { ...playerStats, ...JSON.parse(savedStats) };
                    updateProfileDisplay();
                    log('プロファイルを読み込みました', 'success');
                }
            } catch (error) {
                log('設定読込エラー: ' + error.message, 'warning');
            }
        }
        
        function resetSettings() {
            if (confirm('全ての設定をリセットしますか？')) {
                gameSettings = {
                    playerName: '匿名プレイヤー',
                    difficulty: 'normal',
                    spawnRate: 20,
                    maxBubbles: 8,
                    powerupFreq: 5,
                    theme: 'default',
                    effectIntensity: 75,
                    particleCount: 15,
                    screenShake: true,
                    bgmEnabled: true,
                    bgmVolume: 30,
                    sfxEnabled: true,
                    sfxVolume: 70,
                    mouseSensitivity: 100,
                    rapidClick: false,
                    disableRightClick: true,
                    touchSupport: true,
                    frameRate: 60,
                    autoQuality: true,
                    powerSave: false,
                    showStats: false
                };
                updateSettingsUI();
                log('設定をリセットしました', 'success');
            }
        }
        
        function exportProfile() {
            const exportData = {
                settings: gameSettings,
                stats: playerStats,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `bubble-game-profile-${gameSettings.playerName}-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            log(`プロファイル「${gameSettings.playerName}」をエクスポートしました`, 'success');
        }
        
        function updateProfileDisplay() {
            const stats = document.querySelectorAll('#profileStats .stat-item');
            stats[0].innerHTML = `総プレイ時間<br><strong>${Math.floor(playerStats.totalPlayTime / 60)}分</strong>`;
            stats[1].innerHTML = `総スコア<br><strong>${playerStats.totalScore.toLocaleString()}</strong>`;
            stats[2].innerHTML = `最高スコア<br><strong>${playerStats.highScore.toLocaleString()}</strong>`;
            stats[3].innerHTML = `ゲーム数<br><strong>${playerStats.gamesPlayed}</strong>`;
        }
        
        // ===== 設定変更イベント =====
        function setupSettingsListeners() {
            // プレイヤー名
            document.getElementById('playerName').addEventListener('input', (e) => {
                gameSettings.playerName = e.target.value || '匿名プレイヤー';
                document.getElementById('currentPlayer').textContent = gameSettings.playerName;
            });
            
            // 各種スライダーとチェックボックス
            const settingElements = [
                'difficulty', 'spawnRate', 'maxBubbles', 'powerupFreq',
                'theme', 'effectIntensity', 'particleCount', 'screenShake',
                'bgmEnabled', 'bgmVolume', 'sfxEnabled', 'sfxVolume',
                'mouseSensitivity', 'rapidClick', 'disableRightClick', 'touchSupport',
                'frameRate', 'autoQuality', 'powerSave', 'showStats'
            ];
            
            settingElements.forEach(id => {
                const element = document.getElementById(id);
                const eventType = element.type === 'checkbox' ? 'change' : 'input';
                
                element.addEventListener(eventType, (e) => {
                    const value = e.target.type === 'checkbox' ? e.target.checked : 
                                  e.target.type === 'range' ? parseInt(e.target.value) : e.target.value;
                    gameSettings[id] = value;
                    
                    updateValueDisplays();
                    if (id === 'theme') updateThemePreview();
                    applySettings();
                });
            });
        }
        
        // ===== サウンドシステム =====
        function initializeAudio() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    log('オーディオシステム初期化完了', 'success');
                } catch (error) {
                    log('オーディオ初期化失敗: ' + error.message, 'warning');
                }
            }
        }
        
        function playSound(frequency, duration, type = 'pop') {
            if (!gameSettings.sfxEnabled || !audioContext) return;
            
            try {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                oscillator.type = type === 'pop' ? 'sine' : 'square';
                
                const volume = gameSettings.sfxVolume / 100 * 0.1;
                gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (error) {
                console.warn('音声再生エラー:', error);
            }
        }
        
        function startBGM() {
            if (!gameSettings.bgmEnabled || bgmInterval || !audioContext) return;
            
            const notes = [261.63, 293.66, 329.63, 349.23, 392.00, 440.00, 493.88];
            let noteIndex = 0;
            
            bgmInterval = setInterval(() => {
                if (gameSettings.bgmEnabled && !gamePaused) {
                    const frequency = notes[noteIndex % notes.length];
                    const volume = gameSettings.bgmVolume / 100 * 0.05;
                    
                    try {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                        oscillator.type = 'sine';
                        
                        gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.5);
                        
                        noteIndex++;
                    } catch (error) {
                        console.warn('BGM再生エラー:', error);
                    }
                }
            }, 800);
        }
        
        function stopBGM() {
            if (bgmInterval) {
                clearInterval(bgmInterval);
                bgmInterval = null;
            }
        }
        
        // ===== バブルクラス（設定対応版） =====
        class CustomizableBubble {
            static nextId = 0;
            
            constructor(x, y, type = 'normal') {
                this.id = CustomizableBubble.nextId++;
                this.x = x;
                this.y = y;
                this.type = type;
                
                // 難易度による調整
                const difficultyMultiplier = {
                    easy: 1.2,
                    normal: 1.0,
                    hard: 0.8,
                    expert: 0.6
                }[gameSettings.difficulty];
                
                this.radius = (20 + Math.random() * 20) * difficultyMultiplier;
                this.maxAge = (8000 + Math.random() * 4000) * difficultyMultiplier;
                this.speed = (Math.random() * 2 + 1) / difficultyMultiplier;
                
                // テーマに応じた色選択
                const theme = THEMES[gameSettings.theme];
                this.color = theme.bubbleColors[Math.floor(Math.random() * theme.bubbleColors.length)];
                
                this.vx = (Math.random() - 0.5) * this.speed;
                this.vy = (Math.random() - 0.5) * this.speed;
                this.age = 0;
                this.isVisible = true;
            }
            
            update(deltaTime) {
                this.age += deltaTime;
                
                this.x += this.vx;
                this.y += this.vy;
                
                this.handleBoundaryCollision();
                
                return this.age < this.maxAge;
            }
            
            handleBoundaryCollision() {
                const margin = this.radius;
                if (this.x - margin <= 0 || this.x + margin >= canvas.width) {
                    this.vx *= -0.8;
                    this.x = Math.max(margin, Math.min(canvas.width - margin, this.x));
                }
                if (this.y - margin <= 0 || this.y + margin >= canvas.height) {
                    this.vy *= -0.8;
                    this.y = Math.max(margin, Math.min(canvas.height - margin, this.y));
                }
            }
            
            render() {
                if (!this.isVisible) return;
                
                ctx.save();
                
                const ageRatio = this.age / this.maxAge;
                const opacity = Math.max(0.3, 1 - ageRatio * 0.7);
                ctx.globalAlpha = opacity * (gameSettings.effectIntensity / 100);
                
                // グラデーション効果
                const gradient = ctx.createRadialGradient(
                    this.x - this.radius/3, this.y - this.radius/3, 0,
                    this.x, this.y, this.radius
                );
                gradient.addColorStop(0, this.lightenColor(this.color));
                gradient.addColorStop(1, this.color);
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // エフェクト強度による追加効果
                if (gameSettings.effectIntensity > 50) {
                    ctx.strokeStyle = this.darkenColor(this.color);
                    ctx.lineWidth = 2;
                    ctx.stroke();
                    
                    // 光沢効果
                    ctx.fillStyle = `rgba(255,255,255,${0.6 * gameSettings.effectIntensity / 100})`;
                    ctx.beginPath();
                    ctx.arc(this.x - this.radius/3, this.y - this.radius/3, this.radius/4, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                ctx.restore();
            }
            
            lightenColor(color) {
                const hex = color.replace('#', '');
                const r = Math.min(255, parseInt(hex.substr(0, 2), 16) + 40);
                const g = Math.min(255, parseInt(hex.substr(2, 2), 16) + 40);
                const b = Math.min(255, parseInt(hex.substr(4, 2), 16) + 40);
                return `rgb(${r},${g},${b})`;
            }
            
            darkenColor(color) {
                const hex = color.replace('#', '');
                const r = Math.max(0, parseInt(hex.substr(0, 2), 16) - 50);
                const g = Math.max(0, parseInt(hex.substr(2, 2), 16) - 50);
                const b = Math.max(0, parseInt(hex.substr(4, 2), 16) - 50);
                return `rgb(${r},${g},${b})`;
            }
            
            containsPoint(x, y) {
                const dx = x - this.x;
                const dy = y - this.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                return distance <= this.radius;
            }
            
            destroy() {
                this.isVisible = false;
                playerStats.bubblesDestroyed++;
            }
        }
        
        // ===== ゲーム機能 =====
        function startGameLoop() {
            const interval = 1000 / gameSettings.frameRate;
            gameLoop = setInterval(() => {
                if (!gamePaused) {
                    update();
                    render();
                    
                    // 自動バブル生成
                    const spawnChance = gameSettings.spawnRate / 10000;
                    if (Math.random() < spawnChance && bubbles.length < gameSettings.maxBubbles) {
                        spawnBubble();
                    }
                }
            }, interval);
        }
        
        function spawnBubble() {
            const margin = 60;
            const x = margin + Math.random() * (canvas.width - margin * 2);
            const y = margin + Math.random() * (canvas.height - margin * 2);
            const bubble = new CustomizableBubble(x, y);
            bubbles.push(bubble);
            updateUI();
        }
        
        function startGame() {
            if (gameRunning) return;
            
            initializeAudio();
            gameRunning = true;
            gamePaused = false;
            gameStartTime = Date.now();
            
            score = 0;
            hp = 100;
            level = 1;
            totalClicks = 0;
            totalHits = 0;
            bubbles = [];
            
            // 初期バブル生成
            for (let i = 0; i < 3; i++) {
                spawnBubble();
            }
            
            startGameLoop();
            startBGM();
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('stopBtn').disabled = false;
            
            log(`ゲーム開始: ${gameSettings.difficulty}難易度, ${gameSettings.playerName}`, 'success');
        }
        
        function pauseGame() {
            if (!gameRunning) return;
            
            gamePaused = !gamePaused;
            document.getElementById('pauseBtn').textContent = gamePaused ? '再開' : '一時停止';
            
            if (gamePaused) {
                log('ゲーム一時停止', 'info');
            } else {
                log('ゲーム再開', 'info');
            }
        }
        
        function stopGame() {
            if (!gameRunning) return;
            
            gameRunning = false;
            gamePaused = false;
            
            if (gameLoop) {
                clearInterval(gameLoop);
                gameLoop = null;
            }
            
            stopBGM();
            
            // 統計更新
            const playTime = (Date.now() - gameStartTime) / 1000;
            playerStats.totalPlayTime += playTime;
            playerStats.totalScore += score;
            playerStats.gamesPlayed++;
            if (score > playerStats.highScore) {
                playerStats.highScore = score;
                log(`🎉 新記録達成: ${score}点！`, 'special');
            }
            
            updateProfileDisplay();
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('pauseBtn').textContent = '一時停止';
            document.getElementById('stopBtn').disabled = true;
            
            log(`ゲーム終了 - 最終スコア: ${score}, プレイ時間: ${Math.floor(playTime)}秒`, 'success');
        }
        
        function update() {
            bubbles = bubbles.filter(bubble => bubble.update(16));
            updateUI();
        }
        
        function render() {
            const theme = THEMES[gameSettings.theme];
            ctx.fillStyle = theme.bg;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            bubbles.forEach(bubble => bubble.render());
            
            // 統計表示
            if (gameSettings.showStats) {
                ctx.fillStyle = '#333';
                ctx.font = '12px monospace';
                ctx.textAlign = 'left';
                ctx.fillText(
                    `FPS: ${gameSettings.frameRate} | Bubbles: ${bubbles.length}/${gameSettings.maxBubbles} | Theme: ${gameSettings.theme}`,
                    10, 20
                );
                ctx.fillText(
                    `Effects: ${gameSettings.effectIntensity}% | Difficulty: ${gameSettings.difficulty}`,
                    10, 35
                );
            }
        }
        
        function updateUI() {
            document.getElementById('score').textContent = score;
            document.getElementById('hp').textContent = hp;
            document.getElementById('level').textContent = level;
            document.getElementById('bubbleCount').textContent = bubbles.length;
            
            const rate = totalClicks > 0 ? Math.round((totalHits / totalClicks) * 100) : 0;
            document.getElementById('hitRate').textContent = `${rate}%`;
        }
        
        // ===== イベントハンドラー =====
        function getCanvasCoordinates(event) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / canvas.clientWidth;
            const scaleY = canvas.height / canvas.clientHeight;
            const sensitivity = gameSettings.mouseSensitivity / 100;
            
            const x = (event.clientX - rect.left) * scaleX * sensitivity;
            const y = (event.clientY - rect.top) * scaleY * sensitivity;
            return { x: x, y: y };
        }
        
        canvas.addEventListener('click', (event) => {
            if (!gameRunning || gamePaused) return;
            
            const coords = getCanvasCoordinates(event);
            totalClicks++;
            
            let hitBubble = null;
            for (let i = bubbles.length - 1; i >= 0; i--) {
                if (bubbles[i].containsPoint(coords.x, coords.y)) {
                    hitBubble = bubbles[i];
                    break;
                }
            }
            
            if (hitBubble) {
                totalHits++;
                const bubbleIndex = bubbles.indexOf(hitBubble);
                bubbles.splice(bubbleIndex, 1);
                
                const points = Math.floor(10 * (gameSettings.difficulty === 'expert' ? 1.5 : 
                                               gameSettings.difficulty === 'hard' ? 1.2 : 1.0));
                score += points;
                
                playSound(440 + Math.random() * 220, 0.1, 'pop');
                createPopEffect(hitBubble.x, hitBubble.y, hitBubble.color);
                hitBubble.destroy();
                
                log(`🎯 バブル破壊 +${points}点`, 'hit');
            } else {
                playSound(150, 0.05, 'miss');
                log(`💨 空振り`, 'miss');
            }
            
            updateUI();
        });
        
        // キーボードショートカット
        document.addEventListener('keydown', (event) => {
            switch(event.code) {
                case 'Space':
                    event.preventDefault();
                    if (gameRunning) pauseGame();
                    break;
                case 'Escape':
                    event.preventDefault();
                    resetSettings();
                    break;
                case 'Enter':
                    if (!gameRunning) startGame();
                    break;
            }
        });
        
        // ===== エフェクト =====
        function createPopEffect(x, y, color) {
            const particleCount = Math.floor(gameSettings.particleCount * gameSettings.effectIntensity / 100);
            
            ctx.save();
            ctx.fillStyle = color;
            ctx.globalAlpha = 0.8;
            
            for (let i = 0; i < particleCount; i++) {
                const angle = (Math.PI * 2 * i) / particleCount;
                const distance = 20 + Math.random() * 30;
                const particleX = x + Math.cos(angle) * distance;
                const particleY = y + Math.sin(angle) * distance;
                
                ctx.beginPath();
                ctx.arc(particleX, particleY, 2 + Math.random() * 3, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.restore();
            
            // 画面震動効果
            if (gameSettings.screenShake) {
                const intensity = gameSettings.effectIntensity / 100 * 5;
                canvas.style.transform = `translate(${(Math.random() - 0.5) * intensity}px, ${(Math.random() - 0.5) * intensity}px)`;
                setTimeout(() => {
                    canvas.style.transform = 'translate(0px, 0px)';
                }, 50);
            }
        }
        
        // ===== 初期化 =====
        function initialize() {
            setupSettingsListeners();
            loadSettings();
            updateSettingsUI();
            updateProfileDisplay();
            
            log('Step 10: 設定・カスタマイズシステム 準備完了', 'success');
            log('プレイヤー設定、テーマ、サウンド、コントロールを自由にカスタマイズ！', 'info');
        }
        
        initialize();
    </script>
</body>
</html>