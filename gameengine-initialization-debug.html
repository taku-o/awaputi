<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>GameEngine Initialization Debug - Issue #113</title>
    <style>
        body {
            margin: 20px;
            font-family: monospace;
            background: #f0f0f0;
        }
        
        #container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
        }
        
        #log {
            margin-top: 20px;
            background: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            max-height: 500px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-info { color: #0066cc; }
        .log-error { color: #cc0000; font-weight: bold; }
        .log-success { color: #006600; }
        .log-warning { color: #cc6600; }
        .log-critical { color: #800080; font-weight: bold; }
    </style>
</head>
<body>
    <div id="container">
        <h1>ğŸ” GameEngine Initialization Debug</h1>
        <p>GameEngineå†…ã§ã®EventStageManageråˆæœŸåŒ–éç¨‹ã‚’è©³ç´°èª¿æŸ»</p>
        
        <canvas id="gameCanvas" width="400" height="300" style="border: 2px solid #333; background: #e8f4f8;"></canvas>
        
        <div>
            <button onclick="debugGameEngineInitialization()">ğŸ” GameEngineåˆæœŸåŒ–ãƒ‡ãƒãƒƒã‚°</button>
            <button onclick="clearLog()">ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        </div>
        
        <div id="log"></div>
    </div>

    <script type="module">
        // ===== ãƒ­ã‚°æ©Ÿèƒ½ =====
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const div = document.createElement('div');
            div.className = `log-${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logElement.appendChild(div);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type}] ${message}`);
        }
        
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        };
        
        window.debugGameEngineInitialization = async function() {
            log('=== GameEngineåˆæœŸåŒ–ãƒ‡ãƒãƒƒã‚°é–‹å§‹ ===', 'critical');
            
            try {
                // ã‚­ãƒ£ãƒƒã‚·ãƒ¥å›é¿ã§GameEngineã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                const timestamp = Date.now();
                const { GameEngine } = await import(`./src/core/GameEngine.js?t=${timestamp}`);
                log('âœ… GameEngineã‚¯ãƒ©ã‚¹ã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ', 'success');
                
                const canvas = document.getElementById('gameCanvas');
                
                // GameEngineã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼å®Ÿè¡Œå‰ã«ãƒ­ã‚°ç›£è¦–é–‹å§‹
                const originalConsoleLog = console.log;
                const capturedInitLogs = [];
                
                console.log = function(...args) {
                    const message = args.join(' ');
                    originalConsoleLog.apply(console, args);
                    
                    // EventStageManageré–¢é€£ã®ãƒ­ã‚°ã‚’ç‰¹ã«ã‚­ãƒ£ãƒ—ãƒãƒ£
                    if (message.includes('EventStageManager') || 
                        message.includes('eventStageManager') ||
                        message.includes('[DEBUG]')) {
                        capturedInitLogs.push(message);
                    }
                };
                
                log('GameEngineã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼å®Ÿè¡Œé–‹å§‹...', 'info');
                
                // ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã‚’æ®µéšçš„ã«ç›£è¦–
                const gameEngine = new GameEngine(canvas);
                
                log('âœ… GameEngineã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼å®Œäº†', 'success');
                
                // ãƒ­ã‚°ç›£è¦–çµ‚äº†
                console.log = originalConsoleLog;
                
                // ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸãƒ­ã‚°ã‚’è¡¨ç¤º
                log('=== åˆæœŸåŒ–ä¸­ã«ã‚­ãƒ£ãƒ—ãƒãƒ£ã—ãŸEventStageManageré–¢é€£ãƒ­ã‚° ===', 'critical');
                if (capturedInitLogs.length > 0) {
                    capturedInitLogs.forEach((logMsg, i) => {
                        log(`${i+1}. ${logMsg}`, 'info');
                    });
                } else {
                    log('âŒ EventStageManageré–¢é€£ã®ãƒ­ã‚°ãŒã‚­ãƒ£ãƒ—ãƒãƒ£ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ', 'error');
                }
                
                // EventStageManagerã®è©³ç´°ç¢ºèª
                log('=== EventStageManagerè©³ç´°ç¢ºèª ===', 'critical');
                
                if (gameEngine.eventStageManager) {
                    log('âœ… gameEngine.eventStageManagerå­˜åœ¨', 'success');
                    
                    // EventStageManagerã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£è©³ç´°ç¢ºèª
                    const esm = gameEngine.eventStageManager;
                    log(`constructor.name: ${esm.constructor.name}`, 'info');
                    log(`toString(): ${esm.toString()}`, 'info');
                    
                    // ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ãƒã‚§ãƒ¼ãƒ³ç¢ºèª
                    const prototype = Object.getPrototypeOf(esm);
                    const protoMethods = Object.getOwnPropertyNames(prototype)
                        .filter(name => typeof prototype[name] === 'function');
                    log(`ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ãƒ¡ã‚½ãƒƒãƒ‰: ${protoMethods.join(', ')}`, 'info');
                    
                    // loadãƒ¡ã‚½ãƒƒãƒ‰ã®è©³ç´°ç¢ºèª
                    const hasLoad = 'load' in esm;
                    const loadType = typeof esm.load;
                    log(`loadãƒ—ãƒ­ãƒ‘ãƒ†ã‚£å­˜åœ¨: ${hasLoad}`, hasLoad ? 'success' : 'error');
                    log(`loadã‚¿ã‚¤ãƒ—: ${loadType}`, loadType === 'function' ? 'success' : 'error');
                    
                    // prototypeã«loadãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚‹ã‹ç¢ºèª
                    const protoHasLoad = 'load' in prototype;
                    log(`ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ã«loadãƒ¡ã‚½ãƒƒãƒ‰: ${protoHasLoad}`, protoHasLoad ? 'success' : 'error');
                    
                    // å®Ÿéš›ã«loadãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ãƒ†ã‚¹ãƒˆ
                    if (typeof esm.load === 'function') {
                        log('loadãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè¡Œãƒ†ã‚¹ãƒˆ...', 'info');
                        try {
                            const result = esm.load();
                            log(`âœ… loadãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè¡ŒæˆåŠŸ: ${result}`, 'success');
                        } catch (loadError) {
                            log(`âŒ loadãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${loadError.message}`, 'error');
                        }
                    } else {
                        log('âŒ loadãƒ¡ã‚½ãƒƒãƒ‰ãŒé–¢æ•°ã§ã¯ãªã„', 'error');
                        
                        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±: loadãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®è©³ç´°
                        if ('load' in esm) {
                            log(`loadãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å†…å®¹: ${esm.load}`, 'warning');
                            log(`loadãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®constructor: ${esm.load?.constructor?.name}`, 'warning');
                        }
                    }
                    
                    // GameEngineInitializerã§ã®ç¢ºèªæ–¹æ³•ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                    log('=== GameEngineInitializerã§ã®ç¢ºèªæ–¹æ³•ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ ===', 'critical');
                    const initializerCheck = gameEngine.eventStageManager && 
                                           typeof gameEngine.eventStageManager.load === 'function';
                    log(`Initializeråˆ¤å®š: ${initializerCheck}`, initializerCheck ? 'success' : 'error');
                    
                } else {
                    log('âŒ gameEngine.eventStageManagerãŒnull/undefined', 'error');
                }
                
            } catch (error) {
                log(`âŒ GameEngineåˆæœŸåŒ–ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log(`ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯: ${error.stack}`, 'error');
            }
        };
        
        // ===== åˆæœŸåŒ– =====
        log('GameEngineåˆæœŸåŒ–ãƒ‡ãƒãƒƒã‚°æº–å‚™å®Œäº†', 'info');
        log('EventStageManagerã®åˆæœŸåŒ–éç¨‹ã‚’è©³ç´°ã«è¿½è·¡ã—ã¾ã™', 'info');
        log('âš ï¸ ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã‚‚ç¢ºèªã—ã¦ãã ã•ã„', 'warning');
    </script>
</body>
</html>