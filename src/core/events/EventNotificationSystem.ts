/**
 * EventNotificationSystem.ts
 * „Ç§„Éô„É≥„ÉàÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†
 * EventStageManager„Åã„ÇâÂàÜÈõ¢„Åï„Çå„ÅüÈÄöÁü•Ê©üËÉΩ
 */

interface NotificationSettings {
    enableNotifications: boolean;
    eventStartNotifications: boolean;
    eventEndNotifications: boolean;
    achievementNotifications: boolean;
    rankingNotifications: boolean;
    maxActiveNotifications: number;
    notificationDuration: number;
    animationDuration: number;
    maxDisplayCount?: number;
}

interface NotificationAction {
    text: string;
    action: () => void;
}

interface NotificationData {
    id: string;
    type: string;
    title: string;
    message: string;
    icon: string;
    priority: 'high' | 'normal' | 'low';
    duration: number;
    actions: NotificationAction[];
    timestamp: number;
    category: string;
    showTime?: number;
    expireTime?: number;
    expiresAt?: number;
}

interface NotificationInput {
    type?: string;
    title?: string;
    message?: string;
    icon?: string;
    priority?: 'high' | 'normal' | 'low';
    duration?: number;
    actions?: NotificationAction[];
    category?: string;
}

interface NotificationHistoryEntry extends NotificationData {
    status: string;
}

interface Event {
    id: string;
    name: string;
    icon?: string;
}

interface EventResults {
    rank: number;
}

interface Achievement {
    name: string;
}

interface RankingData {
    improvement: number;
    currentRank: number;
}

export class EventNotificationSystem {
    private gameEngine: any;
    private notificationQueue: NotificationData[] = [];
    private activeNotifications: Map<string, NotificationData> = new Map();
    private notificationHistory: NotificationHistoryEntry[] = [];
    private notificationCheckInterval: number | null = null;
    private settings: NotificationSettings;

    constructor(gameEngine: any) {
        this.gameEngine = gameEngine;
        
        // ÈÄöÁü•Èñ¢ÈÄ£„ÅÆÁä∂ÊÖã
        this.notificationQueue = [];
        this.activeNotifications = new Map();
        this.notificationHistory = [];
        this.notificationCheckInterval = null;
        
        // ÈÄöÁü•Ë®≠ÂÆö
        this.settings = {
            enableNotifications: true,
            eventStartNotifications: true,
            eventEndNotifications: true,
            achievementNotifications: true,
            rankingNotifications: true,
            maxActiveNotifications: 3,
            notificationDuration: 5000,
            animationDuration: 300
        };

        this.startNotificationChecking();
    }
    
    /**
     * ÈÄöÁü•„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÈñãÂßã
     */
    private startNotificationChecking(): void {
        if (this.notificationCheckInterval) {
            clearInterval(this.notificationCheckInterval);
        }
        
        // 30Áßí„Åî„Å®„Å´ÈÄöÁü•„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        this.notificationCheckInterval = setInterval(() => {
            this.processNotificationQueue();
            this.checkExpiredNotifications();
        }, 30000) as unknown as number;
        
        // ÂàùÂõû„ÉÅ„Çß„ÉÉ„ÇØ
        this.processNotificationQueue();
    }
    
    /**
     * ÈÄöÁü•„ÇíËøΩÂä†
     */
    addNotification(notification: NotificationInput): string | undefined {
        if (!this.settings.enableNotifications) {
            return;
        }

        const fullNotification: NotificationData = {
            id: this.generateNotificationId(),
            type: notification.type || 'info',
            title: notification.title || '',
            message: notification.message || '',
            icon: notification.icon || 'üîî',
            priority: notification.priority || 'normal',
            duration: notification.duration || this.settings.notificationDuration,
            actions: notification.actions || [],
            timestamp: Date.now(),
            category: notification.category || 'general',
            expiresAt: Date.now() + (notification.duration || this.settings.notificationDuration)
        };

        this.notificationQueue.push(fullNotification);
        this.processNotificationQueue();
        
        console.log(`Notification added: ${fullNotification.title}`);
        return fullNotification.id;
    }
    
    /**
     * „Ç§„Éô„É≥„ÉàÈñãÂßãÈÄöÁü•
     */
    notifyEventStart(event: Event): void {
        if (!this.settings.eventStartNotifications) {
            return;
        }

        this.addNotification({
            type: 'event_start',
            title: '„Ç§„Éô„É≥„ÉàÈñãÂßã',
            message: `${event.name}„ÅåÈñãÂßã„Åï„Çå„Åæ„Åó„ÅüÔºÅ`,
            icon: event.icon || 'üéâ',
            priority: 'high',
            category: 'event',
            actions: [{
                text: '„Ç§„Éô„É≥„Éà„ÇíÈñã„Åè',
                action: () => {
                    // „Ç§„Éô„É≥„ÉàÁîªÈù¢„Å∏„ÅÆÈÅ∑Áßª„É≠„Ç∏„ÉÉ„ÇØ
                    console.log(`Opening event: ${event.id}`);
                }
            }]
        });
    }
    
    /**
     * „Ç§„Éô„É≥„ÉàÁµÇ‰∫ÜÈÄöÁü•
     */
    notifyEventEnd(event: Event, results: EventResults): void {
        if (!this.settings.eventEndNotifications) {
            return;
        }

        this.addNotification({
            type: 'event_end',
            title: '„Ç§„Éô„É≥„ÉàÂÆå‰∫Ü',
            message: `${event.name}„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ„É©„É≥„ÇØ: ${results.rank}`,
            icon: 'üèÜ',
            priority: 'high',
            category: 'event'
        });
    }
    
    /**
     * ÂÆüÁ∏æËß£Èô§ÈÄöÁü•
     */
    notifyAchievementUnlock(achievement: Achievement): void {
        if (!this.settings.achievementNotifications) {
            return;
        }

        this.addNotification({
            type: 'achievement',
            title: 'ÂÆüÁ∏æËß£Èô§',
            message: `„Äå${achievement.name}„Äç„ÇíÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅ`,
            icon: 'üèÖ',
            priority: 'high',
            category: 'achievement'
        });
    }
    
    /**
     * „É©„É≥„Ç≠„É≥„Ç∞Êõ¥Êñ∞ÈÄöÁü•
     */
    notifyRankingUpdate(rankingData: RankingData): void {
        if (!this.settings.rankingNotifications) {
            return;
        }

        const improvementText = rankingData.improvement > 0 ? 
            `„É©„É≥„ÇØ„Ç¢„ÉÉ„ÉóÔºÅ ${rankingData.improvement}‰Ωç‰∏äÊòá` :
            rankingData.improvement < 0 ? 
            `${Math.abs(rankingData.improvement)}‰Ωç„ÉÄ„Ç¶„É≥` :
            '„É©„É≥„ÇØ„Å´Â§âÂãï„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì';

        this.addNotification({
            type: 'ranking',
            title: '„É©„É≥„Ç≠„É≥„Ç∞Êõ¥Êñ∞',
            message: `ÁèæÂú®„ÅÆ„É©„É≥„ÇØ: ${rankingData.currentRank}‰Ωç (${improvementText})`,
            icon: 'üìä',
            priority: 'normal',
            category: 'ranking'
        });
    }
    
    /**
     * ÈÄöÁü•„Ç≠„É•„Éº„ÇíÂá¶ÁêÜ
     */
    private processNotificationQueue(): void {
        while (this.notificationQueue.length > 0 && 
               this.activeNotifications.size < this.settings.maxActiveNotifications) {
            const notification = this.notificationQueue.shift()!;
            this.displayNotification(notification);
        }
    }
    
    /**
     * ÈÄöÁü•„ÇíË°®Á§∫
     */
    private displayNotification(notification: NotificationData): void {
        notification.showTime = Date.now();
        this.activeNotifications.set(notification.id, notification);
        
        // Â±•Ê≠¥„Å´ËøΩÂä†
        this.notificationHistory.push({
            ...notification,
            status: 'displayed'
        });
        
        // DOMË¶ÅÁ¥†‰ΩúÊàê„Å®Ë°®Á§∫„É≠„Ç∏„ÉÉ„ÇØ
        this.createNotificationElement(notification);
        
        // Ëá™ÂãïÂâäÈô§„Çø„Ç§„Éû„Éº
        setTimeout(() => {
            this.removeNotification(notification.id);
        }, notification.duration);
        
        console.log(`Notification displayed: ${notification.title}`);
    }
    
    /**
     * ÈÄöÁü•DOMË¶ÅÁ¥†„Çí‰ΩúÊàê
     */
    private createNotificationElement(notification: NotificationData): void {
        // ÈÄöÁü•Ë°®Á§∫„Ç®„É™„Ç¢„ÇíÂèñÂæó„Åæ„Åü„ÅØ‰ΩúÊàê
        let container = document.getElementById('notification-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'notification-container';
            container.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                pointer-events: none;
            `;
            document.body.appendChild(container);
        }

        // ÈÄöÁü•Ë¶ÅÁ¥†„Çí‰ΩúÊàê
        const element = document.createElement('div');
        element.id = `notification-${notification.id}`;
        element.className = `notification notification-${notification.priority}`;
        element.style.cssText = `
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            max-width: 300px;
            pointer-events: auto;
            transform: translateX(100%);
            transition: transform ${this.settings.animationDuration}ms ease-out;
        `;

        // ÂÜÖÂÆπ„ÇíË®≠ÂÆö
        element.innerHTML = `
            <div style="display: flex; align-items: flex-start;">
                <span style="font-size: 20px; margin-right: 8px;">${notification.icon}</span>
                <div style="flex: 1;">
                    <div style="font-weight: bold; margin-bottom: 4px;">${notification.title}</div>
                    <div style="color: #666; font-size: 14px;">${notification.message}</div>
                    ${notification.actions.length > 0 ? this.createActionButtons(notification.actions) : ''}
                </div>
            </div>
        `;

        // Èñâ„Åò„Çã„Éú„Çø„É≥
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = '√ó';
        closeBtn.style.cssText = `
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #999;
        `;
        closeBtn.onclick = () => this.removeNotification(notification.id);
        element.appendChild(closeBtn);

        container.appendChild(element);

        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        requestAnimationFrame(() => {
            element.style.transform = 'translateX(0)';
        });
    }
    
    /**
     * „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥„Çí‰ΩúÊàê
     */
    private createActionButtons(actions: NotificationAction[]): string {
        return `
            <div style="margin-top: 8px;">
                ${actions.map(action => 
                    `<button onclick="(${action.action.toString()})()" 
                             style="padding: 4px 8px; margin-right: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5; cursor: pointer;">
                        ${action.text}
                    </button>`
                ).join('')}
            </div>
        `;
    }
    
    /**
     * ÈÄöÁü•„ÇíÂâäÈô§
     */
    removeNotification(notificationId: string): void {
        const notification = this.activeNotifications.get(notificationId);
        if (!notification) {
            return;
        }

        const element = document.getElementById(`notification-${notificationId}`);
        if (element) {
            element.style.transform = 'translateX(100%)';
            setTimeout(() => {
                element.remove();
            }, this.settings.animationDuration);
        }

        this.activeNotifications.delete(notificationId);
        
        // Â±•Ê≠¥„ÇíÊõ¥Êñ∞
        const historyEntry = this.notificationHistory.find(entry => entry.id === notificationId);
        if (historyEntry) {
            historyEntry.status = 'dismissed';
        }
        
        // Ê¨°„ÅÆÈÄöÁü•„ÇíÂá¶ÁêÜ
        this.processNotificationQueue();
        
        console.log(`Notification removed: ${notificationId}`);
    }
    
    /**
     * ÊúüÈôêÂàá„ÇåÈÄöÁü•„Çí„ÉÅ„Çß„ÉÉ„ÇØ
     */
    private checkExpiredNotifications(): void {
        const now = Date.now();
        
        this.activeNotifications.forEach((notification, id) => {
            if (notification.expiresAt && now > notification.expiresAt) {
                this.removeNotification(id);
            }
        });
    }
    
    /**
     * ÂÖ®„Å¶„ÅÆÈÄöÁü•„Çí„ÇØ„É™„Ç¢
     */
    clearAllNotifications(): void {
        // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™ÈÄöÁü•„ÇíÂâäÈô§
        this.activeNotifications.forEach((_, id) => {
            this.removeNotification(id);
        });
        
        // „Ç≠„É•„Éº„Çí„ÇØ„É™„Ç¢
        this.notificationQueue = [];
        
        console.log('All notifications cleared');
    }
    
    /**
     * ÈÄöÁü•Ë®≠ÂÆö„ÇíÊõ¥Êñ∞
     */
    updateSettings(newSettings: Partial<NotificationSettings>): void {
        this.settings = { ...this.settings, ...newSettings };
        console.log('Notification settings updated');
    }
    
    /**
     * ÈÄöÁü•Â±•Ê≠¥„ÇíÂèñÂæó
     */
    getNotificationHistory(limit?: number): NotificationHistoryEntry[] {
        const history = [...this.notificationHistory].reverse();
        return limit ? history.slice(0, limit) : history;
    }
    
    /**
     * ÈÄöÁü•ID„ÇíÁîüÊàê
     */
    private generateNotificationId(): string {
        return `notification_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }
    
    /**
     * „É™„ÇΩ„Éº„Çπ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
     */
    dispose(): void {
        if (this.notificationCheckInterval) {
            clearInterval(this.notificationCheckInterval);
            this.notificationCheckInterval = null;
        }
        
        this.clearAllNotifications();
        
        // ÈÄöÁü•„Ç≥„É≥„ÉÜ„Éä„ÇíÂâäÈô§
        const container = document.getElementById('notification-container');
        if (container) {
            container.remove();
        }
        
        console.log('EventNotificationSystem disposed');
    }
}