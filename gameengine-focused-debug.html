<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>GameEngine Focused Debug - Issue #113</title>
    <style>
        body {
            margin: 20px;
            font-family: monospace;
            background: #f0f0f0;
        }
        
        #container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
        }
        
        .filter-controls {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .filter-controls label {
            margin-right: 15px;
            font-weight: bold;
        }
        
        .filter-controls input[type="checkbox"] {
            margin-right: 5px;
        }
        
        #log {
            margin-top: 20px;
            background: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            max-height: 600px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-info { color: #0066cc; }
        .log-error { color: #cc0000; font-weight: bold; }
        .log-success { color: #006600; }
        .log-warning { color: #cc6600; }
        .log-critical { color: #800080; font-weight: bold; background: #fff0ff; padding: 2px; }
    </style>
</head>
<body>
    <div id="container">
        <h1>🎯 GameEngine Focused Debug</h1>
        <p>重要なログのみ表示するフィルタリング機能付きデバッグツール</p>
        
        <canvas id="gameCanvas" width="400" height="300" style="border: 2px solid #333; background: #e8f4f8;"></canvas>
        
        <div>
            <button onclick="debugGameEngineConstructor()">🔍 GameEngine DEBUG実行</button>
            <button onclick="clearLog()">🗑️ ログクリア</button>
        </div>
        
        <div class="filter-controls">
            <label><input type="checkbox" id="showErrors" checked> エラー表示</label>
            <label><input type="checkbox" id="showWarnings" checked> 警告表示</label>
            <label><input type="checkbox" id="showCritical" checked> 重要DEBUG表示</label>
            <label><input type="checkbox" id="showInitializer" checked> Initializer関連表示</label>
            <label><input type="checkbox" id="showLoadMethods" checked> loadメソッド表示</label>
            <label><input type="checkbox" id="showSuccessOnly"> 成功ログのみ表示</label>
        </div>
        
        <div id="log"></div>
    </div>

    <script type="module">
        // ===== ログフィルタリング機能 =====
        let allLogs = [];
        
        function log(message, type = 'info', category = 'general') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                message,
                type,
                category,
                raw: `[${timestamp}] ${message}`
            };
            
            allLogs.push(logEntry);
            updateLogDisplay();
            
            // コンソールにも出力（フィルタリングなし）
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function updateLogDisplay() {
            const logElement = document.getElementById('log');
            const filters = {
                showErrors: document.getElementById('showErrors').checked,
                showWarnings: document.getElementById('showWarnings').checked,
                showCritical: document.getElementById('showCritical').checked,
                showInitializer: document.getElementById('showInitializer').checked,
                showLoadMethods: document.getElementById('showLoadMethods').checked,
                showSuccessOnly: document.getElementById('showSuccessOnly').checked
            };
            
            // フィルタリング
            const filteredLogs = allLogs.filter(entry => {
                if (filters.showSuccessOnly && entry.type !== 'success' && entry.type !== 'critical') {
                    return false;
                }
                
                if (entry.type === 'error' && !filters.showErrors) return false;
                if (entry.type === 'warning' && !filters.showWarnings) return false;
                if (entry.type === 'critical' && !filters.showCritical) return false;
                
                if (entry.message.includes('Initializer') && !filters.showInitializer) return false;
                if (entry.message.includes('load') && !filters.showLoadMethods) return false;
                
                return true;
            });
            
            // ログを表示
            logElement.innerHTML = '';
            filteredLogs.forEach(entry => {
                const div = document.createElement('div');
                div.className = `log-${entry.type}`;
                div.innerHTML = `<strong>[${entry.timestamp}]</strong> ${entry.message}`;
                logElement.appendChild(div);
            });
            
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // フィルター変更時の再描画
        document.querySelectorAll('.filter-controls input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateLogDisplay);
        });
        
        window.clearLog = function() {
            allLogs = [];
            updateLogDisplay();
        };
        
        window.debugGameEngineConstructor = async function() {
            allLogs = [];
            log('=== GameEngine重要ログのみデバッグ開始 ===', 'critical', 'debug');
            
            // 重要ログのみをキャプチャするフィルタリング機能付きログハンドラー
            const originalConsoleLog = console.log;
            const originalConsoleError = console.error;
            const originalConsoleWarn = console.warn;
            
            console.log = function(...args) {
                const message = args.join(' ');
                originalConsoleLog.apply(console, args);
                
                // 重要なDEBUGログのみフィルタリング
                if (message.includes('[DEBUG]')) {
                    if (message.includes('GameEngine:') || 
                        message.includes('GameEngineInitializer:') ||
                        message.includes('load') ||
                        message.includes('エラー') ||
                        message.includes('失敗') ||
                        message.includes('null') ||
                        message.includes('undefined')) {
                        
                        let category = 'debug';
                        if (message.includes('load')) category = 'load';
                        if (message.includes('Initializer')) category = 'initializer';
                        
                        log(`🔍 ${message}`, 'critical', category);
                    }
                }
            };
            
            console.error = function(...args) {
                const message = args.join(' ');
                originalConsoleError.apply(console, args);
                log(`💥 ${message}`, 'error', 'error');
            };
            
            console.warn = function(...args) {
                const message = args.join(' ');
                originalConsoleWarn.apply(console, args);
                log(`⚠️ ${message}`, 'warning', 'warning');
            };
            
            try {
                log('GameEngineクラスのインポート中...', 'info');
                const { GameEngine } = await import('./src/core/GameEngine.js');
                log('✅ GameEngineクラスインポート成功', 'success');
                
                log('GameEngineコンストラクター呼び出し開始...', 'critical', 'debug');
                const canvas = document.getElementById('gameCanvas');
                
                // コンストラクター実行
                const gameEngine = new GameEngine(canvas);
                
                log('✅ GameEngineコンストラクター完了', 'success');
                
                // 重要コンポーネントのみチェック
                const criticalComponents = [
                    { name: 'playerData', obj: gameEngine.playerData, hasLoad: gameEngine.playerData && typeof gameEngine.playerData.load === 'function' },
                    { name: 'achievementManager', obj: gameEngine.achievementManager, hasLoad: gameEngine.achievementManager && typeof gameEngine.achievementManager.load === 'function' },
                    { name: 'statisticsManager', obj: gameEngine.statisticsManager, hasLoad: gameEngine.statisticsManager && typeof gameEngine.statisticsManager.load === 'function' },
                    { name: 'eventStageManager', obj: gameEngine.eventStageManager, hasLoad: gameEngine.eventStageManager && typeof gameEngine.eventStageManager.load === 'function' }
                ];
                
                log('=== 重要コンポーネント & loadメソッド確認 ===', 'critical', 'load');
                criticalComponents.forEach(comp => {
                    const status = comp.obj ? '✅ 存在' : '❌ NULL';
                    const loadStatus = comp.hasLoad ? '✅ load()有' : '❌ load()無';
                    log(`${comp.name}: ${status} | ${loadStatus}`, comp.obj && comp.hasLoad ? 'success' : 'error', 'load');
                });
                
                // initializeScenes() 実行の監視
                log('=== initializeScenes() 実行監視中 ===', 'critical', 'initializer');
                log('この後、非同期でInitializerの[DEBUG]ログが表示されます', 'info', 'initializer');
                log('特に「load開始」「load完了」「load失敗」を確認してください', 'warning', 'load');
                
            } catch (error) {
                log(`💥 GameEngineコンストラクターエラー: ${error.message}`, 'error', 'error');
                log(`エラースタック: ${error.stack}`, 'error', 'error');
            } finally {
                // ログ機能を復元（2秒後）
                setTimeout(() => {
                    console.log = originalConsoleLog;
                    console.error = originalConsoleError;
                    console.warn = originalConsoleWarn;
                    
                    log('=== ログキャプチャ完了 ===', 'info');
                    log('フィルターを調整して重要ログのみ確認してください', 'warning');
                }, 5000); // 5秒間キャプチャ
            }
        };
        
        // ===== 初期化 =====
        log('GameEngine重要ログデバッグ準備完了', 'info');
        log('📋 フィルター機能:', 'info');
        log('  • エラー/警告: 赤色・オレンジ色', 'info');
        log('  • 重要DEBUG: 紫色ハイライト', 'info');
        log('  • loadメソッド関連: 専用フィルター', 'info');
        log('  • Initializer関連: 専用フィルター', 'info');
    </script>
</body>
</html>