<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Method Fixes</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
            font-family: Arial, sans-serif;
        }
        
        #gameCanvas {
            border: 2px solid #333;
            background: linear-gradient(135deg, #87CEEB, #E0F6FF);
            display: block;
            margin: 20px auto;
        }
        
        .test-panel {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button.success {
            background: #28a745;
        }
        
        button.error {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <div class="test-panel">
        <h1>üîß Method Fixes Test</h1>
        <p><strong>ÁõÆÁöÑ:</strong> createHealEffect„Å®createDragParticles„É°„ÇΩ„ÉÉ„Éâ„ÅÆ‰øÆÊ≠£Á¢∫Ë™ç</p>
        
        <div class="test-section">
            <h3>Test Results</h3>
            <div id="testResults">
                <div>GameEngine initialization: <span id="initStatus" class="status warning">Not tested</span></div>
                <div>createHealEffect test: <span id="healStatus" class="status warning">Not tested</span></div>
                <div>createDragParticles test: <span id="dragStatus" class="status warning">Not tested</span></div>
                <div>Pink bubble click test: <span id="pinkBubbleStatus" class="status warning">Not tested</span></div>
            </div>
            
            <button onclick="runTests()">Run All Tests</button>
            <button onclick="testHealEffect()">Test Heal Effect Only</button>
            <button onclick="testDragParticles()">Test Drag Particles Only</button>
            <button onclick="spawnPinkBubble()">Spawn Pink Bubble</button>
        </div>
        
        <div class="test-section">
            <h3>Game Info</h3>
            <div id="gameInfo">
                <div>Bubble Count: <span id="bubbleCount">0</span></div>
                <div>Game Running: <span id="gameRunning">false</span></div>
                <div>Current Scene: <span id="currentScene">none</span></div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>Test Log</h3>
            <div id="testLog" class="log-output">Test log will appear here...\n</div>
        </div>
    </div>
    
    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <script type="module">
        import { GameEngine } from './src/core/GameEngine.js';
        
        let gameEngine;
        let testLog = '';
        
        // Log capture
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        function captureLog(level, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg) : arg
            ).join(' ');
            testLog += `[${timestamp}] ${level.toUpperCase()}: ${message}\n`;
            
            // Also call original
            if (level === 'log') originalConsoleLog(...args);
            if (level === 'error') originalConsoleError(...args);
            if (level === 'warn') originalConsoleWarn(...args);
            
            updateLogDisplay();
        }
        
        console.log = (...args) => captureLog('log', ...args);
        console.error = (...args) => captureLog('error', ...args);
        console.warn = (...args) => captureLog('warn', ...args);
        
        function updateLogDisplay() {
            const logElement = document.getElementById('testLog');
            logElement.textContent = testLog;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function setStatus(id, status, text) {
            const element = document.getElementById(id);
            element.className = `status ${status}`;
            element.textContent = text;
        }
        
        function updateGameInfo() {
            if (!gameEngine) return;
            
            try {
                document.getElementById('bubbleCount').textContent = 
                    gameEngine.bubbleManager?.getBubbleCount() || 0;
                document.getElementById('gameRunning').textContent = 
                    gameEngine.isRunning || false;
                document.getElementById('currentScene').textContent = 
                    gameEngine.sceneManager?.currentScene?.constructor?.name || 'none';
            } catch (error) {
                console.error('Error updating game info:', error);
            }
        }
        
        async function initGameEngine() {
            try {
                console.log('=== Initializing GameEngine ===');
                const canvas = document.getElementById('gameCanvas');
                gameEngine = new GameEngine(canvas);
                gameEngine.start();
                
                setStatus('initStatus', 'success', 'Success');
                console.log('GameEngine initialized successfully');
                return true;
            } catch (error) {
                console.error('GameEngine initialization failed:', error);
                setStatus('initStatus', 'error', 'Failed');
                return false;
            }
        }
        
        window.testHealEffect = async function() {
            console.log('=== Testing createHealEffect ===');
            
            if (!gameEngine) {
                console.log('Initializing GameEngine first...');
                if (!(await initGameEngine())) {
                    return;
                }
            }
            
            try {
                // Test the method exists
                if (typeof gameEngine.createHealEffect !== 'function') {
                    throw new Error('createHealEffect method not found');
                }
                
                console.log('Calling createHealEffect(25)...');
                gameEngine.createHealEffect(25);
                
                setStatus('healStatus', 'success', 'Success');
                console.log('createHealEffect test passed!');
                
            } catch (error) {
                console.error('createHealEffect test failed:', error);
                setStatus('healStatus', 'error', 'Failed');
            }
        };
        
        window.testDragParticles = async function() {
            console.log('=== Testing createDragParticles ===');
            
            if (!gameEngine) {
                console.log('Initializing GameEngine first...');
                if (!(await initGameEngine())) {
                    return;
                }
            }
            
            try {
                // Get current scene
                const currentScene = gameEngine.sceneManager?.currentScene;
                if (!currentScene) {
                    throw new Error('No current scene available');
                }
                
                console.log(`Current scene: ${currentScene.constructor.name}`);
                
                // Check if we're in the right scene
                if (currentScene.constructor.name !== 'GameScene') {
                    console.log('Switching to GameScene to test createDragParticles...');
                    
                    // Try to switch to GameScene
                    const switched = gameEngine.sceneManager.switchScene('game');
                    if (!switched) {
                        // If switching fails, test on current scene anyway but expect it might fail
                        console.warn('Could not switch to GameScene, testing on current scene');
                    }
                    
                    // Wait a moment for scene switch
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                const testScene = gameEngine.sceneManager?.currentScene;
                console.log(`Testing on scene: ${testScene?.constructor?.name}`);
                
                // Test the method exists
                if (typeof testScene?.createDragParticles !== 'function') {
                    throw new Error(`createDragParticles method not found on ${testScene?.constructor?.name || 'current scene'}`);
                }
                
                console.log('Calling createDragParticles(400, 300, 15)...');
                testScene.createDragParticles(400, 300, 15);
                
                setStatus('dragStatus', 'success', 'Success');
                console.log('createDragParticles test passed!');
                
            } catch (error) {
                console.error('createDragParticles test failed:', error);
                setStatus('dragStatus', 'error', 'Failed');
            }
        };
        
        window.spawnPinkBubble = async function() {
            console.log('=== Spawning Pink Bubble ===');
            
            if (!gameEngine) {
                console.log('Initializing GameEngine first...');
                if (!(await initGameEngine())) {
                    return;
                }
            }
            
            try {
                if (!gameEngine.bubbleManager) {
                    throw new Error('BubbleManager not available');
                }
                
                console.log('Spawning pink bubble at center...');
                const pinkBubble = gameEngine.bubbleManager.spawnBubble('pink', { x: 400, y: 300 });
                
                if (pinkBubble) {
                    console.log('Pink bubble spawned successfully:', pinkBubble.type);
                    console.log('Click on the pink bubble to test heal effect!');
                    setStatus('pinkBubbleStatus', 'success', 'Spawned - click it!');
                } else {
                    throw new Error('Failed to spawn pink bubble');
                }
                
            } catch (error) {
                console.error('Pink bubble spawn failed:', error);
                setStatus('pinkBubbleStatus', 'error', 'Failed');
            }
        };
        
        window.runTests = async function() {
            console.log('=== Running All Tests ===');
            testLog = ''; // Clear log
            updateLogDisplay();
            
            // Initialize GameEngine
            if (!(await initGameEngine())) {
                return;
            }
            
            // Wait a bit for initialization
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Run tests
            await testHealEffect();
            await testDragParticles();
            await spawnPinkBubble();
            
            console.log('=== All Tests Completed ===');
        };
        
        // Update game info periodically
        setInterval(() => {
            updateGameInfo();
        }, 1000);
        
        console.log('Test page loaded. Click "Run All Tests" to begin.');
    </script>
</body>
</html>