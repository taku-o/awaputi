<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>GameEngineæœ€å°çµ±åˆãƒ†ã‚¹ãƒˆ - Issue #113</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        #testContainer {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #gameCanvas {
            border: 2px solid #333;
            background: #e8f4f8;
        }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .status-ok { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-pending { background: #cce5f0; color: #0c5460; }
        
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        
        #log {
            margin-top: 20px;
            text-align: left;
            background: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-info { color: #0066cc; }
        .log-error { color: #cc0000; }
        .log-success { color: #006600; }
        .log-warning { color: #cc6600; }
    </style>
</head>
<body>
    <div id="testContainer">
        <h1>ğŸ”¬ GameEngineæœ€å°çµ±åˆãƒ†ã‚¹ãƒˆ</h1>
        <p>æ—¢å­˜ã®GameEngineã‚·ã‚¹ãƒ†ãƒ ã‚’æ®µéšçš„ã«ãƒ†ã‚¹ãƒˆ</p>
        
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div id="testStatus">
            <div>
                <span id="status-config" class="status status-pending">ConfigurationManager: å¾…æ©Ÿ</span>
                <span id="status-gameengine" class="status status-pending">GameEngine: å¾…æ©Ÿ</span>
                <span id="status-bubble" class="status status-pending">BubbleManager: å¾…æ©Ÿ</span>
                <span id="status-stage" class="status status-pending">StageManager: å¾…æ©Ÿ</span>
            </div>
            <div>
                <span id="status-game" class="status status-pending">GameLoop: å¾…æ©Ÿ</span>
                <span id="status-spawn" class="status status-pending">BubbleSpawn: å¾…æ©Ÿ</span>
                <span id="status-click" class="status status-pending">ClickHandler: å¾…æ©Ÿ</span>
                <span id="status-score" class="status status-pending">ScoreSystem: å¾…æ©Ÿ</span>
            </div>
        </div>
        
        <div>
            <button onclick="testStep1()">Step 1: åŸºæœ¬åˆæœŸåŒ–</button>
            <button onclick="testStep2()">Step 2: GameEngineä½œæˆ</button>
            <button onclick="testStep3()">Step 3: ã‚¹ãƒ†ãƒ¼ã‚¸è¨­å®š</button>
            <button onclick="testStep4()">Step 4: ã‚²ãƒ¼ãƒ é–‹å§‹</button>
            <button onclick="testStep5()">Step 5: ãƒãƒ–ãƒ«ç”Ÿæˆãƒ†ã‚¹ãƒˆ</button>
            <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        </div>
        
        <div id="log"></div>
    </div>

    <script type="module">
        // ===== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° =====
        let gameEngine = null;
        let testResults = {};
        
        // ===== ãƒ­ã‚°æ©Ÿèƒ½ =====
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const div = document.createElement('div');
            div.className = `log-${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logElement.appendChild(div);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function updateStatus(id, status, text = null) {
            const element = document.getElementById(`status-${id}`);
            if (element) {
                element.className = `status status-${status}`;
                if (text) {
                    element.textContent = text;
                } else {
                    element.textContent = element.textContent.split(':')[0] + ': ' + 
                        (status === 'ok' ? 'æˆåŠŸ' : status === 'error' ? 'ã‚¨ãƒ©ãƒ¼' : status === 'warning' ? 'è­¦å‘Š' : 'å¾…æ©Ÿ');
                }
            }
        }
        
        // ===== ãƒ†ã‚¹ãƒˆé–¢æ•° =====
        window.testStep1 = async function() {
            log('=== Step 1: åŸºæœ¬åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ ===', 'info');
            
            try {
                // ConfigurationManager ãƒ†ã‚¹ãƒˆ
                log('ConfigurationManagerã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...', 'info');
                const { getConfigurationManager } = await import('./src/core/ConfigurationManager.js');
                const configManager = getConfigurationManager();
                
                if (configManager) {
                    log('âœ… ConfigurationManageræ­£å¸¸ã«åˆæœŸåŒ–', 'success');
                    updateStatus('config', 'ok');
                    
                    // åŸºæœ¬è¨­å®šã®ç¢ºèª
                    const targetFPS = configManager.get('performance', 'targetFPS', 60);
                    log(`è¨­å®šç¢ºèª: targetFPS = ${targetFPS}`, 'info');
                    
                    testResults.configManager = true;
                } else {
                    throw new Error('ConfigurationManagerãŒå–å¾—ã§ãã¾ã›ã‚“');
                }
                
            } catch (error) {
                log(`âŒ Step 1 å¤±æ•—: ${error.message}`, 'error');
                updateStatus('config', 'error');
                testResults.configManager = false;
            }
        };
        
        window.testStep2 = async function() {
            log('=== Step 2: GameEngineä½œæˆãƒ†ã‚¹ãƒˆ ===', 'info');
            
            try {
                if (!testResults.configManager) {
                    throw new Error('Step 1ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“');
                }
                
                log('GameEngineã‚¯ãƒ©ã‚¹ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...', 'info');
                const { GameEngine } = await import('./src/core/GameEngine.js');
                
                const canvas = document.getElementById('gameCanvas');
                log('GameEngineã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆä¸­...', 'info');
                
                gameEngine = new GameEngine(canvas);
                log('GameEngineåˆæœŸåŒ–ä¸­...', 'info');
                
                await gameEngine.initialize();
                
                log('âœ… GameEngineæ­£å¸¸ã«åˆæœŸåŒ–', 'success');
                updateStatus('gameengine', 'ok');
                
                // ã‚µãƒ–ã‚·ã‚¹ãƒ†ãƒ ã®ç¢ºèª
                if (gameEngine.bubbleManager) {
                    log('âœ… BubbleManagerçµ±åˆç¢ºèª', 'success');
                    updateStatus('bubble', 'ok');
                } else {
                    log('âš ï¸ BubbleManagerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                    updateStatus('bubble', 'warning');
                }
                
                if (gameEngine.stageManager) {
                    log('âœ… StageManagerçµ±åˆç¢ºèª', 'success');
                    updateStatus('stage', 'ok');
                } else {
                    log('âš ï¸ StageManagerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                    updateStatus('stage', 'warning');
                }
                
                testResults.gameEngine = true;
                
            } catch (error) {
                log(`âŒ Step 2 å¤±æ•—: ${error.message}`, 'error');
                log(`ã‚¹ã‚¿ãƒƒã‚¯: ${error.stack}`, 'error');
                updateStatus('gameengine', 'error');
                testResults.gameEngine = false;
            }
        };
        
        window.testStep3 = async function() {
            log('=== Step 3: ã‚¹ãƒ†ãƒ¼ã‚¸è¨­å®šãƒ†ã‚¹ãƒˆ ===', 'info');
            
            try {
                if (!testResults.gameEngine || !gameEngine) {
                    throw new Error('Step 2ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“');
                }
                
                if (gameEngine.stageManager) {
                    log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ†ãƒ¼ã‚¸(normal)ã‚’é–‹å§‹ä¸­...', 'info');
                    
                    const stageStarted = gameEngine.stageManager.startStage('normal');
                    if (stageStarted) {
                        log('âœ… ã‚¹ãƒ†ãƒ¼ã‚¸è¨­å®šæˆåŠŸ', 'success');
                        updateStatus('stage', 'ok');
                        testResults.stage = true;
                        
                        // BubbleManagerã®stageConfigç¢ºèª
                        if (gameEngine.bubbleManager && gameEngine.bubbleManager.spawner && gameEngine.bubbleManager.spawner.stageConfig) {
                            log('âœ… BubbleManager stageConfigè¨­å®šæ¸ˆã¿', 'success');
                            const config = gameEngine.bubbleManager.spawner.stageConfig;
                            log(`ã‚¹ãƒ†ãƒ¼ã‚¸æƒ…å ±: ${config.name}, ã‚¹ãƒãƒ¼ãƒ³ç‡: ${config.spawnRate}, æœ€å¤§ãƒãƒ–ãƒ«: ${config.maxBubbles}`, 'info');
                        } else {
                            log('âš ï¸ BubbleManager stageConfigãŒæœªè¨­å®š', 'warning');
                        }
                        
                    } else {
                        throw new Error('ã‚¹ãƒ†ãƒ¼ã‚¸ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } else {
                    throw new Error('StageManagerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
            } catch (error) {
                log(`âŒ Step 3 å¤±æ•—: ${error.message}`, 'error');
                updateStatus('stage', 'error');
                testResults.stage = false;
            }
        };
        
        window.testStep4 = async function() {
            log('=== Step 4: ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ†ã‚¹ãƒˆ ===', 'info');
            
            try {
                if (!testResults.stage || !gameEngine) {
                    throw new Error('Step 3ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“');
                }
                
                log('GameSceneã«åˆ‡ã‚Šæ›¿ãˆä¸­...', 'info');
                if (gameEngine.sceneManager) {
                    gameEngine.sceneManager.changeScene('game');
                    log('âœ… GameSceneã«åˆ‡ã‚Šæ›¿ãˆå®Œäº†', 'success');
                }
                
                log('ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—é–‹å§‹ä¸­...', 'info');
                gameEngine.start();
                
                // 2ç§’å¾Œã«çŠ¶æ…‹ç¢ºèª
                setTimeout(() => {
                    if (gameEngine.isRunning) {
                        log('âœ… ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—å‹•ä½œä¸­', 'success');
                        updateStatus('game', 'ok');
                        testResults.gameLoop = true;
                        
                        // FPSç¢ºèª
                        if (gameEngine.performanceMonitor && gameEngine.performanceMonitor.stats) {
                            const fps = gameEngine.performanceMonitor.stats.fps || 0;
                            log(`ç¾åœ¨ã®FPS: ${Math.round(fps)}`, 'info');
                        }
                    } else {
                        log('âš ï¸ ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ãŒåœæ­¢ã—ã¦ã„ã¾ã™', 'warning');
                        updateStatus('game', 'warning');
                        testResults.gameLoop = false;
                    }
                }, 2000);
                
            } catch (error) {
                log(`âŒ Step 4 å¤±æ•—: ${error.message}`, 'error');
                updateStatus('game', 'error');
                testResults.gameLoop = false;
            }
        };
        
        window.testStep5 = async function() {
            log('=== Step 5: ãƒãƒ–ãƒ«ç”Ÿæˆãƒ†ã‚¹ãƒˆ ===', 'info');
            
            try {
                if (!testResults.gameLoop || !gameEngine || !gameEngine.isRunning) {
                    throw new Error('Step 4ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“');
                }
                
                const bubbleManager = gameEngine.bubbleManager;
                if (!bubbleManager) {
                    throw new Error('BubbleManagerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                log('ç¾åœ¨ã®ãƒãƒ–ãƒ«æ•°ç¢ºèª...', 'info');
                const initialBubbleCount = bubbleManager.getBubbleCount();
                log(`åˆæœŸãƒãƒ–ãƒ«æ•°: ${initialBubbleCount}`, 'info');
                
                log('æ‰‹å‹•ãƒãƒ–ãƒ«ç”Ÿæˆãƒ†ã‚¹ãƒˆ...', 'info');
                const bubble = bubbleManager.spawnBubble('normal');
                if (bubble) {
                    log('âœ… æ‰‹å‹•ãƒãƒ–ãƒ«ç”ŸæˆæˆåŠŸ', 'success');
                    updateStatus('spawn', 'ok');
                    
                    const newBubbleCount = bubbleManager.getBubbleCount();
                    log(`ãƒãƒ–ãƒ«æ•°: ${initialBubbleCount} â†’ ${newBubbleCount}`, 'info');
                } else {
                    log('âš ï¸ æ‰‹å‹•ãƒãƒ–ãƒ«ç”Ÿæˆå¤±æ•—', 'warning');
                    updateStatus('spawn', 'warning');
                }
                
                // 5ç§’å¾Œã«è‡ªå‹•ç”Ÿæˆç¢ºèª
                setTimeout(() => {
                    const finalBubbleCount = bubbleManager.getBubbleCount();
                    log(`5ç§’å¾Œã®ãƒãƒ–ãƒ«æ•°: ${finalBubbleCount}`, 'info');
                    
                    if (finalBubbleCount > initialBubbleCount) {
                        log('âœ… ãƒãƒ–ãƒ«è‡ªå‹•ç”Ÿæˆæ©Ÿèƒ½å‹•ä½œä¸­', 'success');
                        updateStatus('spawn', 'ok');
                    } else {
                        log('âš ï¸ ãƒãƒ–ãƒ«è‡ªå‹•ç”ŸæˆãŒå‹•ä½œã—ã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™', 'warning');
                    }
                }, 5000);
                
                // ã‚¯ãƒªãƒƒã‚¯ãƒ†ã‚¹ãƒˆã®æº–å‚™
                setupClickTest();
                
            } catch (error) {
                log(`âŒ Step 5 å¤±æ•—: ${error.message}`, 'error');
                updateStatus('spawn', 'error');
            }
        };
        
        function setupClickTest() {
            log('ã‚¯ãƒªãƒƒã‚¯ãƒ†ã‚¹ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­...', 'info');
            
            const canvas = document.getElementById('gameCanvas');
            canvas.addEventListener('click', (event) => {
                if (!gameEngine || !gameEngine.isRunning) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                
                log(`ã‚¯ãƒªãƒƒã‚¯: (${Math.round(x)}, ${Math.round(y)})`, 'info');
                
                const bubbleManager = gameEngine.bubbleManager;
                const scoreManager = gameEngine.scoreManager;
                
                if (bubbleManager && scoreManager) {
                    const initialScore = scoreManager.getCurrentScore ? scoreManager.getCurrentScore() : 
                                       gameEngine.playerData ? gameEngine.playerData.getScore() : 0;
                    const initialBubbles = bubbleManager.getBubbleCount();
                    
                    // ã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å‘¼ã³å‡ºã—
                    const hit = bubbleManager.handleClick(x, y);
                    
                    if (hit) {
                        log('âœ… ãƒãƒ–ãƒ«ç ´å£ŠæˆåŠŸ', 'success');
                        updateStatus('click', 'ok');
                        
                        const newScore = scoreManager.getCurrentScore ? scoreManager.getCurrentScore() : 
                                       gameEngine.playerData ? gameEngine.playerData.getScore() : 0;
                        const newBubbles = bubbleManager.getBubbleCount();
                        
                        log(`ã‚¹ã‚³ã‚¢: ${initialScore} â†’ ${newScore}`, 'info');
                        log(`ãƒãƒ–ãƒ«æ•°: ${initialBubbles} â†’ ${newBubbles}`, 'info');
                        
                        updateStatus('score', 'ok');
                    } else {
                        log('ç©ºæŒ¯ã‚Š', 'info');
                    }
                }
            });
            
            log('âœ… ã‚¯ãƒªãƒƒã‚¯ãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº† - Canvasã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„', 'success');
        }
        
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        };
        
        // ===== åˆæœŸåŒ– =====
        log('GameEngineæœ€å°çµ±åˆãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†', 'info');
        log('Step 1ã‹ã‚‰é †ç•ªã«å®Ÿè¡Œã—ã¦ãã ã•ã„', 'info');
    </script>
</body>
</html>