<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>GameEngine最小統合テスト - Issue #113</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        #testContainer {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        #gameCanvas {
            border: 2px solid #333;
            background: #e8f4f8;
        }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .status-ok { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-warning { background: #fff3cd; color: #856404; }
        .status-pending { background: #cce5f0; color: #0c5460; }
        
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        
        #log {
            margin-top: 20px;
            text-align: left;
            background: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-info { color: #0066cc; }
        .log-error { color: #cc0000; }
        .log-success { color: #006600; }
        .log-warning { color: #cc6600; }
    </style>
</head>
<body>
    <div id="testContainer">
        <h1>🔬 GameEngine最小統合テスト</h1>
        <p>既存のGameEngineシステムを段階的にテスト</p>
        
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div id="testStatus">
            <div>
                <span id="status-config" class="status status-pending">ConfigurationManager: 待機</span>
                <span id="status-gameengine" class="status status-pending">GameEngine: 待機</span>
                <span id="status-bubble" class="status status-pending">BubbleManager: 待機</span>
                <span id="status-stage" class="status status-pending">StageManager: 待機</span>
            </div>
            <div>
                <span id="status-game" class="status status-pending">GameLoop: 待機</span>
                <span id="status-spawn" class="status status-pending">BubbleSpawn: 待機</span>
                <span id="status-click" class="status status-pending">ClickHandler: 待機</span>
                <span id="status-score" class="status status-pending">ScoreSystem: 待機</span>
            </div>
        </div>
        
        <div>
            <button onclick="testStep1()">Step 1: 基本初期化</button>
            <button onclick="testStep2()">Step 2: GameEngine作成</button>
            <button onclick="testStep3()">Step 3: ステージ設定</button>
            <button onclick="testStep4()">Step 4: ゲーム開始</button>
            <button onclick="testStep5()">Step 5: バブル生成テスト</button>
            <button onclick="clearLog()">ログクリア</button>
        </div>
        
        <div id="log"></div>
    </div>

    <script type="module">
        // ===== グローバル変数 =====
        let gameEngine = null;
        let testResults = {};
        
        // ===== ログ機能 =====
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const div = document.createElement('div');
            div.className = `log-${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logElement.appendChild(div);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function updateStatus(id, status, text = null) {
            const element = document.getElementById(`status-${id}`);
            if (element) {
                element.className = `status status-${status}`;
                if (text) {
                    element.textContent = text;
                } else {
                    element.textContent = element.textContent.split(':')[0] + ': ' + 
                        (status === 'ok' ? '成功' : status === 'error' ? 'エラー' : status === 'warning' ? '警告' : '待機');
                }
            }
        }
        
        // ===== テスト関数 =====
        window.testStep1 = async function() {
            log('=== Step 1: 基本初期化テスト ===', 'info');
            
            try {
                // ConfigurationManager テスト
                log('ConfigurationManagerをインポート中...', 'info');
                const { getConfigurationManager } = await import('./src/core/ConfigurationManager.js');
                const configManager = getConfigurationManager();
                
                if (configManager) {
                    log('✅ ConfigurationManager正常に初期化', 'success');
                    updateStatus('config', 'ok');
                    
                    // 基本設定の確認
                    const targetFPS = configManager.get('performance', 'targetFPS', 60);
                    log(`設定確認: targetFPS = ${targetFPS}`, 'info');
                    
                    testResults.configManager = true;
                } else {
                    throw new Error('ConfigurationManagerが取得できません');
                }
                
            } catch (error) {
                log(`❌ Step 1 失敗: ${error.message}`, 'error');
                updateStatus('config', 'error');
                testResults.configManager = false;
            }
        };
        
        window.testStep2 = async function() {
            log('=== Step 2: GameEngine作成テスト ===', 'info');
            
            try {
                if (!testResults.configManager) {
                    throw new Error('Step 1が完了していません');
                }
                
                log('GameEngineクラスをインポート中...', 'info');
                const { GameEngine } = await import('./src/core/GameEngine.js');
                
                const canvas = document.getElementById('gameCanvas');
                log('GameEngineインスタンス作成中...', 'info');
                
                gameEngine = new GameEngine(canvas);
                log('GameEngine初期化中...', 'info');
                
                await gameEngine.initialize();
                
                log('✅ GameEngine正常に初期化', 'success');
                updateStatus('gameengine', 'ok');
                
                // サブシステムの確認
                if (gameEngine.bubbleManager) {
                    log('✅ BubbleManager統合確認', 'success');
                    updateStatus('bubble', 'ok');
                } else {
                    log('⚠️ BubbleManagerが見つかりません', 'warning');
                    updateStatus('bubble', 'warning');
                }
                
                if (gameEngine.stageManager) {
                    log('✅ StageManager統合確認', 'success');
                    updateStatus('stage', 'ok');
                } else {
                    log('⚠️ StageManagerが見つかりません', 'warning');
                    updateStatus('stage', 'warning');
                }
                
                testResults.gameEngine = true;
                
            } catch (error) {
                log(`❌ Step 2 失敗: ${error.message}`, 'error');
                log(`スタック: ${error.stack}`, 'error');
                updateStatus('gameengine', 'error');
                testResults.gameEngine = false;
            }
        };
        
        window.testStep3 = async function() {
            log('=== Step 3: ステージ設定テスト ===', 'info');
            
            try {
                if (!testResults.gameEngine || !gameEngine) {
                    throw new Error('Step 2が完了していません');
                }
                
                if (gameEngine.stageManager) {
                    log('デフォルトステージ(normal)を開始中...', 'info');
                    
                    const stageStarted = gameEngine.stageManager.startStage('normal');
                    if (stageStarted) {
                        log('✅ ステージ設定成功', 'success');
                        updateStatus('stage', 'ok');
                        testResults.stage = true;
                        
                        // BubbleManagerのstageConfig確認
                        if (gameEngine.bubbleManager && gameEngine.bubbleManager.spawner && gameEngine.bubbleManager.spawner.stageConfig) {
                            log('✅ BubbleManager stageConfig設定済み', 'success');
                            const config = gameEngine.bubbleManager.spawner.stageConfig;
                            log(`ステージ情報: ${config.name}, スポーン率: ${config.spawnRate}, 最大バブル: ${config.maxBubbles}`, 'info');
                        } else {
                            log('⚠️ BubbleManager stageConfigが未設定', 'warning');
                        }
                        
                    } else {
                        throw new Error('ステージの開始に失敗しました');
                    }
                } else {
                    throw new Error('StageManagerが見つかりません');
                }
                
            } catch (error) {
                log(`❌ Step 3 失敗: ${error.message}`, 'error');
                updateStatus('stage', 'error');
                testResults.stage = false;
            }
        };
        
        window.testStep4 = async function() {
            log('=== Step 4: ゲーム開始テスト ===', 'info');
            
            try {
                if (!testResults.stage || !gameEngine) {
                    throw new Error('Step 3が完了していません');
                }
                
                log('GameSceneに切り替え中...', 'info');
                if (gameEngine.sceneManager) {
                    gameEngine.sceneManager.changeScene('game');
                    log('✅ GameSceneに切り替え完了', 'success');
                }
                
                log('ゲームループ開始中...', 'info');
                gameEngine.start();
                
                // 2秒後に状態確認
                setTimeout(() => {
                    if (gameEngine.isRunning) {
                        log('✅ ゲームループ動作中', 'success');
                        updateStatus('game', 'ok');
                        testResults.gameLoop = true;
                        
                        // FPS確認
                        if (gameEngine.performanceMonitor && gameEngine.performanceMonitor.stats) {
                            const fps = gameEngine.performanceMonitor.stats.fps || 0;
                            log(`現在のFPS: ${Math.round(fps)}`, 'info');
                        }
                    } else {
                        log('⚠️ ゲームループが停止しています', 'warning');
                        updateStatus('game', 'warning');
                        testResults.gameLoop = false;
                    }
                }, 2000);
                
            } catch (error) {
                log(`❌ Step 4 失敗: ${error.message}`, 'error');
                updateStatus('game', 'error');
                testResults.gameLoop = false;
            }
        };
        
        window.testStep5 = async function() {
            log('=== Step 5: バブル生成テスト ===', 'info');
            
            try {
                if (!testResults.gameLoop || !gameEngine || !gameEngine.isRunning) {
                    throw new Error('Step 4が完了していません');
                }
                
                const bubbleManager = gameEngine.bubbleManager;
                if (!bubbleManager) {
                    throw new Error('BubbleManagerが見つかりません');
                }
                
                log('現在のバブル数確認...', 'info');
                const initialBubbleCount = bubbleManager.getBubbleCount();
                log(`初期バブル数: ${initialBubbleCount}`, 'info');
                
                log('手動バブル生成テスト...', 'info');
                const bubble = bubbleManager.spawnBubble('normal');
                if (bubble) {
                    log('✅ 手動バブル生成成功', 'success');
                    updateStatus('spawn', 'ok');
                    
                    const newBubbleCount = bubbleManager.getBubbleCount();
                    log(`バブル数: ${initialBubbleCount} → ${newBubbleCount}`, 'info');
                } else {
                    log('⚠️ 手動バブル生成失敗', 'warning');
                    updateStatus('spawn', 'warning');
                }
                
                // 5秒後に自動生成確認
                setTimeout(() => {
                    const finalBubbleCount = bubbleManager.getBubbleCount();
                    log(`5秒後のバブル数: ${finalBubbleCount}`, 'info');
                    
                    if (finalBubbleCount > initialBubbleCount) {
                        log('✅ バブル自動生成機能動作中', 'success');
                        updateStatus('spawn', 'ok');
                    } else {
                        log('⚠️ バブル自動生成が動作していない可能性があります', 'warning');
                    }
                }, 5000);
                
                // クリックテストの準備
                setupClickTest();
                
            } catch (error) {
                log(`❌ Step 5 失敗: ${error.message}`, 'error');
                updateStatus('spawn', 'error');
            }
        };
        
        function setupClickTest() {
            log('クリックテストセットアップ中...', 'info');
            
            const canvas = document.getElementById('gameCanvas');
            canvas.addEventListener('click', (event) => {
                if (!gameEngine || !gameEngine.isRunning) return;
                
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                
                log(`クリック: (${Math.round(x)}, ${Math.round(y)})`, 'info');
                
                const bubbleManager = gameEngine.bubbleManager;
                const scoreManager = gameEngine.scoreManager;
                
                if (bubbleManager && scoreManager) {
                    const initialScore = scoreManager.getCurrentScore ? scoreManager.getCurrentScore() : 
                                       gameEngine.playerData ? gameEngine.playerData.getScore() : 0;
                    const initialBubbles = bubbleManager.getBubbleCount();
                    
                    // クリックハンドラーを呼び出し
                    const hit = bubbleManager.handleClick(x, y);
                    
                    if (hit) {
                        log('✅ バブル破壊成功', 'success');
                        updateStatus('click', 'ok');
                        
                        const newScore = scoreManager.getCurrentScore ? scoreManager.getCurrentScore() : 
                                       gameEngine.playerData ? gameEngine.playerData.getScore() : 0;
                        const newBubbles = bubbleManager.getBubbleCount();
                        
                        log(`スコア: ${initialScore} → ${newScore}`, 'info');
                        log(`バブル数: ${initialBubbles} → ${newBubbles}`, 'info');
                        
                        updateStatus('score', 'ok');
                    } else {
                        log('空振り', 'info');
                    }
                }
            });
            
            log('✅ クリックテスト準備完了 - Canvasをクリックしてください', 'success');
        }
        
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        };
        
        // ===== 初期化 =====
        log('GameEngine最小統合テスト準備完了', 'info');
        log('Step 1から順番に実行してください', 'info');
    </script>
</body>
</html>