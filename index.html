<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Core Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#4CAF50">
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#4CAF50">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#2E7D32">
    <meta name="background-color" content="#ffffff">
    <meta name="description" content="BubblePop - 泡を割って高スコアを目指すアクションゲーム">
    <meta name="keywords" content="ゲーム,泡,アクション,HTML5,Canvas">
    
    <!-- Additional PWA Meta Tags -->
    <meta name="format-detection" content="telephone=no">
    <meta name="HandheldFriendly" content="true">
    <meta name="MobileOptimized" content="width">
    <meta name="orientation" content="portrait-primary">
    <meta name="screen-orientation" content="portrait">
    <meta name="full-screen" content="yes">
    <meta name="browsermode" content="application">
    
    <!-- Security and Privacy -->
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'self'; font-src 'self'; worker-src 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    
    <!-- Performance Hints -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    
    <!-- SEO Meta Tags will be dynamically injected by SEOMetaManager -->
    <div id="seo-meta-injection-point"></div>
    
    <!-- Structured Data will be dynamically injected by StructuredDataEngine -->
    <div id="structured-data-injection-point"></div>
    <title>BubblePop - 泡割りゲーム</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- PWA関連メタタグ -->
    <meta name="application-name" content="BubblePop">
    <meta name="msapplication-TileColor" content="#4CAF50">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- Apple PWA メタタグ -->
    <meta name="apple-mobile-web-app-title" content="BubblePop">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="apple-mobile-web-app-orientations" content="portrait">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
    <link rel="apple-touch-icon" href="/assets/icons/icon-192x192.png">
    
    <!-- Apple Splash Screens -->
    <link rel="apple-touch-startup-image" href="/assets/splash-screens/apple-splash-1024x1366.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/assets/splash-screens/apple-splash-834x1194.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/assets/splash-screens/apple-splash-768x1024.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/assets/splash-screens/apple-splash-375x812.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/assets/splash-screens/apple-splash-414x896.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/assets/splash-screens/apple-splash-375x667.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/assets/splash-screens/apple-splash-320x568.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    
    <!-- Latest iPhone Models -->
    <link rel="apple-touch-startup-image" href="/assets/splash-screens/apple-splash-390x844.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/assets/splash-screens/apple-splash-393x852.png" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="/assets/splash-screens/apple-splash-430x932.png" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    
    <!-- Additional Apple Device Support -->
    <link rel="apple-touch-startup-image" href="/assets/splash-screens/apple-splash-896x414.png" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="/assets/splash-screens/apple-splash-812x375.png" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="/assets/splash-screens/apple-splash-1366x1024.png" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="/assets/splash-screens/apple-splash-1194x834.png" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="/assets/splash-screens/apple-splash-1024x768.png" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    
    <!-- Latest iPhone Models Landscape -->
    <link rel="apple-touch-startup-image" href="/assets/splash-screens/apple-splash-844x390.png" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="/assets/splash-screens/apple-splash-852x393.png" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="/assets/splash-screens/apple-splash-932x430.png" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    
    <!-- Microsoft PWA メタタグ -->
    <meta name="msapplication-starturl" content="/">
    <meta name="msapplication-tooltip" content="BubblePop - 泡割りゲーム">
    <meta name="msapplication-navbutton-color" content="#4CAF50">
    <meta name="msapplication-window" content="width=1024;height=768">
    <meta name="msapplication-task" content="name=ゲーム開始;action-uri=/;icon-uri=/assets/icons/favicon-32x32.png">
    <meta name="msapplication-task" content="name=統計;action-uri=/?action=stats;icon-uri=/assets/icons/favicon-32x32.png">
    <meta name="msapplication-allowDomainApiCalls" content="true">
    <meta name="msapplication-allowDomainMetaTags" content="true">
    
    <!-- Windows 8/10 Tiles -->
    <meta name="msapplication-square70x70logo" content="/assets/icons/mstile-70x70.png">
    <meta name="msapplication-square150x150logo" content="/assets/icons/mstile-150x150.png">
    <meta name="msapplication-wide310x150logo" content="/assets/icons/mstile-310x150.png">
    <meta name="msapplication-square310x310logo" content="/assets/icons/mstile-310x310.png">
    
    <!-- Favicon and Icons -->
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="shortcut icon" href="/favicon.ico">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#4CAF50">
    
    <!-- Additional PWA Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/assets/icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/assets/icons/icon-512x512.png">
    <link rel="stylesheet" href="src/styles/accessibility.css">
    <style>
        /* リセットCSS */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            min-height: -webkit-fill-available; /* iOS Safari対応 */
            position: relative;
        }
        
        /* ゲームコンテナ */
        #gameContainer {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
            max-width: 100vw;
            max-height: 100vh;
        }
        
        /* Canvas スタイル */
        #gameCanvas {
            border: 2px solid #fff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            background: #000;
            display: block;
            max-width: 100%;
            max-height: 100%;
            
            /* タッチ操作の最適化 */
            touch-action: none;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            
            /* ハードウェアアクセラレーション */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            will-change: transform;
        }
        
        /* UI オーバーレイ */
        #gameUI {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 18px;
            z-index: 10;
            pointer-events: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            font-weight: bold;
            line-height: 1.4;
        }
        
        #gameUI > div {
            margin-bottom: 5px;
            background: rgba(0,0,0,0.3);
            padding: 4px 8px;
            border-radius: 4px;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        
        /* レスポンシブ対応 */
        @media screen and (max-width: 768px) {
            body {
                padding: 0;
            }
            
            #gameCanvas {
                border-radius: 5px;
                border-width: 1px;
            }
            
            #gameUI {
                font-size: 14px;
                top: 5px;
                left: 5px;
            }
        }
        
        @media screen and (max-width: 480px) {
            #gameUI {
                font-size: 12px;
                top: 2px;
                left: 2px;
            }
            
            #gameUI > div {
                padding: 2px 6px;
                margin-bottom: 3px;
            }
        }
        
        /* 横向き対応 */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            #gameUI {
                font-size: 12px;
                top: 2px;
                left: 2px;
            }
        }
        
        /* 高DPI対応 */
        @media screen and (-webkit-min-device-pixel-ratio: 2),
               screen and (min-resolution: 192dpi) {
            #gameCanvas {
                image-rendering: -webkit-optimize-contrast;
                image-rendering: crisp-edges;
            }
        }
        
        /* ダークモード対応 */
        @media (prefers-color-scheme: dark) {
            #gameUI {
                color: #f0f0f0;
            }
        }
        
        /* フルスクリーン対応 */
        #gameCanvas:fullscreen {
            border: none;
            border-radius: 0;
        }
        
        #gameCanvas:-webkit-full-screen {
            border: none;
            border-radius: 0;
        }
        
        #gameCanvas:-moz-full-screen {
            border: none;
            border-radius: 0;
        }
        
        /* ローディング画面 */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            font-size: 24px;
            text-align: center;
        }
        
        #loadingScreen.hidden {
            display: none;
        }
        
        /* エラー画面 */
        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 2000;
            max-width: 90%;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        
        /* ブラウザ固有の調整 */
        
        /* Safari 固有 */
        @supports (-webkit-appearance: none) {
            body {
                -webkit-overflow-scrolling: touch;
            }
            
            #gameCanvas {
                -webkit-backface-visibility: hidden;
                backface-visibility: hidden;
            }
        }
        
        /* Firefox 固有 */
        @-moz-document url-prefix() {
            #gameCanvas {
                image-rendering: -moz-crisp-edges;
            }
        }
        
        /* Edge/IE 固有 */
        @supports (-ms-ime-align: auto) {
            #gameCanvas {
                -ms-interpolation-mode: nearest-neighbor;
            }
        }
        
        /* アクセシビリティ */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* 印刷対応 */
        @media print {
            body {
                background: white;
            }
            
            #gameCanvas {
                border: 1px solid black;
            }
        }
    </style>
</head>
<body>
    <!-- ローディング画面 -->
    <div id="loadingScreen" role="status" aria-live="polite" aria-label="ゲーム読み込み中">
        <div>
            <div>BubblePop</div>
            <div style="font-size: 16px; margin-top: 10px;">読み込み中...</div>
            <div class="loading-spinner" aria-hidden="true"></div>
        </div>
    </div>
    
    <!-- スクリーンリーダー用の説明 -->
    <div class="screen-reader-only">
        <h1>BubblePop - 泡割りゲーム</h1>
        <p>画面に現れる泡をクリックまたはタップして割り、高スコアを目指すアクションゲームです。</p>
        <p>キーボードショートカット: スペースキーで一時停止、Escキーでメニュー、Fキーでフルスクリーン</p>
    </div>
    
    <!-- ゲームコンテナ -->
    <div id="gameContainer" role="main">
        <canvas id="gameCanvas" 
                width="800" 
                height="600" 
                role="img" 
                aria-label="ゲーム画面"
                tabindex="0"
                aria-describedby="gameInstructions"></canvas>
        
        <!-- ゲーム状態表示 -->
        <div id="gameUI" role="status" aria-live="polite" aria-label="ゲーム状態">
            <div aria-label="現在のスコア">スコア: <span id="score">0</span></div>
            <div aria-label="残りHP">HP: <span id="hp">100</span></div>
            <div aria-label="残り時間">時間: <span id="time">5:00</span></div>
        </div>
        
        <!-- ゲーム説明（スクリーンリーダー用） -->
        <div id="gameInstructions" class="screen-reader-only">
            <p>泡をクリックまたはタップして割ってください。ドラッグで泡を吹き飛ばすこともできます。</p>
            <p>ピンクの泡はHPを回復し、毒の泡はダメージを与えます。</p>
            <p>時間内にできるだけ多くの泡を割って高スコアを目指しましょう。</p>
        </div>
    </div>
    
    <!-- キーボードナビゲーション用のフォーカス表示 -->
    <div id="focusIndicator" class="screen-reader-only" aria-live="polite"></div>
    
    <script type="module">
        // SEO システム初期化
        import { SEOMetaManager } from './src/seo/SEOMetaManager.js';
        import { StructuredDataEngine } from './src/seo/StructuredDataEngine.js';
        import { seoLogger } from './src/seo/SEOLogger.js';
        import { seoErrorHandler } from './src/seo/SEOErrorHandler.js';
        
        // PWA初期化スクリプト
        import { getPWAManager } from './src/core/PWAManager.js';
        
        // SEOシステムの初期化
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                seoLogger.info('SEO system initialization started');
                
                // SEOMetaManagerの初期化
                const seoMetaManager = new SEOMetaManager();
                
                // 動的メタタグの生成と注入
                const metaInjectionPoint = document.getElementById('seo-meta-injection-point');
                if (metaInjectionPoint) {
                    try {
                        const metaTags = await seoMetaManager.generateDynamicMetaTags();
                        metaInjectionPoint.innerHTML = metaTags;
                        seoLogger.info('Dynamic meta tags injected successfully');
                    } catch (error) {
                        seoLogger.error('Failed to inject dynamic meta tags', error);
                        // フォールバック: 基本的なメタタグを手動で追加
                        metaInjectionPoint.innerHTML = `
                            <!-- Basic SEO Meta Tags (Fallback) -->
                            <meta name="author" content="BubblePop Game Team">
                            <meta name="robots" content="index, follow">
                            <meta name="rating" content="general">
                            <meta property="og:type" content="website">
                            <meta property="og:title" content="BubblePop - 泡割りゲーム">
                            <meta property="og:description" content="HTML5 Canvas を使用したバブルポップゲーム">
                            <meta name="twitter:card" content="summary_large_image">
                            <meta name="twitter:title" content="BubblePop - 泡割りゲーム">
                        `;
                    }
                }
                
                // StructuredDataEngineの初期化
                const structuredDataEngine = new StructuredDataEngine();
                
                // 構造化データの生成と注入
                const structuredDataInjectionPoint = document.getElementById('structured-data-injection-point');
                if (structuredDataInjectionPoint) {
                    try {
                        const structuredData = await structuredDataEngine.generateVideoGameSchema();
                        const scriptTag = document.createElement('script');
                        scriptTag.type = 'application/ld+json';
                        scriptTag.textContent = JSON.stringify(structuredData, null, 2);
                        structuredDataInjectionPoint.appendChild(scriptTag);
                        seoLogger.info('Structured data injected successfully');
                    } catch (error) {
                        seoLogger.error('Failed to inject structured data', error);
                        // フォールバック: 基本的な構造化データを手動で追加
                        const fallbackScript = document.createElement('script');
                        fallbackScript.type = 'application/ld+json';
                        fallbackScript.textContent = JSON.stringify({
                            "@context": "https://schema.org",
                            "@type": "VideoGame",
                            "name": "BubblePop",
                            "description": "HTML5 Canvas を使用したバブルポップゲーム",
                            "genre": ["Action", "Casual"],
                            "applicationCategory": "Game",
                            "operatingSystem": "Web Browser",
                            "isAccessibleForFree": true
                        }, null, 2);
                        structuredDataInjectionPoint.appendChild(fallbackScript);
                    }
                }
                
                // グローバルにアクセス可能にする
                window.seoMetaManager = seoMetaManager;
                window.structuredDataEngine = structuredDataEngine;
                
                seoLogger.info('SEO system initialization completed');
                
            } catch (error) {
                seoErrorHandler.handle(error, 'seoSystemInit');
            }
        });
        
        // PWA機能の初期化
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    console.log('[PWA] PWA機能を初期化中...');
                    
                    // PWAManagerを初期化
                    const pwaManager = getPWAManager();
                    await pwaManager.initialize();
                    
                    console.log('[PWA] PWA機能初期化完了');
                    
                    // グローバルにアクセス可能にする
                    window.pwaManager = pwaManager;
                    
                } catch (error) {
                    console.error('[PWA] PWA初期化エラー:', error);
                }
            });
        } else {
            console.log('[PWA] Service Workerはサポートされていません');
        }
        
        // PWA関連のUIイベント処理
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('[PWA] インストールプロンプト準備完了');
        });
        
        window.addEventListener('appinstalled', (e) => {
            console.log('[PWA] アプリがインストールされました');
        });
        
        // オンライン/オフライン状態の監視
        window.addEventListener('online', () => {
            console.log('[PWA] オンライン状態に復帰');
        });
        
        window.addEventListener('offline', () => {
            console.log('[PWA] オフライン状態に移行');
        });
    </script>
    <script type="module" src="src/main.js"></script>
</body>
</html>