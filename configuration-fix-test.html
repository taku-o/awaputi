<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConfigurationManager バブル設定修正テスト</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: white;
            font-family: monospace;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
        }
        
        h1 { color: #f39c12; text-align: center; }
        h2 { color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .success { background: #27ae60; color: white; }
        .error { background: #e74c3c; color: white; }
        .warning { background: #f39c12; color: white; }
        .info { background: #3498db; color: white; }
        
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover { background: #2980b9; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        canvas {
            border: 2px solid #f39c12;
            background: #16213e;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 ConfigurationManager バブル設定修正テスト</h1>
        <div class="status info">大量設定キー不足エラー修正テスト</div>
        
        <div class="section">
            <h2>修正内容</h2>
            <div class="status success">✅ バブル設定デフォルト値21種類追加</div>
            <div class="status success">✅ 警告ログレート制限機能実装</div>
            <div class="status success">✅ ConfigurationManager最適化完了</div>
        </div>
        
        <div class="section">
            <h2>テスト実行</h2>
            <div class="grid">
                <button onclick="testBubbleConfigs()">バブル設定値テスト</button>
                <button onclick="testWarningRateLimit()">警告レート制限テスト</button>
                <button onclick="testGameEngineWithConfig()">GameEngine統合テスト</button>
                <button onclick="runStressTest()">設定アクセスストレステスト</button>
                <button onclick="clearLog()">ログクリア</button>
            </div>
        </div>
        
        <div class="section">
            <h2>ゲーム動作テスト</h2>
            <canvas id="gameCanvas" width="400" height="300"></canvas>
            <button onclick="startMiniGame()">ミニゲーム開始</button>
            <button onclick="stopMiniGame()">停止</button>
        </div>
        
        <div class="section">
            <h2>テストログ</h2>
            <div id="log" class="log">ConfigurationManager修正テスト準備完了
各テストボタンをクリックして動作確認してください</div>
        </div>
    </div>

    <script>
        const logDiv = document.getElementById('log');
        let miniGameRunning = false;
        let gameLoop = null;
        let testGameEngine = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'success' ? '✅' : type === 'warning' ? '⚠️' : 'ℹ️';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            logDiv.textContent = 'ログクリア完了\n';
        }

        // バブル設定値テスト
        async function testBubbleConfigs() {
            log('=== バブル設定値テスト開始 ===');
            
            try {
                // ConfigurationManagerを動的インポート
                const configModule = await import('./src/core/ConfigurationManager.js');
                const configManager = configModule.getConfigurationManager();
                
                log('✓ ConfigurationManager読み込み成功', 'success');
                
                // テスト対象のバブル種類
                const bubbleTypes = [
                    'normal', 'stone', 'iron', 'diamond', 'boss',
                    'pink', 'poison', 'spiky', 'rainbow', 'clock',
                    'score', 'electric', 'escaping', 'cracked',
                    'golden', 'frozen', 'magnetic', 'explosive',
                    'phantom', 'multiplier'
                ];
                
                const configKeys = ['health', 'score', 'color', 'size', 'maxAge'];
                
                let successCount = 0;
                let totalTests = bubbleTypes.length * configKeys.length;
                
                log(`${bubbleTypes.length}種類のバブル設定をテスト中...`);
                
                for (const bubbleType of bubbleTypes) {
                    let bubbleSuccess = 0;
                    
                    for (const configKey of configKeys) {
                        const fullKey = `bubbles.${bubbleType}.${configKey}`;
                        
                        try {
                            const value = configManager.get('game', fullKey);
                            
                            if (value !== null && value !== undefined) {
                                successCount++;
                                bubbleSuccess++;
                            } else {
                                log(`⚠️ ${fullKey}: 設定値がnull/undefined`, 'warning');
                            }
                        } catch (error) {
                            log(`❌ ${fullKey}: エラー - ${error.message}`, 'error');
                        }
                    }
                    
                    if (bubbleSuccess === configKeys.length) {
                        log(`✓ ${bubbleType}バブル: 全設定OK (${bubbleSuccess}/${configKeys.length})`, 'success');
                    } else {
                        log(`⚠️ ${bubbleType}バブル: 一部設定不足 (${bubbleSuccess}/${configKeys.length})`, 'warning');
                    }
                }
                
                const successRate = Math.round((successCount / totalTests) * 100);
                
                if (successRate >= 95) {
                    log(`🎉 バブル設定テスト成功: ${successCount}/${totalTests} (${successRate}%)`, 'success');
                } else {
                    log(`⚠️ バブル設定テスト: 改善が必要 ${successCount}/${totalTests} (${successRate}%)`, 'warning');
                }
                
            } catch (error) {
                log(`❌ バブル設定テストエラー: ${error.message}`, 'error');
                console.error('詳細エラー:', error);
            }
        }

        // 警告レート制限テスト
        async function testWarningRateLimit() {
            log('=== 警告レート制限テスト開始 ===');
            
            try {
                const configModule = await import('./src/core/ConfigurationManager.js');
                const configManager = configModule.getConfigurationManager();
                
                log('存在しない設定キーを10回連続で取得...');
                
                // 警告ログをカウント
                let warningCount = 0;
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && args[0].includes('[ConfigurationManager]')) {
                        warningCount++;
                    }
                    originalWarn.apply(console, args);
                };
                
                // 同じ存在しない設定キーを短時間で複数回アクセス
                for (let i = 0; i < 10; i++) {
                    configManager.get('game', 'bubbles.nonexistent.test');
                }
                
                // console.warn を元に戻す
                console.warn = originalWarn;
                
                if (warningCount <= 1) {
                    log(`✅ 警告レート制限成功: 10回アクセス → ${warningCount}回警告`, 'success');
                } else {
                    log(`⚠️ 警告レート制限不完全: 10回アクセス → ${warningCount}回警告`, 'warning');
                }
                
            } catch (error) {
                log(`❌ 警告レート制限テストエラー: ${error.message}`, 'error');
            }
        }

        // GameEngine統合テスト
        async function testGameEngineWithConfig() {
            log('=== GameEngine統合テスト開始 ===');
            
            try {
                // Canvas要素を用意
                const canvas = document.getElementById('gameCanvas');
                const ctx = canvas.getContext('2d');
                
                log('✓ Canvas準備完了');
                
                // GameEngineを動的インポート・初期化
                const gameEngineModule = await import('./src/core/GameEngine.js');
                testGameEngine = new gameEngineModule.GameEngine(canvas);
                
                log('✓ GameEngine初期化成功', 'success');
                
                // 設定キー不足エラーの監視
                let configErrorCount = 0;
                const originalError = console.error;
                const originalWarn = console.warn;
                
                const errorWatcher = function(...args) {
                    const message = args.join(' ');
                    if (message.includes('設定キーが存在しません') || message.includes('ConfigurationManager')) {
                        configErrorCount++;
                    }
                    originalError.apply(console, args);
                };
                
                const warnWatcher = function(...args) {
                    const message = args.join(' ');
                    if (message.includes('設定キーが存在しません') || message.includes('ConfigurationManager')) {
                        configErrorCount++;
                    }
                    originalWarn.apply(console, args);
                };
                
                console.error = errorWatcher;
                console.warn = warnWatcher;
                
                log('GameEngine開始中... (5秒間エラー監視)');
                testGameEngine.start();
                
                // 5秒後にエラーカウント確認
                setTimeout(() => {
                    console.error = originalError;
                    console.warn = originalWarn;
                    
                    if (configErrorCount === 0) {
                        log('🎉 GameEngine統合テスト成功: 設定エラー0件', 'success');
                    } else if (configErrorCount < 5) {
                        log(`⚠️ GameEngine統合テスト: 軽微な設定エラー ${configErrorCount}件`, 'warning');
                    } else {
                        log(`❌ GameEngine統合テスト: 多数の設定エラー ${configErrorCount}件`, 'error');
                    }
                    
                    testGameEngine.stop();
                }, 5000);
                
            } catch (error) {
                log(`❌ GameEngine統合テストエラー: ${error.message}`, 'error');
                console.error('詳細エラー:', error);
            }
        }

        // ストレステスト
        async function runStressTest() {
            log('=== 設定アクセスストレステスト開始 ===');
            
            try {
                const configModule = await import('./src/core/ConfigurationManager.js');
                const configManager = configModule.getConfigurationManager();
                
                const startTime = performance.now();
                const accessCount = 1000;
                
                log(`${accessCount}回の設定アクセスを実行中...`);
                
                // 様々な設定キーに大量アクセス
                for (let i = 0; i < accessCount; i++) {
                    const bubbleType = ['normal', 'stone', 'boss', 'pink', 'poison'][i % 5];
                    const configKey = ['health', 'score', 'color', 'size'][i % 4];
                    configManager.get('game', `bubbles.${bubbleType}.${configKey}`);
                }
                
                const endTime = performance.now();
                const duration = endTime - startTime;
                const avgTime = duration / accessCount;
                
                log(`✅ ストレステスト完了: ${accessCount}回 / ${duration.toFixed(2)}ms`, 'success');
                log(`✅ 平均アクセス時間: ${avgTime.toFixed(4)}ms`, 'success');
                
                if (avgTime < 0.1) {
                    log('🚀 パフォーマンス: 優秀', 'success');
                } else if (avgTime < 0.5) {
                    log('👍 パフォーマンス: 良好', 'success');
                } else {
                    log('⚠️ パフォーマンス: 改善の余地あり', 'warning');
                }
                
            } catch (error) {
                log(`❌ ストレステストエラー: ${error.message}`, 'error');
            }
        }

        // ミニゲーム開始
        async function startMiniGame() {
            if (miniGameRunning) return;
            
            log('=== ミニゲーム開始 ===');
            
            try {
                const canvas = document.getElementById('gameCanvas');
                const ctx = canvas.getContext('2d');
                
                miniGameRunning = true;
                
                // シンプルなゲームループで設定アクセステスト
                const configModule = await import('./src/core/ConfigurationManager.js');
                const configManager = configModule.getConfigurationManager();
                
                let frame = 0;
                let lastErrorCount = 0;
                
                gameLoop = setInterval(() => {
                    // Canvas クリア
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // 背景描画
                    ctx.fillStyle = '#16213e';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // フレームカウンター
                    frame++;
                    
                    // 毎フレーム設定アクセス（実際のゲームと同様）
                    const bubbleTypes = ['normal', 'stone', 'boss', 'pink'];
                    for (const bubbleType of bubbleTypes) {
                        configManager.get('game', `bubbles.${bubbleType}.health`);
                        configManager.get('game', `bubbles.${bubbleType}.score`);
                        configManager.get('game', `bubbles.${bubbleType}.color`);
                    }
                    
                    // 動的な円を描画
                    const centerX = canvas.width / 2;
                    const centerY = canvas.height / 2;
                    const radius = 30 + Math.sin(frame * 0.1) * 10;
                    
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                    ctx.fillStyle = `hsl(${frame * 2 % 360}, 50%, 50%)`;
                    ctx.fill();
                    
                    // フレームカウンター表示
                    ctx.fillStyle = 'white';
                    ctx.font = '16px monospace';
                    ctx.fillText(`Frame: ${frame}`, 10, 25);
                    ctx.fillText('設定アクセステスト中...', 10, 45);
                    
                    // 60フレーム毎にログ確認
                    if (frame % 60 === 0) {
                        // エラーカウントのチェック（省略）
                        log(`✓ ${frame}フレーム経過 - 設定アクセス正常`, frame % 300 === 0 ? 'success' : 'info');
                    }
                    
                }, 16); // ~60FPS
                
                log('✅ ミニゲーム開始 - 設定アクセス負荷テスト実行中', 'success');
                
            } catch (error) {
                log(`❌ ミニゲーム開始エラー: ${error.message}`, 'error');
                miniGameRunning = false;
            }
        }

        // ミニゲーム停止
        function stopMiniGame() {
            if (!miniGameRunning) return;
            
            miniGameRunning = false;
            if (gameLoop) {
                clearInterval(gameLoop);
                gameLoop = null;
            }
            
            // Canvas クリア
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#16213e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = 'white';
            ctx.font = '20px monospace';
            ctx.textAlign = 'center';
            ctx.fillText('ミニゲーム停止', canvas.width / 2, canvas.height / 2);
            ctx.textAlign = 'left';
            
            log('✅ ミニゲーム停止完了', 'success');
        }

        // グローバル関数として公開
        window.testBubbleConfigs = testBubbleConfigs;
        window.testWarningRateLimit = testWarningRateLimit;
        window.testGameEngineWithConfig = testGameEngineWithConfig;
        window.runStressTest = runStressTest;
        window.startMiniGame = startMiniGame;
        window.stopMiniGame = stopMiniGame;
        window.clearLog = clearLog;

        // 初期化メッセージ
        log('ConfigurationManager バブル設定修正テスト準備完了');
        log('各テストボタンをクリックして動作を確認してください');
    </script>
</body>
</html>