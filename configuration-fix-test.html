<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConfigurationManager ãƒãƒ–ãƒ«è¨­å®šä¿®æ­£ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: white;
            font-family: monospace;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: #16213e;
            padding: 20px;
            border-radius: 10px;
        }
        
        h1 { color: #f39c12; text-align: center; }
        h2 { color: #3498db; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .success { background: #27ae60; color: white; }
        .error { background: #e74c3c; color: white; }
        .warning { background: #f39c12; color: white; }
        .info { background: #3498db; color: white; }
        
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover { background: #2980b9; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        canvas {
            border: 2px solid #f39c12;
            background: #16213e;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ ConfigurationManager ãƒãƒ–ãƒ«è¨­å®šä¿®æ­£ãƒ†ã‚¹ãƒˆ</h1>
        <div class="status info">å¤§é‡è¨­å®šã‚­ãƒ¼ä¸è¶³ã‚¨ãƒ©ãƒ¼ä¿®æ­£ãƒ†ã‚¹ãƒˆ</div>
        
        <div class="section">
            <h2>ä¿®æ­£å†…å®¹</h2>
            <div class="status success">âœ… ãƒãƒ–ãƒ«è¨­å®šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤21ç¨®é¡è¿½åŠ </div>
            <div class="status success">âœ… è­¦å‘Šãƒ­ã‚°ãƒ¬ãƒ¼ãƒˆåˆ¶é™æ©Ÿèƒ½å®Ÿè£…</div>
            <div class="status success">âœ… ConfigurationManageræœ€é©åŒ–å®Œäº†</div>
        </div>
        
        <div class="section">
            <h2>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h2>
            <div class="grid">
                <button onclick="testBubbleConfigs()">ãƒãƒ–ãƒ«è¨­å®šå€¤ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="testWarningRateLimit()">è­¦å‘Šãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="testGameEngineWithConfig()">GameEngineçµ±åˆãƒ†ã‚¹ãƒˆ</button>
                <button onclick="runStressTest()">è¨­å®šã‚¢ã‚¯ã‚»ã‚¹ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            </div>
        </div>
        
        <div class="section">
            <h2>ã‚²ãƒ¼ãƒ å‹•ä½œãƒ†ã‚¹ãƒˆ</h2>
            <canvas id="gameCanvas" width="400" height="300"></canvas>
            <button onclick="startMiniGame()">ãƒŸãƒ‹ã‚²ãƒ¼ãƒ é–‹å§‹</button>
            <button onclick="stopMiniGame()">åœæ­¢</button>
        </div>
        
        <div class="section">
            <h2>ãƒ†ã‚¹ãƒˆãƒ­ã‚°</h2>
            <div id="log" class="log">ConfigurationManagerä¿®æ­£ãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†
å„ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å‹•ä½œç¢ºèªã—ã¦ãã ã•ã„</div>
        </div>
    </div>

    <script>
        const logDiv = document.getElementById('log');
        let miniGameRunning = false;
        let gameLoop = null;
        let testGameEngine = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            logDiv.textContent = 'ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Œäº†\n';
        }

        // ãƒãƒ–ãƒ«è¨­å®šå€¤ãƒ†ã‚¹ãƒˆ
        async function testBubbleConfigs() {
            log('=== ãƒãƒ–ãƒ«è¨­å®šå€¤ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            try {
                // ConfigurationManagerã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                const configModule = await import('./src/core/ConfigurationManager.js');
                const configManager = configModule.getConfigurationManager();
                
                log('âœ“ ConfigurationManagerèª­ã¿è¾¼ã¿æˆåŠŸ', 'success');
                
                // ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ãƒãƒ–ãƒ«ç¨®é¡
                const bubbleTypes = [
                    'normal', 'stone', 'iron', 'diamond', 'boss',
                    'pink', 'poison', 'spiky', 'rainbow', 'clock',
                    'score', 'electric', 'escaping', 'cracked',
                    'golden', 'frozen', 'magnetic', 'explosive',
                    'phantom', 'multiplier'
                ];
                
                const configKeys = ['health', 'score', 'color', 'size', 'maxAge'];
                
                let successCount = 0;
                let totalTests = bubbleTypes.length * configKeys.length;
                
                log(`${bubbleTypes.length}ç¨®é¡ã®ãƒãƒ–ãƒ«è¨­å®šã‚’ãƒ†ã‚¹ãƒˆä¸­...`);
                
                for (const bubbleType of bubbleTypes) {
                    let bubbleSuccess = 0;
                    
                    for (const configKey of configKeys) {
                        const fullKey = `bubbles.${bubbleType}.${configKey}`;
                        
                        try {
                            const value = configManager.get('game', fullKey);
                            
                            if (value !== null && value !== undefined) {
                                successCount++;
                                bubbleSuccess++;
                            } else {
                                log(`âš ï¸ ${fullKey}: è¨­å®šå€¤ãŒnull/undefined`, 'warning');
                            }
                        } catch (error) {
                            log(`âŒ ${fullKey}: ã‚¨ãƒ©ãƒ¼ - ${error.message}`, 'error');
                        }
                    }
                    
                    if (bubbleSuccess === configKeys.length) {
                        log(`âœ“ ${bubbleType}ãƒãƒ–ãƒ«: å…¨è¨­å®šOK (${bubbleSuccess}/${configKeys.length})`, 'success');
                    } else {
                        log(`âš ï¸ ${bubbleType}ãƒãƒ–ãƒ«: ä¸€éƒ¨è¨­å®šä¸è¶³ (${bubbleSuccess}/${configKeys.length})`, 'warning');
                    }
                }
                
                const successRate = Math.round((successCount / totalTests) * 100);
                
                if (successRate >= 95) {
                    log(`ğŸ‰ ãƒãƒ–ãƒ«è¨­å®šãƒ†ã‚¹ãƒˆæˆåŠŸ: ${successCount}/${totalTests} (${successRate}%)`, 'success');
                } else {
                    log(`âš ï¸ ãƒãƒ–ãƒ«è¨­å®šãƒ†ã‚¹ãƒˆ: æ”¹å–„ãŒå¿…è¦ ${successCount}/${totalTests} (${successRate}%)`, 'warning');
                }
                
            } catch (error) {
                log(`âŒ ãƒãƒ–ãƒ«è¨­å®šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('è©³ç´°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // è­¦å‘Šãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ†ã‚¹ãƒˆ
        async function testWarningRateLimit() {
            log('=== è­¦å‘Šãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            try {
                const configModule = await import('./src/core/ConfigurationManager.js');
                const configManager = configModule.getConfigurationManager();
                
                log('å­˜åœ¨ã—ãªã„è¨­å®šã‚­ãƒ¼ã‚’10å›é€£ç¶šã§å–å¾—...');
                
                // è­¦å‘Šãƒ­ã‚°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                let warningCount = 0;
                const originalWarn = console.warn;
                console.warn = function(...args) {
                    if (args[0] && args[0].includes('[ConfigurationManager]')) {
                        warningCount++;
                    }
                    originalWarn.apply(console, args);
                };
                
                // åŒã˜å­˜åœ¨ã—ãªã„è¨­å®šã‚­ãƒ¼ã‚’çŸ­æ™‚é–“ã§è¤‡æ•°å›ã‚¢ã‚¯ã‚»ã‚¹
                for (let i = 0; i < 10; i++) {
                    configManager.get('game', 'bubbles.nonexistent.test');
                }
                
                // console.warn ã‚’å…ƒã«æˆ»ã™
                console.warn = originalWarn;
                
                if (warningCount <= 1) {
                    log(`âœ… è­¦å‘Šãƒ¬ãƒ¼ãƒˆåˆ¶é™æˆåŠŸ: 10å›ã‚¢ã‚¯ã‚»ã‚¹ â†’ ${warningCount}å›è­¦å‘Š`, 'success');
                } else {
                    log(`âš ï¸ è­¦å‘Šãƒ¬ãƒ¼ãƒˆåˆ¶é™ä¸å®Œå…¨: 10å›ã‚¢ã‚¯ã‚»ã‚¹ â†’ ${warningCount}å›è­¦å‘Š`, 'warning');
                }
                
            } catch (error) {
                log(`âŒ è­¦å‘Šãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // GameEngineçµ±åˆãƒ†ã‚¹ãƒˆ
        async function testGameEngineWithConfig() {
            log('=== GameEngineçµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            try {
                // Canvasè¦ç´ ã‚’ç”¨æ„
                const canvas = document.getElementById('gameCanvas');
                const ctx = canvas.getContext('2d');
                
                log('âœ“ Canvasæº–å‚™å®Œäº†');
                
                // GameEngineã‚’å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ»åˆæœŸåŒ–
                const gameEngineModule = await import('./src/core/GameEngine.js');
                testGameEngine = new gameEngineModule.GameEngine(canvas);
                
                log('âœ“ GameEngineåˆæœŸåŒ–æˆåŠŸ', 'success');
                
                // è¨­å®šã‚­ãƒ¼ä¸è¶³ã‚¨ãƒ©ãƒ¼ã®ç›£è¦–
                let configErrorCount = 0;
                const originalError = console.error;
                const originalWarn = console.warn;
                
                const errorWatcher = function(...args) {
                    const message = args.join(' ');
                    if (message.includes('è¨­å®šã‚­ãƒ¼ãŒå­˜åœ¨ã—ã¾ã›ã‚“') || message.includes('ConfigurationManager')) {
                        configErrorCount++;
                    }
                    originalError.apply(console, args);
                };
                
                const warnWatcher = function(...args) {
                    const message = args.join(' ');
                    if (message.includes('è¨­å®šã‚­ãƒ¼ãŒå­˜åœ¨ã—ã¾ã›ã‚“') || message.includes('ConfigurationManager')) {
                        configErrorCount++;
                    }
                    originalWarn.apply(console, args);
                };
                
                console.error = errorWatcher;
                console.warn = warnWatcher;
                
                log('GameEngineé–‹å§‹ä¸­... (5ç§’é–“ã‚¨ãƒ©ãƒ¼ç›£è¦–)');
                testGameEngine.start();
                
                // 5ç§’å¾Œã«ã‚¨ãƒ©ãƒ¼ã‚«ã‚¦ãƒ³ãƒˆç¢ºèª
                setTimeout(() => {
                    console.error = originalError;
                    console.warn = originalWarn;
                    
                    if (configErrorCount === 0) {
                        log('ğŸ‰ GameEngineçµ±åˆãƒ†ã‚¹ãƒˆæˆåŠŸ: è¨­å®šã‚¨ãƒ©ãƒ¼0ä»¶', 'success');
                    } else if (configErrorCount < 5) {
                        log(`âš ï¸ GameEngineçµ±åˆãƒ†ã‚¹ãƒˆ: è»½å¾®ãªè¨­å®šã‚¨ãƒ©ãƒ¼ ${configErrorCount}ä»¶`, 'warning');
                    } else {
                        log(`âŒ GameEngineçµ±åˆãƒ†ã‚¹ãƒˆ: å¤šæ•°ã®è¨­å®šã‚¨ãƒ©ãƒ¼ ${configErrorCount}ä»¶`, 'error');
                    }
                    
                    testGameEngine.stop();
                }, 5000);
                
            } catch (error) {
                log(`âŒ GameEngineçµ±åˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('è©³ç´°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆ
        async function runStressTest() {
            log('=== è¨­å®šã‚¢ã‚¯ã‚»ã‚¹ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            try {
                const configModule = await import('./src/core/ConfigurationManager.js');
                const configManager = configModule.getConfigurationManager();
                
                const startTime = performance.now();
                const accessCount = 1000;
                
                log(`${accessCount}å›ã®è¨­å®šã‚¢ã‚¯ã‚»ã‚¹ã‚’å®Ÿè¡Œä¸­...`);
                
                // æ§˜ã€…ãªè¨­å®šã‚­ãƒ¼ã«å¤§é‡ã‚¢ã‚¯ã‚»ã‚¹
                for (let i = 0; i < accessCount; i++) {
                    const bubbleType = ['normal', 'stone', 'boss', 'pink', 'poison'][i % 5];
                    const configKey = ['health', 'score', 'color', 'size'][i % 4];
                    configManager.get('game', `bubbles.${bubbleType}.${configKey}`);
                }
                
                const endTime = performance.now();
                const duration = endTime - startTime;
                const avgTime = duration / accessCount;
                
                log(`âœ… ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆå®Œäº†: ${accessCount}å› / ${duration.toFixed(2)}ms`, 'success');
                log(`âœ… å¹³å‡ã‚¢ã‚¯ã‚»ã‚¹æ™‚é–“: ${avgTime.toFixed(4)}ms`, 'success');
                
                if (avgTime < 0.1) {
                    log('ğŸš€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: å„ªç§€', 'success');
                } else if (avgTime < 0.5) {
                    log('ğŸ‘ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: è‰¯å¥½', 'success');
                } else {
                    log('âš ï¸ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹: æ”¹å–„ã®ä½™åœ°ã‚ã‚Š', 'warning');
                }
                
            } catch (error) {
                log(`âŒ ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        // ãƒŸãƒ‹ã‚²ãƒ¼ãƒ é–‹å§‹
        async function startMiniGame() {
            if (miniGameRunning) return;
            
            log('=== ãƒŸãƒ‹ã‚²ãƒ¼ãƒ é–‹å§‹ ===');
            
            try {
                const canvas = document.getElementById('gameCanvas');
                const ctx = canvas.getContext('2d');
                
                miniGameRunning = true;
                
                // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã§è¨­å®šã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
                const configModule = await import('./src/core/ConfigurationManager.js');
                const configManager = configModule.getConfigurationManager();
                
                let frame = 0;
                let lastErrorCount = 0;
                
                gameLoop = setInterval(() => {
                    // Canvas ã‚¯ãƒªã‚¢
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // èƒŒæ™¯æç”»
                    ctx.fillStyle = '#16213e';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // ãƒ•ãƒ¬ãƒ¼ãƒ ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
                    frame++;
                    
                    // æ¯ãƒ•ãƒ¬ãƒ¼ãƒ è¨­å®šã‚¢ã‚¯ã‚»ã‚¹ï¼ˆå®Ÿéš›ã®ã‚²ãƒ¼ãƒ ã¨åŒæ§˜ï¼‰
                    const bubbleTypes = ['normal', 'stone', 'boss', 'pink'];
                    for (const bubbleType of bubbleTypes) {
                        configManager.get('game', `bubbles.${bubbleType}.health`);
                        configManager.get('game', `bubbles.${bubbleType}.score`);
                        configManager.get('game', `bubbles.${bubbleType}.color`);
                    }
                    
                    // å‹•çš„ãªå††ã‚’æç”»
                    const centerX = canvas.width / 2;
                    const centerY = canvas.height / 2;
                    const radius = 30 + Math.sin(frame * 0.1) * 10;
                    
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                    ctx.fillStyle = `hsl(${frame * 2 % 360}, 50%, 50%)`;
                    ctx.fill();
                    
                    // ãƒ•ãƒ¬ãƒ¼ãƒ ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è¡¨ç¤º
                    ctx.fillStyle = 'white';
                    ctx.font = '16px monospace';
                    ctx.fillText(`Frame: ${frame}`, 10, 25);
                    ctx.fillText('è¨­å®šã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆä¸­...', 10, 45);
                    
                    // 60ãƒ•ãƒ¬ãƒ¼ãƒ æ¯ã«ãƒ­ã‚°ç¢ºèª
                    if (frame % 60 === 0) {
                        // ã‚¨ãƒ©ãƒ¼ã‚«ã‚¦ãƒ³ãƒˆã®ãƒã‚§ãƒƒã‚¯ï¼ˆçœç•¥ï¼‰
                        log(`âœ“ ${frame}ãƒ•ãƒ¬ãƒ¼ãƒ çµŒé - è¨­å®šã‚¢ã‚¯ã‚»ã‚¹æ­£å¸¸`, frame % 300 === 0 ? 'success' : 'info');
                    }
                    
                }, 16); // ~60FPS
                
                log('âœ… ãƒŸãƒ‹ã‚²ãƒ¼ãƒ é–‹å§‹ - è¨­å®šã‚¢ã‚¯ã‚»ã‚¹è² è·ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­', 'success');
                
            } catch (error) {
                log(`âŒ ãƒŸãƒ‹ã‚²ãƒ¼ãƒ é–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                miniGameRunning = false;
            }
        }

        // ãƒŸãƒ‹ã‚²ãƒ¼ãƒ åœæ­¢
        function stopMiniGame() {
            if (!miniGameRunning) return;
            
            miniGameRunning = false;
            if (gameLoop) {
                clearInterval(gameLoop);
                gameLoop = null;
            }
            
            // Canvas ã‚¯ãƒªã‚¢
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#16213e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = 'white';
            ctx.font = '20px monospace';
            ctx.textAlign = 'center';
            ctx.fillText('ãƒŸãƒ‹ã‚²ãƒ¼ãƒ åœæ­¢', canvas.width / 2, canvas.height / 2);
            ctx.textAlign = 'left';
            
            log('âœ… ãƒŸãƒ‹ã‚²ãƒ¼ãƒ åœæ­¢å®Œäº†', 'success');
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
        window.testBubbleConfigs = testBubbleConfigs;
        window.testWarningRateLimit = testWarningRateLimit;
        window.testGameEngineWithConfig = testGameEngineWithConfig;
        window.runStressTest = runStressTest;
        window.startMiniGame = startMiniGame;
        window.stopMiniGame = stopMiniGame;
        window.clearLog = clearLog;

        // åˆæœŸåŒ–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        log('ConfigurationManager ãƒãƒ–ãƒ«è¨­å®šä¿®æ­£ãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†');
        log('å„ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å‹•ä½œã‚’ç¢ºèªã—ã¦ãã ã•ã„');
    </script>
</body>
</html>