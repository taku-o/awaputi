<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug - Bubble Visibility Issue</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #f0f0f0;
            font-family: Arial, sans-serif;
        }
        
        #gameCanvas {
            border: 2px solid #333;
            background: linear-gradient(135deg, #87CEEB, #E0F6FF);
            display: block;
            margin: 20px auto;
        }
        
        .debug-panel {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .debug-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .status.success { background: #d4edda; color: #155724; }
        .status.warning { background: #fff3cd; color: #856404; }
        .status.error { background: #f8d7da; color: #721c24; }
        
        .log-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="debug-panel">
        <h1>ğŸ” Debug - Bubble Visibility Issue</h1>
        <p><strong>ç›®çš„:</strong> ãƒãƒ–ãƒ«ãŒè¡¨ç¤ºã•ã‚Œãªã„å•é¡Œã®æ ¹æœ¬åŸå› ã‚’ç‰¹å®š</p>
        
        <div class="debug-section">
            <h3>å®Ÿè¡ŒçŠ¶æ³</h3>
            <div id="executionStatus">
                <span class="status warning">å¾…æ©Ÿä¸­</span>
            </div>
            <button onclick="startDebugging()">ãƒ‡ãƒãƒƒã‚°é–‹å§‹</button>
            <button onclick="clearLogs()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
            <button onclick="manualSpawnBubble()">æ‰‹å‹•ãƒãƒ–ãƒ«ç”Ÿæˆ</button>
        </div>
        
        <div class="debug-section">
            <h3>ğŸ¯ é‡è¦ãƒ•ãƒ­ãƒ¼ ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ</h3>
            <div id="flowCheckpoints">
                <div>1. GameEngine.gameLoop() å®Ÿè¡Œä¸­: <span id="checkpoint1" class="status warning">æœªç¢ºèª</span></div>
                <div>2. GameEngine.update() å‘¼ã³å‡ºã—: <span id="checkpoint2" class="status warning">æœªç¢ºèª</span></div>
                <div>3. SceneManager.update() å‘¼ã³å‡ºã—: <span id="checkpoint3" class="status warning">æœªç¢ºèª</span></div>
                <div>4. GameScene.update() å‘¼ã³å‡ºã—: <span id="checkpoint4" class="status warning">æœªç¢ºèª</span></div>
                <div>5. BubbleManager.update() å‘¼ã³å‡ºã—: <span id="checkpoint5" class="status warning">æœªç¢ºèª</span></div>
                <div>6. ãƒãƒ–ãƒ«ç”Ÿæˆå‡¦ç†å®Ÿè¡Œ: <span id="checkpoint6" class="status warning">æœªç¢ºèª</span></div>
                <div>7. ãƒãƒ–ãƒ«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Ÿè¡Œ: <span id="checkpoint7" class="status warning">æœªç¢ºèª</span></div>
            </div>
        </div>
        
        <div class="debug-section">
            <h3>ğŸ“Š ã‚²ãƒ¼ãƒ çŠ¶æ…‹</h3>
            <div id="gameState">
                <div>Game Running: <span id="gameRunning">æœªç¢ºèª</span></div>
                <div>Scene: <span id="currentScene">æœªç¢ºèª</span></div>
                <div>Paused: <span id="gamePaused">æœªç¢ºèª</span></div>
                <div>Game Over: <span id="gameOver">æœªç¢ºèª</span></div>
                <div>Bubble Count: <span id="bubbleCount">æœªç¢ºèª</span></div>
                <div>Frame Count: <span id="frameCount">æœªç¢ºèª</span></div>
            </div>
        </div>
        
        <div class="debug-section">
            <h3>ğŸ“ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°</h3>
            <div id="debugLog" class="log-output">ãƒ­ã‚°å¾…æ©Ÿä¸­...\n</div>
        </div>
    </div>
    
    <canvas id="gameCanvas" width="800" height="600"></canvas>

    <script type="module">
        import { GameEngine } from './src/core/GameEngine.js';
        
        let gameEngine;
        let debugInterval;
        let logBuffer = '';
        
        // ãƒ­ã‚°ã‚­ãƒ£ãƒ—ãƒãƒ£æ©Ÿèƒ½
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        function captureLog(level, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg) : arg).join(' ');
            logBuffer += `[${timestamp}] ${level.toUpperCase()}: ${message}\n`;
            
            // ãƒ­ã‚°å‡ºåŠ›ã‚‚ä¿æŒ
            if (level === 'log') originalConsoleLog(...args);
            if (level === 'error') originalConsoleError(...args);
            if (level === 'warn') originalConsoleWarn(...args);
            
            // ãƒ­ã‚°è¡¨ç¤ºã‚’æ›´æ–°
            updateLogDisplay();
            
            // ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆæ›´æ–°
            updateCheckpoints(message);
        }
        
        console.log = (...args) => captureLog('log', ...args);
        console.error = (...args) => captureLog('error', ...args);
        console.warn = (...args) => captureLog('warn', ...args);
        
        function updateLogDisplay() {
            const logElement = document.getElementById('debugLog');
            logElement.textContent = logBuffer;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        function updateCheckpoints(message) {
            // ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ1: GameEngine.gameLoopå®Ÿè¡Œ
            if (message.includes('GameEngine.gameLoop')) {
                setCheckpoint('checkpoint1', 'success', 'å®Ÿè¡Œä¸­');
            }
            
            // ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ2: GameEngine.updateå‘¼ã³å‡ºã—
            if (message.includes('GameEngine') && message.includes('update') && !message.includes('gameLoop')) {
                setCheckpoint('checkpoint2', 'success', 'å®Ÿè¡Œä¸­');
            }
            
            // ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ3: SceneManager.updateå‘¼ã³å‡ºã—
            if (message.includes('SceneManager.update')) {
                setCheckpoint('checkpoint3', 'success', 'å®Ÿè¡Œä¸­');
            }
            
            // ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ4: GameScene.updateå‘¼ã³å‡ºã—
            if (message.includes('GameScene.update')) {
                setCheckpoint('checkpoint4', 'success', 'å®Ÿè¡Œä¸­');
            }
            
            // ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ5: BubbleManager.updateå‘¼ã³å‡ºã—
            if (message.includes('BubbleManager.update') || message.includes('bubbleManager.update')) {
                setCheckpoint('checkpoint5', 'success', 'å®Ÿè¡Œä¸­');
            }
            
            // ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ6: ãƒãƒ–ãƒ«ç”Ÿæˆ
            if (message.includes('Spawning bubble') || message.includes('spawnBubble')) {
                setCheckpoint('checkpoint6', 'success', 'ç”Ÿæˆä¸­');
            }
            
            // ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ7: ãƒãƒ–ãƒ«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            if (message.includes('BubbleManager.render') || message.includes('ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ãŸæ³¡ã®æ•°')) {
                setCheckpoint('checkpoint7', 'success', 'ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ä¸­');
            }
        }
        
        function setCheckpoint(id, status, text) {
            const element = document.getElementById(id);
            element.className = `status ${status}`;
            element.textContent = text;
        }
        
        function updateGameState() {
            if (!gameEngine) return;
            
            try {
                document.getElementById('gameRunning').textContent = gameEngine.isRunning || 'ä¸æ˜';
                document.getElementById('currentScene').textContent = gameEngine.sceneManager?.currentScene?.constructor?.name || 'ä¸æ˜';
                document.getElementById('gamePaused').textContent = gameEngine.sceneManager?.currentScene?.isPaused || 'ä¸æ˜';
                document.getElementById('gameOver').textContent = gameEngine.isGameOver || 'ä¸æ˜';
                document.getElementById('bubbleCount').textContent = gameEngine.bubbleManager?.getBubbleCount() || 'ä¸æ˜';
                document.getElementById('frameCount').textContent = gameEngine.frameCount || 'ä¸æ˜';
            } catch (error) {
                console.error('ã‚²ãƒ¼ãƒ çŠ¶æ…‹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        window.startDebugging = async function() {
            try {
                document.getElementById('executionStatus').innerHTML = '<span class="status warning">åˆæœŸåŒ–ä¸­...</span>';
                
                const canvas = document.getElementById('gameCanvas');
                gameEngine = new GameEngine(canvas);
                
                console.log('=== Debug Session Start ===');
                console.log('GameEngine created, starting game...');
                
                // ã‚²ãƒ¼ãƒ é–‹å§‹
                gameEngine.start();
                
                document.getElementById('executionStatus').innerHTML = '<span class="status success">å®Ÿè¡Œä¸­</span>';
                
                // å®šæœŸçš„ãªã‚²ãƒ¼ãƒ çŠ¶æ…‹æ›´æ–°
                debugInterval = setInterval(() => {
                    updateGameState();
                }, 1000);
                
                console.log('Debug session started successfully');
                
            } catch (error) {
                console.error('Debug session start failed:', error);
                document.getElementById('executionStatus').innerHTML = '<span class="status error">ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ</span>';
            }
        };
        
        window.clearLogs = function() {
            logBuffer = '';
            updateLogDisplay();
            console.log('=== Logs Cleared ===');
        };
        
        window.manualSpawnBubble = function() {
            if (!gameEngine || !gameEngine.bubbleManager) {
                console.error('GameEngine or BubbleManager not available');
                return;
            }
            
            try {
                console.log('=== Manual Bubble Spawn Test ===');
                const bubble = gameEngine.bubbleManager.spawnBubble('normal', { x: 400, y: 300 });
                console.log('Manual spawn result:', !!bubble);
                
                if (bubble) {
                    console.log(`Manual bubble created: type=${bubble.type}, position=(${bubble.x}, ${bubble.y})`);
                }
            } catch (error) {
                console.error('Manual spawn failed:', error);
            }
        };
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®åˆæœŸåŒ–
        console.log('Debug page loaded, ready to start debugging');
    </script>
</body>
</html>