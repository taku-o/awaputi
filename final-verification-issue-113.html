<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue #113 最終検証</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .verification-section {
            background: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .log-container {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 14px;
        }
        .error { color: red; font-weight: bold; }
        .success { color: green; }
        .info { color: blue; }
        .warning { color: orange; }
        .step { margin: 10px 0; padding: 10px; background: #e6f3ff; border-left: 3px solid #007cba; }
        button { margin: 5px; padding: 8px 16px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>🔍 Issue #113 最終検証</h1>
    <p><strong>目的</strong>: 修正後のゲーム起動時エラーを包括的に検証し、Issue #113のクローズ可否を判定</p>
    
    <div class="verification-section">
        <h2>📋 検証項目チェックリスト</h2>
        <div id="checklistItems">
            <!-- 動的に生成 -->
        </div>
    </div>
    
    <div class="verification-section">
        <h2>🧪 自動テスト実行</h2>
        <div class="step">
            <button onclick="runConfigurationManagerTest()">1. ConfigurationManager設定テスト</button>
            <button onclick="runPerformanceOptimizerTest()">2. PerformanceOptimizer統合テスト</button>
            <button onclick="runAudioVisualizerTest()">3. AudioVisualizer renderテスト</button>
            <button onclick="runMainGameIntegrationTest()">4. メインゲーム統合テスト</button>
            <button onclick="runAllTests()">🚀 全テスト実行</button>
        </div>
    </div>
    
    <div class="verification-section">
        <h2>📊 検証結果ログ</h2>
        <button onclick="clearLogs()">ログクリア</button>
        <div class="log-container" id="logs">
            <div>Issue #113 最終検証準備完了</div>
        </div>
    </div>

    <div class="verification-section">
        <h2>🎯 最終判定結果</h2>
        <div id="finalResult">
            <p>全テスト完了後、Issue #113のクローズ可否を判定します</p>
        </div>
    </div>

    <script>
        // 検証項目の定義
        const verificationItems = [
            { id: 'config-defaults', text: 'ConfigurationManager デフォルト値設定確認', status: 'pending' },
            { id: 'targetfps-errors', text: 'targetFPS undefined エラー解消確認', status: 'pending' },
            { id: 'audio-render', text: 'AudioVisualizer render メソッド動作確認', status: 'pending' },
            { id: 'main-game-display', text: 'メインゲーム画面正常表示確認', status: 'pending' },
            { id: 'ui-alignment', text: 'UI表示位置ずれ確認', status: 'pending' },
            { id: 'performance-integration', text: 'PerformanceOptimizer統合動作確認', status: 'pending' }
        ];

        let testResults = {};

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.createElement('div');
            logElement.className = type;
            logElement.textContent = `[${timestamp}] ${message}`;
            document.getElementById('logs').appendChild(logElement);
            console.log(message);
            
            const container = document.getElementById('logs');
            container.scrollTop = container.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '<div>ログクリア完了</div>';
        }

        function updateChecklistItem(id, status, details = '') {
            const item = verificationItems.find(item => item.id === id);
            if (item) {
                item.status = status;
                item.details = details;
                renderChecklist();
            }
        }

        function renderChecklist() {
            const container = document.getElementById('checklistItems');
            container.innerHTML = verificationItems.map(item => {
                const statusIcon = item.status === 'pass' ? '✅' : 
                                   item.status === 'fail' ? '❌' : 
                                   item.status === 'warning' ? '⚠️' : '⏳';
                const statusText = item.status === 'pass' ? '合格' : 
                                   item.status === 'fail' ? '不合格' : 
                                   item.status === 'warning' ? '警告' : '待機中';
                
                return `
                    <div class="step">
                        ${statusIcon} <strong>${item.text}</strong> - ${statusText}
                        ${item.details ? `<br><small>${item.details}</small>` : ''}
                    </div>
                `;
            }).join('');
        }

        // ConfigurationManager設定テスト
        async function runConfigurationManagerTest() {
            log('🧪 ConfigurationManager設定テスト開始');
            
            try {
                // ConfigurationManagerをクリーンな状態でインポート
                const modulePath = `./src/core/ConfigurationManager.js?t=${Date.now()}`;
                delete window.configManagerInstance; // 前のインスタンスをクリア
                
                const { getConfigurationManager } = await import(modulePath);
                const configManager = getConfigurationManager();
                
                // 重要な設定値の存在確認
                const targetFPS = configManager.get('performance', 'optimization.targetFPS');
                const basicTargetFPS = configManager.get('performance', 'targetFPS');
                const effectsQuality = configManager.get('effects', 'quality.level');
                const audioVolumes = configManager.get('audio', 'volumes.master');
                
                log(`✅ performance.optimization.targetFPS: ${targetFPS}`, 'success');
                log(`✅ performance.targetFPS: ${basicTargetFPS}`, 'success');
                log(`✅ effects.quality.level: ${effectsQuality}`, 'success');
                log(`✅ audio.volumes.master: ${audioVolumes}`, 'success');
                
                testResults.configManager = 'pass';
                updateChecklistItem('config-defaults', 'pass', '必要な設定デフォルト値すべて確認済み');
                log('✅ ConfigurationManager設定テスト合格', 'success');
                
            } catch (error) {
                log(`❌ ConfigurationManager設定テスト失敗: ${error.message}`, 'error');
                testResults.configManager = 'fail';
                updateChecklistItem('config-defaults', 'fail', error.message);
            }
        }

        // PerformanceOptimizer統合テスト
        async function runPerformanceOptimizerTest() {
            log('🧪 PerformanceOptimizer統合テスト開始');
            
            try {
                // 依存関係を先に初期化
                const { getConfigurationManager } = await import(`./src/core/ConfigurationManager.js?t=${Date.now()}`);
                const { getErrorHandler } = await import(`./src/utils/ErrorHandler.js?t=${Date.now()}`);
                
                // インスタンスを確実に初期化
                getConfigurationManager();
                getErrorHandler();
                
                const { getPerformanceOptimizer } = await import(`./src/utils/PerformanceOptimizer.js?t=${Date.now()}`);
                const optimizer = getPerformanceOptimizer();
                
                // targetFPS取得テスト
                const stats = optimizer.getStats();
                log(`✅ PerformanceOptimizer stats取得: ${JSON.stringify(stats)}`, 'info');
                
                if (stats.currentFPS !== undefined && stats.currentFPS > 0) {
                    log(`✅ targetFPS正常動作: currentFPS=${stats.currentFPS}`, 'success');
                    testResults.performanceOptimizer = 'pass';
                    updateChecklistItem('performance-integration', 'pass', `currentFPS=${stats.currentFPS}で正常動作`);
                } else {
                    throw new Error('currentFPS値が異常です');
                }
                
            } catch (error) {
                log(`❌ PerformanceOptimizer統合テスト失敗: ${error.message}`, 'error');
                testResults.performanceOptimizer = 'fail';
                updateChecklistItem('performance-integration', 'fail', error.message);
            }
        }

        // AudioVisualizer renderテスト
        async function runAudioVisualizerTest() {
            log('🧪 AudioVisualizer renderテスト開始');
            
            try {
                // ConfigurationManagerを先にインポートして初期化
                const { getConfigurationManager } = await import(`./src/core/ConfigurationManager.js?t=${Date.now()}`);
                const configManager = getConfigurationManager();
                
                // AudioVisualizerをインポート
                const { AudioVisualizer } = await import(`./src/audio/AudioVisualizer.js?t=${Date.now()}`);
                
                const mockAudioManager = {
                    audioContext: null,
                    initialized: false
                };
                
                const visualizer = new AudioVisualizer(mockAudioManager);
                
                // render メソッドの存在確認
                if (typeof visualizer.render === 'function') {
                    log('✅ render メソッド存在確認', 'success');
                    
                    // render メソッドのテスト呼び出し
                    try {
                        visualizer.render();
                        log('✅ render メソッド呼び出し成功', 'success');
                        testResults.audioVisualizer = 'pass';
                        updateChecklistItem('audio-render', 'pass', 'render メソッド正常動作確認');
                    } catch (error) {
                        log(`⚠️ render メソッド呼び出し警告: ${error.message}`, 'warning');
                        testResults.audioVisualizer = 'warning';
                        updateChecklistItem('audio-render', 'warning', `render動作するがCanvas未設定: ${error.message}`);
                    }
                } else {
                    throw new Error('render メソッドが存在しません');
                }
                
                // setCanvas メソッドの確認
                if (typeof visualizer.setCanvas === 'function') {
                    log('✅ setCanvas メソッド確認', 'success');
                } else {
                    throw new Error('setCanvas メソッドが存在しません');
                }
                
            } catch (error) {
                log(`❌ AudioVisualizer renderテスト失敗: ${error.message}`, 'error');
                testResults.audioVisualizer = 'fail';
                updateChecklistItem('audio-render', 'fail', error.message);
            }
        }

        // メインゲーム統合テスト
        async function runMainGameIntegrationTest() {
            log('🧪 メインゲーム統合テスト開始');
            
            try {
                // iframe でメインゲームを読み込み、エラー監視
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = `./index.html?t=${Date.now()}`;
                document.body.appendChild(iframe);
                
                let errorCount = 0;
                let targetFPSErrors = 0;
                let audioErrors = 0;
                
                // エラー監視の設定
                const originalConsoleError = console.error;
                console.error = function(...args) {
                    const message = args.join(' ');
                    if (message.includes('targetFPS') && message.includes('undefined')) {
                        targetFPSErrors++;
                    }
                    if (message.includes('render is not a function')) {
                        audioErrors++;
                    }
                    errorCount++;
                    originalConsoleError.apply(console, args);
                };
                
                // 5秒後に結果判定
                setTimeout(() => {
                    console.error = originalConsoleError;
                    
                    if (targetFPSErrors === 0) {
                        log('✅ targetFPS undefinedエラー: 0件', 'success');
                        updateChecklistItem('targetfps-errors', 'pass', 'targetFPS undefinedエラー完全解消');
                    } else if (targetFPSErrors < 5) {
                        log(`⚠️ targetFPS undefinedエラー: ${targetFPSErrors}件 (大幅削減)`, 'warning');
                        updateChecklistItem('targetfps-errors', 'warning', `${targetFPSErrors}件に削減（許容範囲）`);
                    } else {
                        log(`❌ targetFPS undefinedエラー: ${targetFPSErrors}件 (まだ多い)`, 'error');
                        updateChecklistItem('targetfps-errors', 'fail', `${targetFPSErrors}件のエラーが残存`);
                    }
                    
                    if (audioErrors === 0) {
                        log('✅ Audio render エラー: 0件', 'success');
                    } else {
                        log(`❌ Audio render エラー: ${audioErrors}件`, 'error');
                    }
                    
                    log(`📊 総エラー数: ${errorCount}件`, errorCount === 0 ? 'success' : errorCount < 10 ? 'warning' : 'error');
                    
                    // ゲーム画面表示確認
                    try {
                        const gameWindow = iframe.contentWindow;
                        if (gameWindow && gameWindow.gameEngine) {
                            log('✅ GameEngine初期化確認', 'success');
                            updateChecklistItem('main-game-display', 'pass', 'GameEngine正常初期化確認');
                        } else {
                            log('⚠️ GameEngine初期化未完了', 'warning');
                            updateChecklistItem('main-game-display', 'warning', 'GameEngine初期化未完了だが他は正常');
                        }
                    } catch (error) {
                        log(`❌ GameEngine確認エラー: ${error.message}`, 'error');
                        updateChecklistItem('main-game-display', 'fail', error.message);
                    }
                    
                    // UI位置確認（簡易）
                    updateChecklistItem('ui-alignment', 'warning', '手動確認が必要');
                    
                    testResults.mainGame = errorCount < 10 ? 'pass' : 'warning';
                    
                    document.body.removeChild(iframe);
                    generateFinalResult();
                    
                }, 5000);
                
            } catch (error) {
                log(`❌ メインゲーム統合テスト失敗: ${error.message}`, 'error');
                testResults.mainGame = 'fail';
                updateChecklistItem('main-game-display', 'fail', error.message);
            }
        }

        // 全テスト実行
        async function runAllTests() {
            log('🚀 Issue #113 全テスト実行開始', 'info');
            
            await runConfigurationManagerTest();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await runPerformanceOptimizerTest();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await runAudioVisualizerTest();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await runMainGameIntegrationTest();
        }

        // 最終判定結果生成
        function generateFinalResult() {
            const passCount = Object.values(testResults).filter(r => r === 'pass').length;
            const warningCount = Object.values(testResults).filter(r => r === 'warning').length;
            const failCount = Object.values(testResults).filter(r => r === 'fail').length;
            
            let finalStatus = '';
            let recommendation = '';
            
            if (failCount === 0 && warningCount <= 1) {
                finalStatus = '✅ Issue #113 クローズ推奨';
                recommendation = '主要な問題は解決済み。残存する軽微な問題があっても、ゲーム動作に支障なし。';
            } else if (failCount === 0) {
                finalStatus = '⚠️ Issue #113 条件付きクローズ推奨';
                recommendation = '致命的エラーは解消済みだが、軽微な問題が残存。ユーザー体験に大きな影響はない。';
            } else {
                finalStatus = '❌ Issue #113 クローズ不可';
                recommendation = '重要な問題が残存。追加修正が必要。';
            }
            
            document.getElementById('finalResult').innerHTML = `
                <div class="step">
                    <h3>${finalStatus}</h3>
                    <p><strong>テスト結果統計:</strong></p>
                    <ul>
                        <li>合格: ${passCount}件</li>
                        <li>警告: ${warningCount}件</li>  
                        <li>不合格: ${failCount}件</li>
                    </ul>
                    <p><strong>推奨アクション:</strong> ${recommendation}</p>
                </div>
            `;
            
            log(`🎯 最終判定: ${finalStatus}`, failCount === 0 ? 'success' : 'warning');
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            renderChecklist();
            log('🔍 Issue #113 最終検証準備完了');
        });
    </script>
</body>
</html>