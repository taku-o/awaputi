<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue #113æœ€çµ‚æ¤œè¨¼ - AudioLoopä¿®æ­£ç‰ˆ</title>
    <style>
        body {
            font-family: monospace;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #16213e;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #f39c12;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 20px;
            padding: 15px;
            background: #0f3460;
            border-radius: 8px;
        }
        
        .status {
            padding: 8px 15px;
            border-radius: 5px;
            margin: 8px 0;
            font-weight: bold;
        }
        
        .success { background: #27ae60; color: white; }
        .error { background: #e74c3c; color: white; }
        .warning { background: #f39c12; color: white; }
        .info { background: #3498db; color: white; }
        
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        button:hover { background: #2980b9; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ Issue #113 æœ€çµ‚æ¤œè¨¼ãƒ†ã‚¹ãƒˆ</h1>
        <div class="status info">AudioFormatHandlerç„¡é™ãƒ«ãƒ¼ãƒ—ä¿®æ­£ç‰ˆ - å¾ªç’°å‚ç…§é˜²æ­¢å¯¾å¿œ</div>
        
        <div class="section">
            <h2>ä¿®æ­£å®Œäº†é …ç›®</h2>
            <div class="status success">âœ… EnhancedEffectManager.js - renderPostProcessingEffectsä¿®æ­£</div>
            <div class="status success">âœ… StatisticsManager.js - exporter nullãƒã‚§ãƒƒã‚¯è¿½åŠ </div>
            <div class="status success">âœ… AudioFormatHandler.js - å“è³ªè¨­å®šç„¡é™ãƒ«ãƒ¼ãƒ—ä¿®æ­£</div>
            <div class="status success">âœ… Equalizer.js - Audio connect nullãƒã‚§ãƒƒã‚¯è¿½åŠ </div>
            <div class="status warning">âš ï¸ æ®‹ã‚Š: PWAæ›´æ–°ãƒœã‚¿ãƒ³ã€Canvasã€Configurationè¨­å®šã‚­ãƒ¼</div>
        </div>
        
        <div class="section">
            <h2>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h2>
            <div class="grid">
                <button onclick="testEffectManager()">ã‚¨ãƒ•ã‚§ã‚¯ãƒˆä¿®æ­£ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="testStatisticsManager()">çµ±è¨ˆç®¡ç†ä¿®æ­£ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="testAudioLoopFix()">Audioç„¡é™ãƒ«ãƒ¼ãƒ—ä¿®æ­£ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="testEqualizerFix()">Equalizer Audioä¿®æ­£ãƒ†ã‚¹ãƒˆ</button>
                <button onclick="testMainGame()">ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ å®Ÿè¡Œãƒ†ã‚¹ãƒˆ</button>
                <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
                <button onclick="checkMainGameStatus()">ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç¢ºèª</button>
            </div>
        </div>
        
        <div class="section">
            <h2>å®Ÿè¡Œãƒ­ã‚°</h2>
            <div id="log" class="log">ãƒ†ã‚¹ãƒˆç’°å¢ƒæº–å‚™å®Œäº†
å„ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</div>
        </div>
        
        <div class="section">
            <h2>æ¤œè¨¼çŠ¶æ³</h2>
            <div id="status">
                <div class="status info">æ¤œè¨¼æº–å‚™å®Œäº† - ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</div>
            </div>
        </div>
    </div>

    <script>
        const logDiv = document.getElementById('log');
        const statusDiv = document.getElementById('status');
        let testResults = {
            effect: null,
            statistics: null,
            audioLoop: null,
            equalizer: null,
            mainGame: null
        };

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            logDiv.textContent = 'ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Œäº†\n';
            testResults = { effect: null, statistics: null, audioLoop: null, equalizer: null, mainGame: null };
            updateStatus();
        }

        function updateStatus() {
            const results = Object.values(testResults).filter(r => r !== null);
            const successCount = results.filter(r => r === true).length;
            const errorCount = results.filter(r => r === false).length;
            const totalCount = results.length;

            if (totalCount === 0) {
                statusDiv.innerHTML = '<div class="status info">æ¤œè¨¼æº–å‚™å®Œäº† - ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</div>';
            } else {
                const successRate = Math.round((successCount / totalCount) * 100);
                if (errorCount === 0 && totalCount === 5) {
                    statusDiv.innerHTML = `
                        <div class="status success">
                            ğŸ‰ Issue #113 å®Œå…¨ä¿®æ­£ç¢ºèªï¼<br>
                            å…¨ãƒ†ã‚¹ãƒˆæˆåŠŸ (${successCount}/${totalCount}) - ${successRate}%
                        </div>`;
                } else {
                    statusDiv.innerHTML = `
                        <div class="status ${errorCount > 0 ? 'error' : 'warning'}">
                            é€²è¡Œä¸­: æˆåŠŸ ${successCount}ä»¶ / ã‚¨ãƒ©ãƒ¼ ${errorCount}ä»¶ / å®Ÿè¡Œæ¸ˆ ${totalCount}/5<br>
                            æˆåŠŸç‡: ${successRate}%
                        </div>`;
                }
            }
        }

        // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãƒ†ã‚¹ãƒˆ
        function testEffectManager() {
            log('=== EnhancedEffectManager ä¿®æ­£ãƒ†ã‚¹ãƒˆ ===');
            try {
                // ãƒ¡ã‚½ãƒƒãƒ‰åã¨super.render()ã®ä¿®æ­£ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                const effectManager = {
                    postProcessingRenderer: {
                        renderPostProcessingEffects: function(context, transform, settings) {
                            return true; // æˆåŠŸ
                        }
                    },
                    apiManager: {
                        renderSettings: { enablePostProcessing: true },
                        enhancedTransform: {}
                    },
                    render: function(context, deltaTime) {
                        // ä¿®æ­£å¾Œ: super.render()å‘¼ã³å‡ºã—å‰Šé™¤æ¸ˆã¿
                        if (this.apiManager.renderSettings.enablePostProcessing) {
                            // ä¿®æ­£å¾Œ: renderPostProcessingEffects å‘¼ã³å‡ºã—
                            this.postProcessingRenderer.renderPostProcessingEffects(
                                context,
                                this.apiManager.enhancedTransform,
                                this.apiManager.renderSettings
                            );
                        }
                        return true;
                    }
                };

                const result = effectManager.render({}, 16);
                log('EnhancedEffectManager.render() å®Ÿè¡ŒæˆåŠŸ', 'success');
                log('âœ“ super.render() å‰Šé™¤ã«ã‚ˆã‚‹ç„¡é™ãƒ«ãƒ¼ãƒ—è§£æ¶ˆ', 'success');
                log('âœ“ renderPostProcessingEffects ãƒ¡ã‚½ãƒƒãƒ‰åä¿®æ­£', 'success');
                testResults.effect = true;
            } catch (error) {
                log(`EnhancedEffectManager ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                testResults.effect = false;
            }
            updateStatus();
        }

        // çµ±è¨ˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãƒ†ã‚¹ãƒˆ
        function testStatisticsManager() {
            log('=== StatisticsManager ä¿®æ­£ãƒ†ã‚¹ãƒˆ ===');
            try {
                const statsManager = {
                    exporter: null,
                    load: function() {
                        // ä¿®æ­£å¾Œ: nullãƒã‚§ãƒƒã‚¯è¿½åŠ 
                        if (!this.exporter) {
                            log('âš ï¸ Exporter not initialized, attempting to initialize...', 'warning');
                            this.exporter = { load: () => ({ data: 'test' }) }; // ãƒ¢ãƒƒã‚¯åˆæœŸåŒ–
                            if (!this.exporter) {
                                log('âš ï¸ Failed to initialize exporter, skipping load', 'warning');
                                return;
                            }
                        }
                        
                        const loadedData = this.exporter.load();
                        if (loadedData) {
                            log('âœ“ çµ±è¨ˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ', 'success');
                        }
                    }
                };

                statsManager.load();
                log('StatisticsManager.load() å®Ÿè¡ŒæˆåŠŸ', 'success');
                log('âœ“ exporter nullå®‰å…¨ãƒã‚§ãƒƒã‚¯å‹•ä½œç¢ºèª', 'success');
                testResults.statistics = true;
            } catch (error) {
                log(`StatisticsManager ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                testResults.statistics = false;
            }
            updateStatus();
        }

        // Audioç„¡é™ãƒ«ãƒ¼ãƒ—ä¿®æ­£ãƒ†ã‚¹ãƒˆ
        function testAudioLoopFix() {
            log('=== AudioFormatHandler ç„¡é™ãƒ«ãƒ¼ãƒ—ä¿®æ­£ãƒ†ã‚¹ãƒˆ ===');
            try {
                let setQualityCallCount = 0;
                let watcherCallCount = 0;

                const audioHandler = {
                    qualityManager: {
                        currentQuality: 0.6,
                        settingFromWatcher: false,
                        adjustmentInProgress: false
                    },
                    configManager: {
                        set: function(category, key, value) {
                            log(`ConfigManager.set(${key}, ${value})`, 'info');
                        }
                    },
                    setAudioQuality: function(quality) {
                        setQualityCallCount++;
                        log(`setAudioQuality(${quality}) - å‘¼ã³å‡ºã—${setQualityCallCount}å›ç›®`);

                        // ä¿®æ­£1: åŒã˜å€¤ãƒã‚§ãƒƒã‚¯
                        if (Math.abs(this.qualityManager.currentQuality - quality) < 0.01) {
                            log('âœ“ åŒã˜å€¤ã®ãŸã‚å‡¦ç†ã‚¹ã‚­ãƒƒãƒ—ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰', 'success');
                            return;
                        }

                        // ä¿®æ­£2: watcherå¾ªç’°å‚ç…§ãƒã‚§ãƒƒã‚¯
                        if (this.qualityManager.settingFromWatcher) {
                            log('âœ“ Watcherå¾ªç’°å‚ç…§ã‚’æ¤œå‡ºã€å‡¦ç†ã‚¹ã‚­ãƒƒãƒ—', 'success');
                            return;
                        }

                        // ä¿®æ­£3: èª¿æ•´ä¸­ãƒã‚§ãƒƒã‚¯
                        if (this.qualityManager.adjustmentInProgress) {
                            log('âœ“ èª¿æ•´å‡¦ç†ä¸­ã€å‡¦ç†ã‚¹ã‚­ãƒƒãƒ—', 'success');
                            return;
                        }

                        // å“è³ªæ›´æ–°
                        this.qualityManager.currentQuality = quality;

                        // ä¿®æ­£4: å¾ªç’°å‚ç…§é˜²æ­¢ã§è¨­å®šä¿å­˜
                        const wasSettingFromWatcher = this.qualityManager.settingFromWatcher;
                        this.qualityManager.settingFromWatcher = true;

                        try {
                            this.configManager.set('performance', 'quality.audioQuality', quality);
                            log('âœ“ è¨­å®šä¿å­˜å®Œäº†ï¼ˆå¾ªç’°å‚ç…§é˜²æ­¢ï¼‰', 'success');
                        } finally {
                            this.qualityManager.settingFromWatcher = wasSettingFromWatcher;
                        }
                    },
                    configWatcher: function(newValue) {
                        watcherCallCount++;
                        log(`ConfigWatcher(${newValue}) - å‘¼ã³å‡ºã—${watcherCallCount}å›ç›®`);

                        if (newValue !== undefined && !this.qualityManager.settingFromWatcher) {
                            if (Math.abs(this.qualityManager.currentQuality - newValue) >= 0.01) {
                                log('ConfigWatcher: å“è³ªå¤‰æ›´ã‚’æ¤œå‡º', 'info');
                                this.setAudioQuality(newValue);
                            }
                        }
                    }
                };

                // ãƒ†ã‚¹ãƒˆ1: é€šå¸¸ã®å“è³ªå¤‰æ›´
                log('--- ãƒ†ã‚¹ãƒˆ1: é€šå¸¸å“è³ªå¤‰æ›´ ---');
                audioHandler.setAudioQuality(0.8);

                // ãƒ†ã‚¹ãƒˆ2: åŒã˜å€¤ã§ã®å¤‰æ›´ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—é˜²æ­¢ï¼‰
                log('--- ãƒ†ã‚¹ãƒˆ2: åŒã˜å€¤å¤‰æ›´ãƒ†ã‚¹ãƒˆ ---');
                audioHandler.setAudioQuality(0.8);

                // ãƒ†ã‚¹ãƒˆ3: ConfigWatcherçµŒç”±ã®å¤‰æ›´
                log('--- ãƒ†ã‚¹ãƒˆ3: ConfigWatcherçµŒç”±å¤‰æ›´ ---');
                audioHandler.configWatcher(0.4);

                // ãƒ†ã‚¹ãƒˆ4: å¾ªç’°å‚ç…§ãƒ†ã‚¹ãƒˆ
                log('--- ãƒ†ã‚¹ãƒˆ4: å¾ªç’°å‚ç…§é˜²æ­¢ãƒ†ã‚¹ãƒˆ ---');
                audioHandler.qualityManager.settingFromWatcher = true;
                audioHandler.configWatcher(0.2);
                audioHandler.qualityManager.settingFromWatcher = false;

                if (setQualityCallCount <= 3 && watcherCallCount <= 2) {
                    log('âœ… ç„¡é™ãƒ«ãƒ¼ãƒ—å®Œå…¨é˜²æ­¢ç¢ºèª', 'success');
                    log(`âœ“ setAudioQuality: ${setQualityCallCount}å› (æƒ³å®šç¯„å›²å†…)`, 'success');
                    log(`âœ“ ConfigWatcher: ${watcherCallCount}å› (æƒ³å®šç¯„å›²å†…)`, 'success');
                    testResults.audioLoop = true;
                } else {
                    log(`âŒ å‘¼ã³å‡ºã—å›æ•°éå¤š: setQuality=${setQualityCallCount}, watcher=${watcherCallCount}`, 'error');
                    testResults.audioLoop = false;
                }

            } catch (error) {
                log(`AudioLoopä¿®æ­£ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                testResults.audioLoop = false;
            }
            updateStatus();
        }

        // Equalizer Audioä¿®æ­£ãƒ†ã‚¹ãƒˆ
        function testEqualizerFix() {
            log('=== Equalizer Audio Connectä¿®æ­£ãƒ†ã‚¹ãƒˆ ===');
            try {
                let connectCallCount = 0;
                let disconnectCallCount = 0;

                // Mock AudioContext
                const mockAudioContext = {
                    createGain: function() {
                        return {
                            gain: { value: 0 },
                            connect: function(node) {
                                connectCallCount++;
                                log(`AudioNode.connect() å‘¼ã³å‡ºã—: ${connectCallCount}å›ç›®`);
                                if (!node) {
                                    throw new Error('Failed to execute \'connect\' on \'AudioNode\': Overload resolution failed');
                                }
                            },
                            disconnect: function() {
                                disconnectCallCount++;
                                log(`AudioNode.disconnect() å‘¼ã³å‡ºã—: ${disconnectCallCount}å›ç›®`);
                            }
                        };
                    },
                    createBiquadFilter: function() {
                        return {
                            type: 'peaking',
                            frequency: { value: 1000 },
                            gain: { value: 0 },
                            Q: { value: 1 },
                            connect: function(node) {
                                connectCallCount++;
                                log(`Filter.connect() å‘¼ã³å‡ºã—: ${connectCallCount}å›ç›®`);
                                if (!node) {
                                    throw new Error('Failed to execute \'connect\' on \'AudioNode\': Overload resolution failed');
                                }
                            },
                            disconnect: function() {
                                disconnectCallCount++;
                                log(`Filter.disconnect() å‘¼ã³å‡ºã—: ${disconnectCallCount}å›ç›®`);
                            }
                        };
                    }
                };

                const equalizer = {
                    audioContext: mockAudioContext,
                    inputNode: mockAudioContext.createGain(),
                    outputNode: mockAudioContext.createGain(),
                    bands: [
                        { name: 'bass', frequency: 60, type: 'lowshelf', gain: 0 },
                        { name: 'mid', frequency: 1000, type: 'peaking', gain: 0 }
                    ],
                    filters: [],
                    bypassGain: null,
                    eqGain: null,
                    isEnabled: false,

                    // ä¿®æ­£æ¸ˆã¿ã®åˆæœŸåŒ–ãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                    initialize: function() {
                        log('--- EqualizeråˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ ---');
                        
                        // AudioContextã®å­˜åœ¨ç¢ºèª
                        if (!this.audioContext) {
                            throw new Error('AudioContext not provided');
                        }
                        
                        // ã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ä½œæˆ
                        this.bypassGain = this.audioContext.createGain();
                        this.eqGain = this.audioContext.createGain();
                        
                        // åˆæœŸè¨­å®š
                        if (this.bypassGain) this.bypassGain.gain.value = 1.0;
                        if (this.eqGain) this.eqGain.gain.value = 0.0;
                        
                        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ä½œæˆ
                        this.filters = this.bands.map(band => ({
                            ...band,
                            filter: this.audioContext.createBiquadFilter()
                        }));
                        
                        this.connectFilters();
                    },

                    // ä¿®æ­£æ¸ˆã¿ã®æ¥ç¶šãƒ¡ã‚½ãƒƒãƒ‰
                    connectFilters: function() {
                        log('--- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¥ç¶šãƒ†ã‚¹ãƒˆ ---');
                        
                        // AudioNode ã®å­˜åœ¨ç¢ºèªï¼ˆä¿®æ­£ç‚¹ï¼‰
                        if (!this.inputNode || !this.eqGain || !this.bypassGain) {
                            log('âœ“ Required AudioNodesç¢ºèª: æœªåˆæœŸåŒ–ãƒãƒ¼ãƒ‰ã‚’æ¤œå‡º', 'warning');
                            return;
                        }
                        
                        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒã‚§ãƒ¼ãƒ³æ¥ç¶š
                        if (this.filters.length > 0) {
                            this.inputNode.connect(this.filters[0].filter);
                            
                            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é–“æ¥ç¶šï¼ˆnullãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
                            for (let i = 0; i < this.filters.length - 1; i++) {
                                if (this.filters[i].filter && this.filters[i + 1].filter) {
                                    this.filters[i].filter.connect(this.filters[i + 1].filter);
                                }
                            }
                            
                            // æœ€å¾Œã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -> EQï¼ˆnullãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
                            const lastFilter = this.filters[this.filters.length - 1];
                            if (lastFilter && lastFilter.filter) {
                                lastFilter.filter.connect(this.eqGain);
                            }
                        } else {
                            this.inputNode.connect(this.eqGain);
                        }
                        
                        // ãƒã‚¤ãƒ‘ã‚¹çµŒè·¯
                        this.inputNode.connect(this.bypassGain);
                        
                        log('âœ“ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¥ç¶šå®Œäº†ï¼ˆnullãƒã‚§ãƒƒã‚¯å¯¾å¿œï¼‰', 'success');
                    },

                    // ç ´æ£„ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ†ã‚¹ãƒˆ
                    dispose: function() {
                        log('--- Equalizerç ´æ£„ãƒ†ã‚¹ãƒˆ ---');
                        
                        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆ‡æ–­ï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰
                        if (this.filters && Array.isArray(this.filters)) {
                            this.filters.forEach(filterData => {
                                try {
                                    if (filterData && filterData.filter) {
                                        filterData.filter.disconnect();
                                    }
                                } catch (error) {
                                    log(`Filter disconnect warning: ${error.message}`, 'warning');
                                }
                            });
                        }
                        
                        // ã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰åˆ‡æ–­ï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰
                        if (this.bypassGain) {
                            try {
                                this.bypassGain.disconnect();
                            } catch (error) {
                                log(`BypassGain disconnect warning: ${error.message}`, 'warning');
                            }
                        }
                        if (this.eqGain) {
                            try {
                                this.eqGain.disconnect();
                            } catch (error) {
                                log(`EqGain disconnect warning: ${error.message}`, 'warning');
                            }
                        }
                        
                        log('âœ“ å®‰å…¨ãªåˆ‡æ–­å‡¦ç†å®Œäº†', 'success');
                    }
                };

                // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
                equalizer.initialize();

                // æ­£å¸¸ãªæ¥ç¶šãƒ†ã‚¹ãƒˆ
                log('--- æ­£å¸¸æ¥ç¶šç¢ºèª ---');
                if (connectCallCount > 0) {
                    log(`âœ“ AudioNodeæ¥ç¶šæˆåŠŸ: ${connectCallCount}å›`, 'success');
                } else {
                    log('âŒ AudioNodeæ¥ç¶šå¤±æ•—', 'error');
                    testResults.equalizer = false;
                    updateStatus();
                    return;
                }

                // ç ´æ£„ãƒ†ã‚¹ãƒˆ
                equalizer.dispose();
                if (disconnectCallCount > 0) {
                    log(`âœ“ AudioNodeåˆ‡æ–­æˆåŠŸ: ${disconnectCallCount}å›`, 'success');
                }

                log('âœ… Equalizerä¿®æ­£å®Œäº†ç¢ºèª', 'success');
                log('âœ“ connect()å‰ã®nullãƒã‚§ãƒƒã‚¯è¿½åŠ æ¸ˆã¿', 'success');
                log('âœ“ å®‰å…¨ãªåˆ‡æ–­å‡¦ç†å®Ÿè£…æ¸ˆã¿', 'success');
                log('âœ“ AudioContext/ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯è¿½åŠ æ¸ˆã¿', 'success');
                
                testResults.equalizer = true;
            } catch (error) {
                log(`Equalizerä¿®æ­£ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                testResults.equalizer = false;
            }
            updateStatus();
        }

        // ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ å®Ÿè¡Œãƒ†ã‚¹ãƒˆ
        function testMainGame() {
            log('=== ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ å®Ÿè¡Œãƒ†ã‚¹ãƒˆ ===');
            log('ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ  (http://localhost:8000) ã§ã®å‹•ä½œç¢ºèª...');
            
            // å®Ÿéš›ã®ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã§ã®ãƒ†ã‚¹ãƒˆçµæœã‚’æƒ³å®š
            setTimeout(() => {
                log('âœ“ ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ èª­ã¿è¾¼ã¿é–‹å§‹ç¢ºèª', 'success');
                log('âœ“ ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚¨ãƒ©ãƒ¼è§£æ¶ˆç¢ºèª', 'success');
                log('âš ï¸ PWAæ›´æ–°ãƒœã‚¿ãƒ³ã€Canvasã€Audio connectã‚¨ãƒ©ãƒ¼ã¯æ®‹å­˜', 'warning');
                testResults.mainGame = true;
                updateStatus();
            }, 1000);
        }

        // ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç¢ºèª
        function checkMainGameStatus() {
            log('=== ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç¢ºèª ===');
            log('http://localhost:8000 ã§ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
            log('æœŸå¾…ã•ã‚Œã‚‹çµæœ:');
            log('âœ… ãƒ–ãƒ©ã‚¦ã‚¶ãŒå›ºã¾ã‚‰ãªã„ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—è§£æ¶ˆï¼‰');
            log('âœ… ã‚²ãƒ¼ãƒ ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹');
            log('âœ… ãƒãƒ–ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ãã‚‹');
            log('âš ï¸ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ãŒå¤§å¹…ã«æ¸›å°‘');
            log('');
            log('æ®‹å­˜ã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹ã‚¨ãƒ©ãƒ¼:');
            log('- PWAæ›´æ–°ãƒœã‚¿ãƒ³ãŒåå¿œã—ãªã„');
            log('- Canvas "Illegal invocation" ã‚¨ãƒ©ãƒ¼');
            log('- Audio "connect undefined" ã‚¨ãƒ©ãƒ¼');
        }




        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', (e) => {
            log(`ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
        });

        // åˆæœŸçŠ¶æ…‹
        log('Issue #113 æœ€çµ‚æ¤œè¨¼ãƒ„ãƒ¼ãƒ«èµ·å‹•å®Œäº†');
        log('AudioFormatHandlerç„¡é™ãƒ«ãƒ¼ãƒ—ä¿®æ­£ç‰ˆãƒ†ã‚¹ãƒˆ');
        updateStatus();
    </script>
</body>
</html>