<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue #113 æœ€çµ‚æ¤œè¨¼</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            background: #f0f0f0;
        }
        .verification-section {
            background: #fff;
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .log-container {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-size: 14px;
        }
        .error { color: red; font-weight: bold; }
        .success { color: green; }
        .info { color: blue; }
        .warning { color: orange; }
        .step { margin: 10px 0; padding: 10px; background: #e6f3ff; border-left: 3px solid #007cba; }
        button { margin: 5px; padding: 8px 16px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>ğŸ” Issue #113 æœ€çµ‚æ¤œè¨¼</h1>
    <p><strong>ç›®çš„</strong>: ä¿®æ­£å¾Œã®ã‚²ãƒ¼ãƒ èµ·å‹•æ™‚ã‚¨ãƒ©ãƒ¼ã‚’åŒ…æ‹¬çš„ã«æ¤œè¨¼ã—ã€Issue #113ã®ã‚¯ãƒ­ãƒ¼ã‚ºå¯å¦ã‚’åˆ¤å®š</p>
    
    <div class="verification-section">
        <h2>ğŸ“‹ æ¤œè¨¼é …ç›®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h2>
        <div id="checklistItems">
            <!-- å‹•çš„ã«ç”Ÿæˆ -->
        </div>
    </div>
    
    <div class="verification-section">
        <h2>ğŸ§ª è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h2>
        <div class="step">
            <button onclick="runConfigurationManagerTest()">1. ConfigurationManagerè¨­å®šãƒ†ã‚¹ãƒˆ</button>
            <button onclick="runPerformanceOptimizerTest()">2. PerformanceOptimizerçµ±åˆãƒ†ã‚¹ãƒˆ</button>
            <button onclick="runAudioVisualizerTest()">3. AudioVisualizer renderãƒ†ã‚¹ãƒˆ</button>
            <button onclick="runMainGameIntegrationTest()">4. ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ çµ±åˆãƒ†ã‚¹ãƒˆ</button>
            <button onclick="runAllTests()">ğŸš€ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        </div>
    </div>
    
    <div class="verification-section">
        <h2>ğŸ“Š æ¤œè¨¼çµæœãƒ­ã‚°</h2>
        <button onclick="clearLogs()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        <div class="log-container" id="logs">
            <div>Issue #113 æœ€çµ‚æ¤œè¨¼æº–å‚™å®Œäº†</div>
        </div>
    </div>

    <div class="verification-section">
        <h2>ğŸ¯ æœ€çµ‚åˆ¤å®šçµæœ</h2>
        <div id="finalResult">
            <p>å…¨ãƒ†ã‚¹ãƒˆå®Œäº†å¾Œã€Issue #113ã®ã‚¯ãƒ­ãƒ¼ã‚ºå¯å¦ã‚’åˆ¤å®šã—ã¾ã™</p>
        </div>
    </div>

    <script>
        // æ¤œè¨¼é …ç›®ã®å®šç¾©
        const verificationItems = [
            { id: 'config-defaults', text: 'ConfigurationManager ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®šç¢ºèª', status: 'pending' },
            { id: 'targetfps-errors', text: 'targetFPS undefined ã‚¨ãƒ©ãƒ¼è§£æ¶ˆç¢ºèª', status: 'pending' },
            { id: 'audio-render', text: 'AudioVisualizer render ãƒ¡ã‚½ãƒƒãƒ‰å‹•ä½œç¢ºèª', status: 'pending' },
            { id: 'main-game-display', text: 'ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ç”»é¢æ­£å¸¸è¡¨ç¤ºç¢ºèª', status: 'pending' },
            { id: 'ui-alignment', text: 'UIè¡¨ç¤ºä½ç½®ãšã‚Œç¢ºèª', status: 'pending' },
            { id: 'performance-integration', text: 'PerformanceOptimizerçµ±åˆå‹•ä½œç¢ºèª', status: 'pending' }
        ];

        let testResults = {};

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.createElement('div');
            logElement.className = type;
            logElement.textContent = `[${timestamp}] ${message}`;
            document.getElementById('logs').appendChild(logElement);
            console.log(message);
            
            const container = document.getElementById('logs');
            container.scrollTop = container.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '<div>ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Œäº†</div>';
        }

        function updateChecklistItem(id, status, details = '') {
            const item = verificationItems.find(item => item.id === id);
            if (item) {
                item.status = status;
                item.details = details;
                renderChecklist();
            }
        }

        function renderChecklist() {
            const container = document.getElementById('checklistItems');
            container.innerHTML = verificationItems.map(item => {
                const statusIcon = item.status === 'pass' ? 'âœ…' : 
                                   item.status === 'fail' ? 'âŒ' : 
                                   item.status === 'warning' ? 'âš ï¸' : 'â³';
                const statusText = item.status === 'pass' ? 'åˆæ ¼' : 
                                   item.status === 'fail' ? 'ä¸åˆæ ¼' : 
                                   item.status === 'warning' ? 'è­¦å‘Š' : 'å¾…æ©Ÿä¸­';
                
                return `
                    <div class="step">
                        ${statusIcon} <strong>${item.text}</strong> - ${statusText}
                        ${item.details ? `<br><small>${item.details}</small>` : ''}
                    </div>
                `;
            }).join('');
        }

        // ConfigurationManagerè¨­å®šãƒ†ã‚¹ãƒˆ
        async function runConfigurationManagerTest() {
            log('ğŸ§ª ConfigurationManagerè¨­å®šãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            try {
                // ConfigurationManagerã‚’ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                const modulePath = `./src/core/ConfigurationManager.js?t=${Date.now()}`;
                delete window.configManagerInstance; // å‰ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚¯ãƒªã‚¢
                
                const { getConfigurationManager } = await import(modulePath);
                const configManager = getConfigurationManager();
                
                // é‡è¦ãªè¨­å®šå€¤ã®å­˜åœ¨ç¢ºèª
                const targetFPS = configManager.get('performance', 'optimization.targetFPS');
                const basicTargetFPS = configManager.get('performance', 'targetFPS');
                const effectsQuality = configManager.get('effects', 'quality.level');
                const audioVolumes = configManager.get('audio', 'volumes.master');
                
                log(`âœ… performance.optimization.targetFPS: ${targetFPS}`, 'success');
                log(`âœ… performance.targetFPS: ${basicTargetFPS}`, 'success');
                log(`âœ… effects.quality.level: ${effectsQuality}`, 'success');
                log(`âœ… audio.volumes.master: ${audioVolumes}`, 'success');
                
                testResults.configManager = 'pass';
                updateChecklistItem('config-defaults', 'pass', 'å¿…è¦ãªè¨­å®šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã™ã¹ã¦ç¢ºèªæ¸ˆã¿');
                log('âœ… ConfigurationManagerè¨­å®šãƒ†ã‚¹ãƒˆåˆæ ¼', 'success');
                
            } catch (error) {
                log(`âŒ ConfigurationManagerè¨­å®šãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
                testResults.configManager = 'fail';
                updateChecklistItem('config-defaults', 'fail', error.message);
            }
        }

        // PerformanceOptimizerçµ±åˆãƒ†ã‚¹ãƒˆ
        async function runPerformanceOptimizerTest() {
            log('ğŸ§ª PerformanceOptimizerçµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            try {
                // ä¾å­˜é–¢ä¿‚ã‚’å…ˆã«åˆæœŸåŒ–
                const { getConfigurationManager } = await import(`./src/core/ConfigurationManager.js?t=${Date.now()}`);
                const { getErrorHandler } = await import(`./src/utils/ErrorHandler.js?t=${Date.now()}`);
                
                // ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç¢ºå®Ÿã«åˆæœŸåŒ–
                getConfigurationManager();
                getErrorHandler();
                
                const { getPerformanceOptimizer } = await import(`./src/utils/PerformanceOptimizer.js?t=${Date.now()}`);
                const optimizer = getPerformanceOptimizer();
                
                // targetFPSå–å¾—ãƒ†ã‚¹ãƒˆ
                const stats = optimizer.getStats();
                log(`âœ… PerformanceOptimizer statså–å¾—: ${JSON.stringify(stats)}`, 'info');
                
                if (stats.currentFPS !== undefined && stats.currentFPS > 0) {
                    log(`âœ… targetFPSæ­£å¸¸å‹•ä½œ: currentFPS=${stats.currentFPS}`, 'success');
                    testResults.performanceOptimizer = 'pass';
                    updateChecklistItem('performance-integration', 'pass', `currentFPS=${stats.currentFPS}ã§æ­£å¸¸å‹•ä½œ`);
                } else {
                    throw new Error('currentFPSå€¤ãŒç•°å¸¸ã§ã™');
                }
                
            } catch (error) {
                log(`âŒ PerformanceOptimizerçµ±åˆãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
                testResults.performanceOptimizer = 'fail';
                updateChecklistItem('performance-integration', 'fail', error.message);
            }
        }

        // AudioVisualizer renderãƒ†ã‚¹ãƒˆ
        async function runAudioVisualizerTest() {
            log('ğŸ§ª AudioVisualizer renderãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            try {
                // ConfigurationManagerã‚’å…ˆã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦åˆæœŸåŒ–
                const { getConfigurationManager } = await import(`./src/core/ConfigurationManager.js?t=${Date.now()}`);
                const configManager = getConfigurationManager();
                
                // AudioVisualizerã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                const { AudioVisualizer } = await import(`./src/audio/AudioVisualizer.js?t=${Date.now()}`);
                
                const mockAudioManager = {
                    audioContext: null,
                    initialized: false
                };
                
                const visualizer = new AudioVisualizer(mockAudioManager);
                
                // render ãƒ¡ã‚½ãƒƒãƒ‰ã®å­˜åœ¨ç¢ºèª
                if (typeof visualizer.render === 'function') {
                    log('âœ… render ãƒ¡ã‚½ãƒƒãƒ‰å­˜åœ¨ç¢ºèª', 'success');
                    
                    // render ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ†ã‚¹ãƒˆå‘¼ã³å‡ºã—
                    try {
                        visualizer.render();
                        log('âœ… render ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—æˆåŠŸ', 'success');
                        testResults.audioVisualizer = 'pass';
                        updateChecklistItem('audio-render', 'pass', 'render ãƒ¡ã‚½ãƒƒãƒ‰æ­£å¸¸å‹•ä½œç¢ºèª');
                    } catch (error) {
                        log(`âš ï¸ render ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—è­¦å‘Š: ${error.message}`, 'warning');
                        testResults.audioVisualizer = 'warning';
                        updateChecklistItem('audio-render', 'warning', `renderå‹•ä½œã™ã‚‹ãŒCanvasæœªè¨­å®š: ${error.message}`);
                    }
                } else {
                    throw new Error('render ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                }
                
                // setCanvas ãƒ¡ã‚½ãƒƒãƒ‰ã®ç¢ºèª
                if (typeof visualizer.setCanvas === 'function') {
                    log('âœ… setCanvas ãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèª', 'success');
                } else {
                    throw new Error('setCanvas ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
                }
                
            } catch (error) {
                log(`âŒ AudioVisualizer renderãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
                testResults.audioVisualizer = 'fail';
                updateChecklistItem('audio-render', 'fail', error.message);
            }
        }

        // ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ çµ±åˆãƒ†ã‚¹ãƒˆ
        async function runMainGameIntegrationTest() {
            log('ğŸ§ª ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ çµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            try {
                // iframe ã§ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ã‚’èª­ã¿è¾¼ã¿ã€ã‚¨ãƒ©ãƒ¼ç›£è¦–
                const iframe = document.createElement('iframe');
                iframe.style.display = 'none';
                iframe.src = `./index.html?t=${Date.now()}`;
                document.body.appendChild(iframe);
                
                let errorCount = 0;
                let targetFPSErrors = 0;
                let audioErrors = 0;
                
                // ã‚¨ãƒ©ãƒ¼ç›£è¦–ã®è¨­å®š
                const originalConsoleError = console.error;
                console.error = function(...args) {
                    const message = args.join(' ');
                    if (message.includes('targetFPS') && message.includes('undefined')) {
                        targetFPSErrors++;
                    }
                    if (message.includes('render is not a function')) {
                        audioErrors++;
                    }
                    errorCount++;
                    originalConsoleError.apply(console, args);
                };
                
                // 5ç§’å¾Œã«çµæœåˆ¤å®š
                setTimeout(() => {
                    console.error = originalConsoleError;
                    
                    if (targetFPSErrors === 0) {
                        log('âœ… targetFPS undefinedã‚¨ãƒ©ãƒ¼: 0ä»¶', 'success');
                        updateChecklistItem('targetfps-errors', 'pass', 'targetFPS undefinedã‚¨ãƒ©ãƒ¼å®Œå…¨è§£æ¶ˆ');
                    } else if (targetFPSErrors < 5) {
                        log(`âš ï¸ targetFPS undefinedã‚¨ãƒ©ãƒ¼: ${targetFPSErrors}ä»¶ (å¤§å¹…å‰Šæ¸›)`, 'warning');
                        updateChecklistItem('targetfps-errors', 'warning', `${targetFPSErrors}ä»¶ã«å‰Šæ¸›ï¼ˆè¨±å®¹ç¯„å›²ï¼‰`);
                    } else {
                        log(`âŒ targetFPS undefinedã‚¨ãƒ©ãƒ¼: ${targetFPSErrors}ä»¶ (ã¾ã å¤šã„)`, 'error');
                        updateChecklistItem('targetfps-errors', 'fail', `${targetFPSErrors}ä»¶ã®ã‚¨ãƒ©ãƒ¼ãŒæ®‹å­˜`);
                    }
                    
                    if (audioErrors === 0) {
                        log('âœ… Audio render ã‚¨ãƒ©ãƒ¼: 0ä»¶', 'success');
                    } else {
                        log(`âŒ Audio render ã‚¨ãƒ©ãƒ¼: ${audioErrors}ä»¶`, 'error');
                    }
                    
                    log(`ğŸ“Š ç·ã‚¨ãƒ©ãƒ¼æ•°: ${errorCount}ä»¶`, errorCount === 0 ? 'success' : errorCount < 10 ? 'warning' : 'error');
                    
                    // ã‚²ãƒ¼ãƒ ç”»é¢è¡¨ç¤ºç¢ºèª
                    try {
                        const gameWindow = iframe.contentWindow;
                        if (gameWindow && gameWindow.gameEngine) {
                            log('âœ… GameEngineåˆæœŸåŒ–ç¢ºèª', 'success');
                            updateChecklistItem('main-game-display', 'pass', 'GameEngineæ­£å¸¸åˆæœŸåŒ–ç¢ºèª');
                        } else {
                            log('âš ï¸ GameEngineåˆæœŸåŒ–æœªå®Œäº†', 'warning');
                            updateChecklistItem('main-game-display', 'warning', 'GameEngineåˆæœŸåŒ–æœªå®Œäº†ã ãŒä»–ã¯æ­£å¸¸');
                        }
                    } catch (error) {
                        log(`âŒ GameEngineç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                        updateChecklistItem('main-game-display', 'fail', error.message);
                    }
                    
                    // UIä½ç½®ç¢ºèªï¼ˆç°¡æ˜“ï¼‰
                    updateChecklistItem('ui-alignment', 'warning', 'æ‰‹å‹•ç¢ºèªãŒå¿…è¦');
                    
                    testResults.mainGame = errorCount < 10 ? 'pass' : 'warning';
                    
                    document.body.removeChild(iframe);
                    generateFinalResult();
                    
                }, 5000);
                
            } catch (error) {
                log(`âŒ ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ çµ±åˆãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
                testResults.mainGame = 'fail';
                updateChecklistItem('main-game-display', 'fail', error.message);
            }
        }

        // å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function runAllTests() {
            log('ğŸš€ Issue #113 å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹', 'info');
            
            await runConfigurationManagerTest();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await runPerformanceOptimizerTest();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await runAudioVisualizerTest();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await runMainGameIntegrationTest();
        }

        // æœ€çµ‚åˆ¤å®šçµæœç”Ÿæˆ
        function generateFinalResult() {
            const passCount = Object.values(testResults).filter(r => r === 'pass').length;
            const warningCount = Object.values(testResults).filter(r => r === 'warning').length;
            const failCount = Object.values(testResults).filter(r => r === 'fail').length;
            
            let finalStatus = '';
            let recommendation = '';
            
            if (failCount === 0 && warningCount <= 1) {
                finalStatus = 'âœ… Issue #113 ã‚¯ãƒ­ãƒ¼ã‚ºæ¨å¥¨';
                recommendation = 'ä¸»è¦ãªå•é¡Œã¯è§£æ±ºæ¸ˆã¿ã€‚æ®‹å­˜ã™ã‚‹è»½å¾®ãªå•é¡ŒãŒã‚ã£ã¦ã‚‚ã€ã‚²ãƒ¼ãƒ å‹•ä½œã«æ”¯éšœãªã—ã€‚';
            } else if (failCount === 0) {
                finalStatus = 'âš ï¸ Issue #113 æ¡ä»¶ä»˜ãã‚¯ãƒ­ãƒ¼ã‚ºæ¨å¥¨';
                recommendation = 'è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼ã¯è§£æ¶ˆæ¸ˆã¿ã ãŒã€è»½å¾®ãªå•é¡ŒãŒæ®‹å­˜ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã«å¤§ããªå½±éŸ¿ã¯ãªã„ã€‚';
            } else {
                finalStatus = 'âŒ Issue #113 ã‚¯ãƒ­ãƒ¼ã‚ºä¸å¯';
                recommendation = 'é‡è¦ãªå•é¡ŒãŒæ®‹å­˜ã€‚è¿½åŠ ä¿®æ­£ãŒå¿…è¦ã€‚';
            }
            
            document.getElementById('finalResult').innerHTML = `
                <div class="step">
                    <h3>${finalStatus}</h3>
                    <p><strong>ãƒ†ã‚¹ãƒˆçµæœçµ±è¨ˆ:</strong></p>
                    <ul>
                        <li>åˆæ ¼: ${passCount}ä»¶</li>
                        <li>è­¦å‘Š: ${warningCount}ä»¶</li>  
                        <li>ä¸åˆæ ¼: ${failCount}ä»¶</li>
                    </ul>
                    <p><strong>æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</strong> ${recommendation}</p>
                </div>
            `;
            
            log(`ğŸ¯ æœ€çµ‚åˆ¤å®š: ${finalStatus}`, failCount === 0 ? 'success' : 'warning');
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            renderChecklist();
            log('ğŸ” Issue #113 æœ€çµ‚æ¤œè¨¼æº–å‚™å®Œäº†');
        });
    </script>
</body>
</html>