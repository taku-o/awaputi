<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚·ãƒ³ãƒ—ãƒ«GameEngineãƒ†ã‚¹ãƒˆ - Issue #113</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        #testContainer {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        
        #log {
            margin-top: 20px;
            background: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-info { color: #0066cc; }
        .log-error { color: #cc0000; font-weight: bold; }
        .log-success { color: #006600; }
        .log-warning { color: #cc6600; }
    </style>
</head>
<body>
    <div id="testContainer">
        <h1>ğŸ® ã‚·ãƒ³ãƒ—ãƒ«GameEngineãƒ†ã‚¹ãƒˆ</h1>
        <p>GameEngineã‚’å®‰å…¨ã«åˆæœŸåŒ–ã—ã¦ã‚²ãƒ¼ãƒ ã‚’å‹•ã‹ã—ã¾ã™</p>
        
        <canvas id="gameCanvas" width="800" height="600" style="border: 2px solid #333; background: #e8f4f8;"></canvas>
        
        <div>
            <button onclick="safeGameEngineTest()">å®‰å…¨GameEngineèµ·å‹•</button>
            <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        </div>
        
        <div id="log"></div>
    </div>

    <script type="module">
        let gameEngine = null;
        
        // ===== ãƒ­ã‚°æ©Ÿèƒ½ =====
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const div = document.createElement('div');
            div.className = `log-${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logElement.appendChild(div);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        };
        
        window.safeGameEngineTest = async function() {
            log('=== å®‰å…¨GameEngineãƒ†ã‚¹ãƒˆé–‹å§‹ ===', 'info');
            
            try {
                // Step 1: å¿…è¦ãªä¾å­˜é–¢ä¿‚ã‚’äº‹å‰ã«ç¢ºèª
                log('Step 1: ä¾å­˜é–¢ä¿‚ã‚’äº‹å‰ç¢ºèª', 'info');
                
                // ConfigurationManagerã‚’å…ˆã«åˆæœŸåŒ–
                log('ConfigurationManagerã‚’äº‹å‰åˆæœŸåŒ–...', 'info');
                const { getConfigurationManager } = await import('./src/core/ConfigurationManager.js');
                const configManager = getConfigurationManager();
                if (!configManager) {
                    throw new Error('ConfigurationManageråˆæœŸåŒ–å¤±æ•—');
                }
                log('âœ… ConfigurationManageräº‹å‰åˆæœŸåŒ–æˆåŠŸ', 'success');
                
                // ErrorHandlerã‚’äº‹å‰åˆæœŸåŒ–
                log('ErrorHandlerã‚’äº‹å‰åˆæœŸåŒ–...', 'info');
                const { getErrorHandler } = await import('./src/utils/ErrorHandler.js');
                const errorHandler = getErrorHandler();
                if (!errorHandler) {
                    throw new Error('ErrorHandleråˆæœŸåŒ–å¤±æ•—');
                }
                log('âœ… ErrorHandleräº‹å‰åˆæœŸåŒ–æˆåŠŸ', 'success');
                
                // Step 2: GameEngineã‚’å®‰å…¨ã«ä½œæˆ
                log('Step 2: GameEngineã‚¯ãƒ©ã‚¹ã‚¤ãƒ³ãƒãƒ¼ãƒˆ', 'info');
                const { GameEngine } = await import('./src/core/GameEngine.js');
                
                log('Step 3: Canvasè¦ç´ ç¢ºèª', 'info');
                const canvas = document.getElementById('gameCanvas');
                if (!canvas) {
                    throw new Error('Canvasè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                log('Step 4: GameEngineä½œæˆä¸­ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰', 'info');
                
                try {
                    // ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒã—ã¦GameEngineã‚’ä½œæˆï¼ˆinitializeãƒ¡ã‚½ãƒƒãƒ‰ã¯å­˜åœ¨ã—ãªã„ãŸã‚ã€ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã§å…¨ã¦åˆæœŸåŒ–ã•ã‚Œã‚‹ï¼‰
                    gameEngine = new GameEngine(canvas);
                    log('âœ… GameEngineä½œæˆæˆåŠŸ', 'success');
                    
                    // ä½œæˆã•ã‚ŒãŸã‚²ãƒ¼ãƒ ã‚¨ãƒ³ã‚¸ãƒ³ã®çŠ¶æ…‹ç¢ºèª
                    log('=== GameEngineçŠ¶æ…‹ç¢ºèª ===', 'info');
                    log(`isRunning: ${gameEngine.isRunning}`, 'info');
                    log(`canvas: ${gameEngine.canvas ? 'OK' : 'NG'}`, 'info');
                    log(`context: ${gameEngine.context ? 'OK' : 'NG'}`, 'info');
                    
                    // ä¸»è¦ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®å­˜åœ¨ç¢ºèª
                    log('=== ä¸»è¦ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ç¢ºèª ===', 'info');
                    log(`bubbleManager: ${gameEngine.bubbleManager ? 'OK' : 'NG'}`, gameEngine.bubbleManager ? 'success' : 'warning');
                    log(`stageManager: ${gameEngine.stageManager ? 'OK' : 'NG'}`, gameEngine.stageManager ? 'success' : 'warning');
                    log(`sceneManager: ${gameEngine.sceneManager ? 'OK' : 'NG'}`, gameEngine.sceneManager ? 'success' : 'warning');
                    log(`scoreManager: ${gameEngine.scoreManager ? 'OK' : 'NG'}`, gameEngine.scoreManager ? 'success' : 'warning');
                    
                    // Step 5: åŸºæœ¬ã‚²ãƒ¼ãƒ æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆï¼ˆGameEngineãŒæ­£å¸¸ä½œæˆã•ã‚ŒãŸå ´åˆï¼‰
                    await testBasicGameFunctionality();
                    
                } catch (constructorError) {
                    log(`âŒ GameEngineã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ¼ã‚¨ãƒ©ãƒ¼: ${constructorError.message}`, 'error');
                    log(`ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯: ${constructorError.stack}`, 'error');
                    
                    // æœ€å°é™ã®æ©Ÿèƒ½ã§ã‚²ãƒ¼ãƒ ã‚’ä½œã‚Šç›´ã™
                    await createMinimalGameEngine(canvas);
                }
                
            } catch (overallError) {
                log(`âŒ å…¨ä½“ã‚¨ãƒ©ãƒ¼: ${overallError.message}`, 'error');
                log(`ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯: ${overallError.stack}`, 'error');
            }
        };
        
        async function testBasicGameFunctionality() {
            log('=== åŸºæœ¬ã‚²ãƒ¼ãƒ æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ ===', 'info');
            
            try {
                // ã‚¹ãƒ†ãƒ¼ã‚¸è¨­å®šãƒ†ã‚¹ãƒˆ
                if (gameEngine.stageManager) {
                    log('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ†ãƒ¼ã‚¸è¨­å®šãƒ†ã‚¹ãƒˆ...', 'info');
                    const stageResult = gameEngine.stageManager.startStage('normal');
                    if (stageResult) {
                        log('âœ… ã‚¹ãƒ†ãƒ¼ã‚¸è¨­å®šæˆåŠŸ', 'success');
                    } else {
                        log('âš ï¸ ã‚¹ãƒ†ãƒ¼ã‚¸è¨­å®šå¤±æ•—', 'warning');
                    }
                }
                
                // ãƒãƒ–ãƒ«ç”Ÿæˆãƒ†ã‚¹ãƒˆ
                if (gameEngine.bubbleManager) {
                    log('ãƒãƒ–ãƒ«ç”Ÿæˆãƒ†ã‚¹ãƒˆ...', 'info');
                    const bubble = gameEngine.bubbleManager.spawnBubble('normal');
                    if (bubble) {
                        log('âœ… ãƒãƒ–ãƒ«ç”ŸæˆæˆåŠŸ', 'success');
                        const bubbleCount = gameEngine.bubbleManager.getBubbleCount();
                        log(`ç¾åœ¨ã®ãƒãƒ–ãƒ«æ•°: ${bubbleCount}`, 'info');
                    } else {
                        log('âš ï¸ ãƒãƒ–ãƒ«ç”Ÿæˆå¤±æ•—', 'warning');
                    }
                }
                
                // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ãƒ†ã‚¹ãƒˆ
                log('ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—é–‹å§‹ãƒ†ã‚¹ãƒˆ...', 'info');
                if (typeof gameEngine.start === 'function') {
                    gameEngine.start();
                    log('âœ… ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—é–‹å§‹æˆåŠŸ', 'success');
                    
                    // 3ç§’å¾Œã«çŠ¶æ…‹ç¢ºèª
                    setTimeout(() => {
                        log(`ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—çŠ¶æ…‹: ${gameEngine.isRunning ? 'å‹•ä½œä¸­' : 'åœæ­¢ä¸­'}`, 'info');
                        if (gameEngine.bubbleManager) {
                            const bubbleCount = gameEngine.bubbleManager.getBubbleCount();
                            log(`3ç§’å¾Œã®ãƒãƒ–ãƒ«æ•°: ${bubbleCount}`, 'info');
                        }
                    }, 3000);
                } else {
                    log('âš ï¸ startãƒ¡ã‚½ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                }
                
            } catch (testError) {
                log(`âŒ åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${testError.message}`, 'error');
            }
        }
        
        async function createMinimalGameEngine(canvas) {
            log('=== æœ€å°é™GameEngineä½œæˆ ===', 'warning');
            
            try {
                log('å¿…è¦æœ€å°é™ã®ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ç°¡æ˜“GameEngineä½œæˆ...', 'info');
                
                // æœ€å°é™ã®GameEngineã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
                const minimalGameEngine = {
                    canvas: canvas,
                    context: canvas.getContext('2d'),
                    isRunning: false,
                    bubbles: [],
                    score: 0,
                    
                    // æœ€å°é™ã®ãƒãƒ–ãƒ«ç”Ÿæˆæ©Ÿèƒ½
                    spawnBubble: function(x, y) {
                        x = x || 50 + Math.random() * (canvas.width - 100);
                        y = y || 50 + Math.random() * (canvas.height - 100);
                        
                        const bubble = {
                            x: x,
                            y: y,
                            radius: 20 + Math.random() * 20,
                            color: `hsl(${Math.random() * 360}, 70%, 60%)`,
                            vx: (Math.random() - 0.5) * 2,
                            vy: (Math.random() - 0.5) * 2,
                            life: 255
                        };
                        
                        this.bubbles.push(bubble);
                        log(`ãƒãƒ–ãƒ«ç”Ÿæˆ: (${Math.round(x)}, ${Math.round(y)})`, 'success');
                        return bubble;
                    },
                    
                    // æç”»æ©Ÿèƒ½
                    render: function() {
                        const ctx = this.context;
                        ctx.fillStyle = '#e8f4f8';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        this.bubbles.forEach(bubble => {
                            ctx.fillStyle = bubble.color;
                            ctx.beginPath();
                            ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                            ctx.fill();
                        });
                        
                        // ã‚¹ã‚³ã‚¢è¡¨ç¤º
                        ctx.fillStyle = '#333';
                        ctx.font = '20px Arial';
                        ctx.fillText(`Score: ${this.score}`, 10, 30);
                        ctx.fillText(`Bubbles: ${this.bubbles.length}`, 10, 60);
                    },
                    
                    // ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
                    handleClick: function(x, y) {
                        for (let i = this.bubbles.length - 1; i >= 0; i--) {
                            const bubble = this.bubbles[i];
                            const dx = x - bubble.x;
                            const dy = y - bubble.y;
                            
                            if (dx * dx + dy * dy <= bubble.radius * bubble.radius) {
                                this.bubbles.splice(i, 1);
                                this.score += 10;
                                log(`ãƒãƒ–ãƒ«ç ´å£Š! ã‚¹ã‚³ã‚¢: ${this.score}`, 'success');
                                return true;
                            }
                        }
                        return false;
                    },
                    
                    // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
                    start: function() {
                        if (this.isRunning) return;
                        this.isRunning = true;
                        
                        // åˆæœŸãƒãƒ–ãƒ«ç”Ÿæˆ
                        for (let i = 0; i < 3; i++) {
                            this.spawnBubble();
                        }
                        
                        const gameLoop = () => {
                            if (!this.isRunning) return;
                            
                            this.render();
                            
                            // è‡ªå‹•ãƒãƒ–ãƒ«ç”Ÿæˆ
                            if (Math.random() < 0.01) {
                                this.spawnBubble();
                            }
                            
                            requestAnimationFrame(gameLoop);
                        };
                        
                        gameLoop();
                        log('âœ… æœ€å°é™ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—é–‹å§‹', 'success');
                    }
                };
                
                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ 
                canvas.addEventListener('click', (event) => {
                    const rect = canvas.getBoundingClientRect();
                    const x = event.clientX - rect.left;
                    const y = event.clientY - rect.top;
                    
                    minimalGameEngine.handleClick(x, y);
                });
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¨­å®š
                window.minimalGameEngine = minimalGameEngine;
                
                // ã‚²ãƒ¼ãƒ é–‹å§‹
                minimalGameEngine.start();
                log('âœ… æœ€å°é™GameEngineä½œæˆãƒ»èµ·å‹•å®Œäº†', 'success');
                log('Canvasã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒãƒ–ãƒ«ã‚’å‰²ã£ã¦ãã ã•ã„ï¼', 'info');
                
            } catch (minimalError) {
                log(`âŒ æœ€å°é™GameEngineä½œæˆå¤±æ•—: ${minimalError.message}`, 'error');
            }
        }
        
        // ===== åˆæœŸåŒ– =====
        log('ã‚·ãƒ³ãƒ—ãƒ«GameEngineãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«æº–å‚™å®Œäº†', 'info');
        log('ã€Œå®‰å…¨GameEngineèµ·å‹•ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„', 'info');
    </script>
</body>
</html>