<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>シンプルGameEngineテスト - Issue #113</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f0f0f0;
        }
        
        #testContainer {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        
        #log {
            margin-top: 20px;
            background: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-info { color: #0066cc; }
        .log-error { color: #cc0000; font-weight: bold; }
        .log-success { color: #006600; }
        .log-warning { color: #cc6600; }
    </style>
</head>
<body>
    <div id="testContainer">
        <h1>🎮 シンプルGameEngineテスト</h1>
        <p>GameEngineを安全に初期化してゲームを動かします</p>
        
        <canvas id="gameCanvas" width="800" height="600" style="border: 2px solid #333; background: #e8f4f8;"></canvas>
        
        <div>
            <button onclick="safeGameEngineTest()">安全GameEngine起動</button>
            <button onclick="clearLog()">ログクリア</button>
        </div>
        
        <div id="log"></div>
    </div>

    <script type="module">
        let gameEngine = null;
        
        // ===== ログ機能 =====
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const div = document.createElement('div');
            div.className = `log-${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logElement.appendChild(div);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        };
        
        window.safeGameEngineTest = async function() {
            log('=== 安全GameEngineテスト開始 ===', 'info');
            
            try {
                // Step 1: 必要な依存関係を事前に確認
                log('Step 1: 依存関係を事前確認', 'info');
                
                // ConfigurationManagerを先に初期化
                log('ConfigurationManagerを事前初期化...', 'info');
                const { getConfigurationManager } = await import('./src/core/ConfigurationManager.js');
                const configManager = getConfigurationManager();
                if (!configManager) {
                    throw new Error('ConfigurationManager初期化失敗');
                }
                log('✅ ConfigurationManager事前初期化成功', 'success');
                
                // ErrorHandlerを事前初期化
                log('ErrorHandlerを事前初期化...', 'info');
                const { getErrorHandler } = await import('./src/utils/ErrorHandler.js');
                const errorHandler = getErrorHandler();
                if (!errorHandler) {
                    throw new Error('ErrorHandler初期化失敗');
                }
                log('✅ ErrorHandler事前初期化成功', 'success');
                
                // Step 2: GameEngineを安全に作成
                log('Step 2: GameEngineクラスインポート', 'info');
                const { GameEngine } = await import('./src/core/GameEngine.js');
                
                log('Step 3: Canvas要素確認', 'info');
                const canvas = document.getElementById('gameCanvas');
                if (!canvas) {
                    throw new Error('Canvas要素が見つかりません');
                }
                
                log('Step 4: GameEngine作成中（エラーハンドリング付き）', 'info');
                
                try {
                    // エラーをキャッチしてGameEngineを作成（initializeメソッドは存在しないため、コンストラクターで全て初期化される）
                    gameEngine = new GameEngine(canvas);
                    log('✅ GameEngine作成成功', 'success');
                    
                    // 作成されたゲームエンジンの状態確認
                    log('=== GameEngine状態確認 ===', 'info');
                    log(`isRunning: ${gameEngine.isRunning}`, 'info');
                    log(`canvas: ${gameEngine.canvas ? 'OK' : 'NG'}`, 'info');
                    log(`context: ${gameEngine.context ? 'OK' : 'NG'}`, 'info');
                    
                    // 主要マネージャーの存在確認
                    log('=== 主要マネージャー確認 ===', 'info');
                    log(`bubbleManager: ${gameEngine.bubbleManager ? 'OK' : 'NG'}`, gameEngine.bubbleManager ? 'success' : 'warning');
                    log(`stageManager: ${gameEngine.stageManager ? 'OK' : 'NG'}`, gameEngine.stageManager ? 'success' : 'warning');
                    log(`sceneManager: ${gameEngine.sceneManager ? 'OK' : 'NG'}`, gameEngine.sceneManager ? 'success' : 'warning');
                    log(`scoreManager: ${gameEngine.scoreManager ? 'OK' : 'NG'}`, gameEngine.scoreManager ? 'success' : 'warning');
                    
                    // Step 5: 基本ゲーム機能テスト（GameEngineが正常作成された場合）
                    await testBasicGameFunctionality();
                    
                } catch (constructorError) {
                    log(`❌ GameEngineコンストラクターエラー: ${constructorError.message}`, 'error');
                    log(`エラースタック: ${constructorError.stack}`, 'error');
                    
                    // 最小限の機能でゲームを作り直す
                    await createMinimalGameEngine(canvas);
                }
                
            } catch (overallError) {
                log(`❌ 全体エラー: ${overallError.message}`, 'error');
                log(`エラースタック: ${overallError.stack}`, 'error');
            }
        };
        
        async function testBasicGameFunctionality() {
            log('=== 基本ゲーム機能テスト ===', 'info');
            
            try {
                // ステージ設定テスト
                if (gameEngine.stageManager) {
                    log('デフォルトステージ設定テスト...', 'info');
                    const stageResult = gameEngine.stageManager.startStage('normal');
                    if (stageResult) {
                        log('✅ ステージ設定成功', 'success');
                    } else {
                        log('⚠️ ステージ設定失敗', 'warning');
                    }
                }
                
                // バブル生成テスト
                if (gameEngine.bubbleManager) {
                    log('バブル生成テスト...', 'info');
                    const bubble = gameEngine.bubbleManager.spawnBubble('normal');
                    if (bubble) {
                        log('✅ バブル生成成功', 'success');
                        const bubbleCount = gameEngine.bubbleManager.getBubbleCount();
                        log(`現在のバブル数: ${bubbleCount}`, 'info');
                    } else {
                        log('⚠️ バブル生成失敗', 'warning');
                    }
                }
                
                // ゲームループテスト
                log('ゲームループ開始テスト...', 'info');
                if (typeof gameEngine.start === 'function') {
                    gameEngine.start();
                    log('✅ ゲームループ開始成功', 'success');
                    
                    // 3秒後に状態確認
                    setTimeout(() => {
                        log(`ゲームループ状態: ${gameEngine.isRunning ? '動作中' : '停止中'}`, 'info');
                        if (gameEngine.bubbleManager) {
                            const bubbleCount = gameEngine.bubbleManager.getBubbleCount();
                            log(`3秒後のバブル数: ${bubbleCount}`, 'info');
                        }
                    }, 3000);
                } else {
                    log('⚠️ startメソッドが見つかりません', 'warning');
                }
                
            } catch (testError) {
                log(`❌ 基本機能テストエラー: ${testError.message}`, 'error');
            }
        }
        
        async function createMinimalGameEngine(canvas) {
            log('=== 最小限GameEngine作成 ===', 'warning');
            
            try {
                log('必要最小限のマネージャーで簡易GameEngine作成...', 'info');
                
                // 最小限のGameEngineオブジェクトを作成
                const minimalGameEngine = {
                    canvas: canvas,
                    context: canvas.getContext('2d'),
                    isRunning: false,
                    bubbles: [],
                    score: 0,
                    
                    // 最小限のバブル生成機能
                    spawnBubble: function(x, y) {
                        x = x || 50 + Math.random() * (canvas.width - 100);
                        y = y || 50 + Math.random() * (canvas.height - 100);
                        
                        const bubble = {
                            x: x,
                            y: y,
                            radius: 20 + Math.random() * 20,
                            color: `hsl(${Math.random() * 360}, 70%, 60%)`,
                            vx: (Math.random() - 0.5) * 2,
                            vy: (Math.random() - 0.5) * 2,
                            life: 255
                        };
                        
                        this.bubbles.push(bubble);
                        log(`バブル生成: (${Math.round(x)}, ${Math.round(y)})`, 'success');
                        return bubble;
                    },
                    
                    // 描画機能
                    render: function() {
                        const ctx = this.context;
                        ctx.fillStyle = '#e8f4f8';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        this.bubbles.forEach(bubble => {
                            ctx.fillStyle = bubble.color;
                            ctx.beginPath();
                            ctx.arc(bubble.x, bubble.y, bubble.radius, 0, Math.PI * 2);
                            ctx.fill();
                        });
                        
                        // スコア表示
                        ctx.fillStyle = '#333';
                        ctx.font = '20px Arial';
                        ctx.fillText(`Score: ${this.score}`, 10, 30);
                        ctx.fillText(`Bubbles: ${this.bubbles.length}`, 10, 60);
                    },
                    
                    // クリック処理
                    handleClick: function(x, y) {
                        for (let i = this.bubbles.length - 1; i >= 0; i--) {
                            const bubble = this.bubbles[i];
                            const dx = x - bubble.x;
                            const dy = y - bubble.y;
                            
                            if (dx * dx + dy * dy <= bubble.radius * bubble.radius) {
                                this.bubbles.splice(i, 1);
                                this.score += 10;
                                log(`バブル破壊! スコア: ${this.score}`, 'success');
                                return true;
                            }
                        }
                        return false;
                    },
                    
                    // ゲームループ
                    start: function() {
                        if (this.isRunning) return;
                        this.isRunning = true;
                        
                        // 初期バブル生成
                        for (let i = 0; i < 3; i++) {
                            this.spawnBubble();
                        }
                        
                        const gameLoop = () => {
                            if (!this.isRunning) return;
                            
                            this.render();
                            
                            // 自動バブル生成
                            if (Math.random() < 0.01) {
                                this.spawnBubble();
                            }
                            
                            requestAnimationFrame(gameLoop);
                        };
                        
                        gameLoop();
                        log('✅ 最小限ゲームループ開始', 'success');
                    }
                };
                
                // クリックイベント追加
                canvas.addEventListener('click', (event) => {
                    const rect = canvas.getBoundingClientRect();
                    const x = event.clientX - rect.left;
                    const y = event.clientY - rect.top;
                    
                    minimalGameEngine.handleClick(x, y);
                });
                
                // グローバルに設定
                window.minimalGameEngine = minimalGameEngine;
                
                // ゲーム開始
                minimalGameEngine.start();
                log('✅ 最小限GameEngine作成・起動完了', 'success');
                log('Canvasをクリックしてバブルを割ってください！', 'info');
                
            } catch (minimalError) {
                log(`❌ 最小限GameEngine作成失敗: ${minimalError.message}`, 'error');
            }
        }
        
        // ===== 初期化 =====
        log('シンプルGameEngineテストツール準備完了', 'info');
        log('「安全GameEngine起動」ボタンをクリックしてください', 'info');
    </script>
</body>
</html>