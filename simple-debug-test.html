<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>シンプルデバッグテスト - Issue #113</title>
    <style>
        body {
            margin: 20px;
            font-family: monospace;
            background: #f0f0f0;
        }
        
        #container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background: #007bff;
            color: white;
        }
        
        #log {
            margin-top: 20px;
            background: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        
        .log-info { color: #0066cc; }
        .log-error { color: #cc0000; font-weight: bold; }
        .log-success { color: #006600; }
        .log-warning { color: #cc6600; }
    </style>
</head>
<body>
    <div id="container">
        <h1>🔍 シンプルデバッグテスト</h1>
        <p>GameEngineの読み込み・作成をステップ別にテスト</p>
        
        <canvas id="gameCanvas" width="400" height="300" style="border: 2px solid #333; background: #e8f4f8;"></canvas>
        
        <div>
            <button onclick="testStep1()">Step 1: 基本機能確認</button>
            <button onclick="testStep2()">Step 2: GameEngineファイル読み込み</button>
            <button onclick="testStep2a()">Step 2a: 依存関係個別チェック</button>
            <button onclick="testStep3()">Step 3: GameEngineクラス作成</button>
            <button onclick="testStep4()">Step 4: ログフィルター確認</button>
            <button onclick="testStep5()">Step 5: 直接ログテスト</button>
        </div>
        
        <div id="log"></div>
    </div>

    <script type="module">
        let testGameEngine = null;
        
        // ===== ログ機能 =====
        function log(message, type = 'info') {
            const logElement = document.getElementById('log');
            const div = document.createElement('div');
            div.className = `log-${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logElement.appendChild(div);
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // ===== テスト関数 =====
        window.testStep1 = function() {
            log('=== Step 1: 基本機能確認 ===', 'info');
            
            // コンソールログ出力テスト
            console.log('TEST: 通常のconsole.log');
            console.log('[DEBUG] DEBUGフィルター付きconsole.log');
            console.log('EARLY_DEBUG: EARLY_DEBUGフィルター付きconsole.log');
            console.log('VERY_EARLY_DEBUG: VERY_EARLY_DEBUGフィルター付きconsole.log');
            
            log('✅ コンソールログテスト完了 - コンソールを確認してください', 'success');
            
            // Canvas確認
            const canvas = document.getElementById('gameCanvas');
            if (canvas && canvas.getContext('2d')) {
                log('✅ Canvas要素利用可能', 'success');
            } else {
                log('❌ Canvas要素エラー', 'error');
            }
        };
        
        window.testStep2 = async function() {
            log('=== Step 2: GameEngineファイル読み込み ===', 'info');
            
            try {
                log('GameEngine.jsファイルのインポートを開始...', 'info');
                console.log('IMPORT_TEST: GameEngine.jsインポート開始');
                
                // より詳細なエラーキャッチング
                let gameEngineModule;
                try {
                    gameEngineModule = await import('./src/core/GameEngine.js');
                } catch (importError) {
                    log(`❌ GameEngine.js直接インポートエラー: ${importError.message}`, 'error');
                    log(`エラー詳細: ${importError.stack}`, 'error');
                    console.error('DETAILED_IMPORT_ERROR:', importError);
                    
                    // より具体的なエラー解析
                    if (importError.message.includes('Failed to resolve')) {
                        log('ファイルパスの問題の可能性があります', 'warning');
                    } else if (importError.message.includes('Unexpected token')) {
                        log('JavaScript構文エラーの可能性があります', 'warning');
                    } else if (importError.message.includes('Cannot resolve module')) {
                        log('依存関係の問題の可能性があります', 'warning');
                    }
                    
                    throw importError;
                }
                
                console.log('IMPORT_TEST: GameEngine.jsインポート成功');
                log('✅ GameEngine.jsファイルの読み込み成功', 'success');
                
                if (gameEngineModule.GameEngine) {
                    log('✅ GameEngineクラスを確認', 'success');
                    console.log('IMPORT_TEST: GameEngineクラス確認完了');
                } else {
                    log('❌ GameEngineクラスが見つかりません', 'error');
                }
                
                // コンソールでVERY_EARLY_DEBUGログを確認
                log('コンソールで "VERY_EARLY_DEBUG: GameEngine.js ファイル読み込み開始" を確認してください', 'info');
                
                // コンソールログ履歴を確認
                log('=== コンソールログ確認 ===', 'info');
                
                // ブラウザのconsole履歴確認のため、テストログを出力
                setTimeout(() => {
                    log('ブラウザコンソールでVERY_EARLY_DEBUGが見つからない場合の原因:', 'warning');
                    log('1. ES Moduleの静的解析段階でのエラー', 'info');
                    log('2. import文でのエラー（catch済み）', 'info');  
                    log('3. ブラウザのログレベルフィルタリング', 'info');
                    log('4. console.logが実行される前のエラー', 'info');
                }, 500);
                
            } catch (error) {
                log(`❌ GameEngine.js読み込みエラー: ${error.message}`, 'error');
                log(`エラータイプ: ${error.name}`, 'error');
                log(`エラースタック: ${error.stack}`, 'error');
                console.error('IMPORT_ERROR:', error);
            }
        };
        
        window.testStep2a = async function() {
            log('=== Step 2a: 依存関係個別チェック ===', 'info');
            
            // GameEngine.jsの主要な依存関係を個別にテスト
            const dependencies = [
                './src/core/PlayerData.js',
                './src/managers/BubbleManager.js', 
                './src/managers/ScoreManager.js',
                './src/core/StageManager.js',
                './src/core/SceneManager.js',
                './src/core/ConfigurationManager.js',
                './src/utils/ErrorHandler.js',
                './src/core/game-engine/GameEngineInitializer.js'
            ];
            
            log(`${dependencies.length}個の主要依存関係をチェックします...`, 'info');
            
            let successCount = 0;
            let errorCount = 0;
            
            for (const dep of dependencies) {
                try {
                    log(`チェック中: ${dep}`, 'info');
                    await import(dep);
                    log(`✅ ${dep} - OK`, 'success');
                    successCount++;
                } catch (error) {
                    log(`❌ ${dep} - エラー: ${error.message}`, 'error');
                    console.error(`DEPENDENCY_ERROR (${dep}):`, error);
                    errorCount++;
                }
            }
            
            log('=== 依存関係チェック結果 ===', 'info');
            log(`成功: ${successCount}/${dependencies.length}`, successCount === dependencies.length ? 'success' : 'warning');
            log(`失敗: ${errorCount}/${dependencies.length}`, errorCount === 0 ? 'success' : 'error');
            
            if (errorCount === 0) {
                log('✅ 全ての主要依存関係が正常です', 'success');
            } else {
                log(`⚠️ ${errorCount}個の依存関係でエラーが発生しました`, 'warning');
                log('これがGameEngine.js読み込み失敗の原因の可能性があります', 'info');
            }
        };
        
        window.testStep3 = async function() {
            log('=== Step 3: GameEngineクラス作成 ===', 'info');
            
            try {
                const canvas = document.getElementById('gameCanvas');
                const { GameEngine } = await import('./src/core/GameEngine.js');
                
                log('GameEngineコンストラクター呼び出し開始...', 'info');
                console.log('CONSTRUCTOR_TEST: GameEngineコンストラクター開始');
                
                // エラーキャッチ用のリスナー
                const originalError = console.error;
                const errors = [];
                console.error = function(...args) {
                    errors.push(args.join(' '));
                    originalError.apply(console, args);
                };
                
                try {
                    testGameEngine = new GameEngine(canvas);
                    
                    console.log('CONSTRUCTOR_TEST: GameEngineコンストラクター完了');
                    log('✅ GameEngine作成成功', 'success');
                    
                    // 基本プロパティ確認
                    log(`GameEngine.canvas: ${!!testGameEngine.canvas}`, 'info');
                    log(`GameEngine.context: ${!!testGameEngine.context}`, 'info');
                    log(`GameEngine.bubbleManager: ${!!testGameEngine.bubbleManager}`, 'info');
                    
                } catch (constructorError) {
                    console.log('CONSTRUCTOR_TEST: GameEngineコンストラクターエラー');
                    log(`❌ GameEngine作成エラー: ${constructorError.message}`, 'error');
                    
                    if (errors.length > 0) {
                        log('キャッチしたエラー:', 'warning');
                        errors.forEach(error => log(`  - ${error}`, 'warning'));
                    }
                } finally {
                    console.error = originalError;
                }
                
                // コンソールでDEBUGログを確認
                log('コンソールで "[DEBUG] GameEngine:" で始まるログを確認してください', 'info');
                
            } catch (error) {
                log(`❌ 全体エラー: ${error.message}`, 'error');
            }
        };
        
        window.testStep4 = function() {
            log('=== Step 4: ログフィルター確認 ===', 'info');
            
            // 各種ログレベルのテスト
            console.log('NORMAL: 通常ログ');
            console.info('INFO: 情報ログ');
            console.warn('WARN: 警告ログ');
            console.error('ERROR: エラーログ');
            console.debug('DEBUG_LEVEL: デバッグレベルログ');
            
            // フィルター付きログ
            console.log('[DEBUG] フィルター付きDEBUGログ');
            console.log('EARLY_DEBUG: フィルター付きEARLY_DEBUGログ');
            console.log('VERY_EARLY_DEBUG: フィルター付きVERY_EARLY_DEBUGログ');
            
            log('✅ 各種ログレベルテスト完了', 'success');
            log('ブラウザコンソールのフィルター設定を確認してください:', 'info');
            log('- Chrome: コンソールタブの右上の設定アイコン', 'info');
            log('- 「ログレベル」で表示項目を調整可能', 'info');
        };
        
        window.testStep5 = async function() {
            log('=== Step 5: 直接ログテスト ===', 'info');
            
            // GameEngine.jsファイルを直接読み込んで、console.logが実行されるかテスト
            try {
                log('直接的なログテストを実行中...', 'info');
                
                // 一時的にconsole.logをフックして確認
                const originalConsoleLog = console.log;
                const capturedLogs = [];
                
                console.log = function(...args) {
                    const message = args.join(' ');
                    capturedLogs.push(message);
                    originalConsoleLog.apply(console, args);
                };
                
                // GameEngine.jsを再度インポート（キャッシュされるが、ログキャプチャのため）
                log('GameEngine.jsを再インポートしてログをキャプチャ...', 'info');
                
                // 新しいスクリプトタグで直接読み込む方法をテスト
                const script = document.createElement('script');
                script.type = 'module';
                script.textContent = `
                    console.log('DIRECT_TEST: モジュール内から直接ログ');
                    import('./src/core/GameEngine.js').then(() => {
                        console.log('DIRECT_TEST: GameEngine.jsインポート完了後');
                    }).catch(error => {
                        console.error('DIRECT_TEST: GameEngine.jsインポートエラー', error);
                    });
                `;
                
                document.head.appendChild(script);
                
                setTimeout(() => {
                    console.log = originalConsoleLog;
                    
                    log('=== キャプチャしたログ ===', 'info');
                    if (capturedLogs.length > 0) {
                        capturedLogs.forEach(capturedLog => {
                            if (capturedLog.includes('VERY_EARLY_DEBUG') || capturedLog.includes('DEBUG') || capturedLog.includes('DIRECT_TEST')) {
                                log(`キャッチ: ${capturedLog}`, 'success');
                            }
                        });
                    } else {
                        log('ログがキャプチャされませんでした', 'warning');
                    }
                    
                    // スクリプトタグを削除
                    document.head.removeChild(script);
                }, 1000);
                
            } catch (error) {
                log(`❌ 直接ログテストエラー: ${error.message}`, 'error');
            }
        };
        
        // ===== 初期化 =====
        log('シンプルデバッグテスト準備完了', 'info');
        log('Step 1から順番に実行してください', 'info');
    </script>
</body>
</html>